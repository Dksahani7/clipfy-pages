<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Clipfy Player</title>
<meta name="description" content="Watch videos on Clipfy Player">
<script src="https://imasdk.googleapis.com/js/sdkloader/ima3.js"></script>
<script async src="https://a.magsrv.com/ad-provider.js"></script>
<script async src="https://a.pemsrv.com/ad-provider.js"></script>



<style>
:root{
  --bg:#0f141a;
  --card:#12182e;
  --text:#fff;
  --muted:#8b93b0;
  --accent:#ff2f5b;
  --hover:#1a2139;
}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Arial,sans-serif;line-height:1.6;overflow-x:hidden}

/* Header */
header{position:sticky;top:0;z-index:1000;background:rgba(15,20,26,.95);backdrop-filter:blur(12px);border-bottom:1px solid rgba(255,255,255,.05);box-shadow:0 4px 20px rgba(0,0,0,.3)}
.nav{max-width:1200px;margin:auto;padding:10px 20px;display:flex;align-items:center;justify-content:space-between}
.logo{font-weight:900;font-size:22px;display:flex;align-items:center;gap:8px;text-decoration:none;color:inherit}
.logo span{color:var(--accent)}

/* Video Box */
.video-container {
    z-index: 900;
    background: #000;
    width: 100%;
}
.video-box{
    position: relative;
    width:100%;
    aspect-ratio: 16/9;
    max-height: 60vh;
    background:#000;
}
.video-box video{width:100%;height:100%;border:0;object-fit:contain}
#adContainer{position:absolute;top:0;left:0;width:100%;height:100%;z-index:1000;display:none;background:#000;pointer-events:auto !important}
#adContainer.active{display:block;pointer-events:auto}

/* Content */
.content-wrapper{max-width:1200px;margin:auto;padding:0 20px; position: relative; z-index: 100;}

/* AD Containers */
.ad-728-player{margin:20px auto;text-align:center;max-width:728px;min-height:90px}
.ad-300-player{margin:20px auto;text-align:center;width:300px;height:250px;justify-self:center;display:grid;place-items:center}
.ad-native-player{margin:30px auto;width:100%;max-width:1200px}

.post{padding:14px 0;display:flex;gap:10px;border-bottom:1px solid rgba(255,255,255,.05)}
.dp{width:42px;height:42px;border-radius:50%;background:var(--card);background-size:cover;background-position:center}
#creatorName{font-weight:600}
#timeAgo{font-size:12px;color:var(--muted)}
.stats{display:flex;gap:20px;padding:14px 0;border-bottom:1px solid rgba(255,255,255,.05);font-size:14px;color:var(--muted)}
.blog-content{padding:14px 0}
#mainTitle{font-size:22px;font-weight:700;margin-bottom:10px}
.suggestions-header{padding:20px 0 10px 0;font-size:20px;font-weight:700;color:var(--text)}
#suggestions{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:20px;padding-bottom:20px}
.suggestion-item{background:var(--card);border-radius:12px;overflow:hidden;cursor:pointer;transition:.3s}
.suggestion-item:hover{transform:translateY(-4px);box-shadow:0 8px 20px rgba(255,47,91,.2)}
.suggestion-thumbnail{width:100%;aspect-ratio:16/9;overflow:hidden}
.suggestion-thumbnail img{width:100%;height:100%;object-fit:cover}
.suggestion-title{padding:10px 12px;font-size:15px;line-height:1.4;font-weight:600}

.ad-item {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    border: 1px solid rgba(255, 47, 91, 0.3) !important;
    position: relative;
}

.ad-item::before {
    content: "Sponsored";
    position: absolute;
    top: 8px;
    left: 8px;
    background: rgba(255, 47, 91, 0.9);
    color: #fff;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: 700;
    z-index: 10;
}

.ad-item ins {
    display: block;
    min-height: 180px;
}

.ad-item .ad-close-btn {
    position: absolute;
    top: 6px;
    right: 6px;
    width: 20px;
    height: 20px;
    background: rgba(0,0,0,.6);
    color: #fff;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    font-size: 12px;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    opacity: 0.7;
    transition: opacity 0.3s;
}

.ad-item .ad-close-btn:hover {
    opacity: 1;
    background: rgba(255, 47, 91, 0.8);
}

/* Interstitial Ad Close Button */
.interstitial-close-btn {
    position: fixed;
    top: 20px;
    right: 20px;
    width: 50px;
    height: 50px;
    background: rgba(255, 47, 91, 0.9);
    color: #fff;
    border: 3px solid #fff;
    border-radius: 50%;
    cursor: pointer;
    font-size: 24px;
    font-weight: bold;
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    opacity: 0;
    transform: scale(0.8);
    transition: all 0.3s ease;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}

.interstitial-close-btn.show {
    opacity: 1;
    transform: scale(1);
}

.interstitial-close-btn:hover {
    background: #ff2f5b;
    transform: scale(1.1);
    box-shadow: 0 6px 25px rgba(0,0,0,0.4);
}

.interstitial-close-btn:active {
    transform: scale(0.95);
}

/* Interstitial Overlay */
.interstitial-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.9); /* Kaala parda */
    z-index: 99999; /* Sabse upar */
    display: none;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
}

.interstitial-overlay.active {
    display: flex !important;
    opacity: 1;
    pointer-events: auto;
    align-items: center;
    justify-content: center;
}

.interstitial-ad-container {
    position: relative;
    max-width: 90vw;
    max-height: 90vh;
    background: #000;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 10px 40px rgba(0,0,0,0.5);
}

/* Footer */
footer{background:var(--card);border-top:1px solid rgba(255,255,255,.05);padding:40px 20px;margin-top:40px; position: relative; z-index: 1000;}



@media(max-width:768px){
    .ad-728-player{display:none}
    .ad-300-player{width:100%;max-width:300px}
}
</style>
</head>

<body>

<header>
  <nav class="nav">
    <a href="/" class="logo">â–¶ <span>clipfy.store</span></a>
  </nav>
</header>

<div class="video-container">
    <div class="video-box">
        <div id="adContainer"></div>
        <video id="player" controls muted preload="metadata" controlsList="nodownload"></video>
    </div>
</div>

<!-- Social Bar (placed directly below video to increase CTR) -->
<div id="socialBar" style="max-width:1200px;margin:10px auto;text-align:center;">
    <div style="display:inline-flex;gap:8px;align-items:center;">
        <a href="#" onclick="window.open('https://t.me/+626MQDOX5iAxMmJh')" style="background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px;text-decoration:none;font-weight:700">Join Telegram</a>
        <a href="#" onclick="navigator.share && navigator.share({title:document.title,url:location.href})" style="background:#222;color:#fff;padding:8px 12px;border-radius:8px;text-decoration:none;font-weight:700">Share</a>
    </div>
</div>

<!-- Ad Slot -->
<div class="ad-728-player">
    <ins class="eas6a97888e42" data-zoneid="5832056"></ins>
    <script>(window.AdProvider = window.AdProvider || []).push({"serve": {}});</script>
</div>







<div class="content-wrapper">
    <div class="blog-content">
        <h2 id="mainTitle"></h2>
    </div>
    
    <div class="post">
        <div class="dp" id="creatorDp"></div>
        <div>
            <div id="creatorName"></div>
            <div id="timeAgo"></div>
        </div>
    </div>

    <div class="stats">
        <div><span id="views">0</span> views</div>
        <div><span id="likes">0</span> likes</div>
        <div style="margin-left:auto">
            <button id="reportBtn" style="padding:8px 14px;background:#ef4444;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;transition:all .2s" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">ðŸš© Report Video</button>
        </div>
    </div>

    <div class="suggestions-header">More Videos ðŸ”¥</div>
    <div id="suggestions"></div>
    <div style="text-align:center;margin:20px 0;">
        <button id="loadMoreBtn" style="background:var(--accent);color:#fff;padding:12px 24px;border:none;border-radius:8px;cursor:pointer;font-weight:700;display:none;">Load More Videos</button>
    </div>

    <!-- Recommendation Widget -->
    <div style="margin-top: 40px; padding: 30px 0; border-top: 1px solid rgba(255,255,255,.05);">
        <ins class="eas6a97888e20" data-zoneid="5829434"></ins>
        <script>(window.AdProvider = window.AdProvider || []).push({"serve": {}});</script>
    </div>

</div>

<footer>
  <div class="footer-content">
      <div class="footer-section"><h4>About Clipfy</h4><ul><li><a href="#">About Us</a></li></ul></div>
      <div class="footer-section"><h4>Legal</h4><ul><li><a href="#">Privacy Policy</a></li></ul></div>
  </div>
  <div class="footer-bottom">Â© 2024 Clipfy.store. All rights reserved.</div>
</footer>



<script>
// ---- CONFIG ----
const DATA_URL = "https://pub-a3ad4cec48664940879fc5dd37a07293.r2.dev/index.json";
const R2_STREAM_BASE = "https://pub-a3ad4cec48664940879fc5dd37a07293.r2.dev/";

// Aapke saare Ad Zones ka array
const AD_ZONES = [
  "5825550", "5829428", "5830146", "5825492", "5825490"
];

const player = document.getElementById("player");
const adContainer = document.getElementById("adContainer");
const mainTitle = document.getElementById("mainTitle");
const creatorNameEl = document.getElementById("creatorName");
const timeAgoEl = document.getElementById("timeAgo");
const viewsEl = document.getElementById("views");
const likesEl = document.getElementById("likes");
const creatorDp = document.getElementById("creatorDp");
const suggestions = document.getElementById("suggestions");

const adConfigs = [
    { class: 'eas6a97888e37', zoneid: '5829556' },
    { class: 'eas6a97888e38', zoneid: '5829557' },
    { class: 'eas6a97888e39', zoneid: '5829558' }
];

let videos = {};
let currentVideoId = null;
let allSuggestionIds = [];
let suggestionsLoaded = 0;
let isInitialLoad = true;

let adsLoader, adsManager, adDisplayContainer;
let currentZoneIndex = 0;
let adSlots = [];
let retryInterval = null;
let isAdPlaying = false;
let hasUserInteracted = false;
let initialized = false;

function initIMA() {
  if (adDisplayContainer) return;
  adDisplayContainer = new google.ima.AdDisplayContainer(adContainer, player);
  adsLoader = new google.ima.AdsLoader(adDisplayContainer);

  adsLoader.addEventListener(google.ima.AdsManagerLoadedEvent.Type.ADS_MANAGER_LOADED, (e) => {
    adsManager = e.getAdsManager(player);

    adsManager.addEventListener(google.ima.AdEvent.Type.CONTENT_PAUSE_REQUESTED, () => {
      isAdPlaying = true;
      adContainer.classList.add('active');
      player.pause();
    });

    adsManager.addEventListener(google.ima.AdEvent.Type.CONTENT_RESUME_REQUESTED, () => {
      resetAdSystem();
    });

    adsManager.addEventListener(google.ima.AdErrorEvent.Type.AD_ERROR, (e) => {
      console.log("IMA Ad Error:", e.getError());
      document.getElementById('adContainer').style.display = 'none'; // Force hide
      player.play(); // Resume video
      tryNextZone();
    });

    // ðŸ”¥ AD CLICK PE AUTO-RESUME
    adsManager.addEventListener(google.ima.AdEvent.Type.CLICK, () => {
      setTimeout(() => {
        if (adsManager && isAdPlaying) {
          adsManager.resume();
        }
      }, 100);
    });

    adsManager.init(player.clientWidth, player.clientHeight, google.ima.ViewMode.NORMAL);
    adsManager.start();
  });

  adsLoader.addEventListener(google.ima.AdErrorEvent.Type.AD_ERROR, () => tryNextZone());
}

function resetAdSystem() {
  isAdPlaying = false;
  adContainer.classList.remove('active');
  player.play();
  clearInterval(retryInterval);
  currentZoneIndex = 0; // Agle slot ke liye shuruat se check karein
}

// Waterfall Logic: Ek zone fail toh dusra try karo
function tryNextZone() {
  currentZoneIndex++;
  if (currentZoneIndex < AD_ZONES.length) {
    console.log("Switching to Ad Zone: " + AD_ZONES[currentZoneIndex]);
    requestAd();
  } else {
    console.log("All zones empty. Waiting for next retry cycle...");
    clearInterval(retryInterval);
    isAdPlaying = false;
    adContainer.classList.remove('active');
    player.play();
  }
}

function requestAd() {
  if (typeof google === 'undefined') return;
  const req = new google.ima.AdsRequest();
  // Dynamic Zone Selection
  const zoneId = AD_ZONES[currentZoneIndex];
  console.log(`ðŸŽ¯ REQUESTING AD: Zone ${currentZoneIndex + 1}/${AD_ZONES.length} - ID: ${zoneId}`);
  req.adTagUrl = `https://s.magsrv.com/v1/vast.php?idzone=${zoneId}&cb=${Date.now()}`;
  adsLoader.requestAds(req);
}

// SMART TRIGGER LOGIC
player.onloadedmetadata = () => {
  const dur = player.duration;
  adSlots = []; // Purane slots clear karein

  if (dur <= 300) {
    // 5 min se kam: 10% par aur khatam hone se 10s pehle
    adSlots.push(Math.floor(dur * 0.1));
    adSlots.push(Math.floor(dur - 10));
  }
  else if (dur > 300 && dur <= 600) {
    // 5 se 10 min: 50%, aur 90%
    adSlots.push(Math.floor(dur * 0.5), Math.floor(dur * 0.9));
  }
  else {
    // 10 min se badi: 30%, 60%, aur 90%
    adSlots.push(Math.floor(dur * 0.3), Math.floor(dur * 0.6), Math.floor(dur * 0.9));
  }
};

player.ontimeupdate = () => {
  if (isAdPlaying) return;
  let cur = Math.floor(player.currentTime);
  
  if (adSlots.includes(cur)) {
    adSlots = adSlots.filter(s => s !== cur);
    startAdCycle();
  }
};

function startAdCycle() {
  if (AD_ZONES.length === 0) return;
  currentZoneIndex = 0;
  requestAd();

  // Retry loop: Har 45s mein phir koshish karein agar ad nahi mila
  clearInterval(retryInterval);
  retryInterval = setInterval(() => {
    if (!isAdPlaying) {
      // Continue from current zone, don't reset to 0
      if (currentZoneIndex >= AD_ZONES.length) {
        currentZoneIndex = 0; // Reset only if we've exhausted all zones
      }
      requestAd();
    }
  }, 45000);
}

// Disable right-click
player.addEventListener('contextmenu', e => e.preventDefault());

// User interaction for ads
player.addEventListener('play', () => {
  if (!hasUserInteracted) {
    hasUserInteracted = true;
    if (!initialized) {
      adDisplayContainer.initialize();
      initialized = true;
    }
    // Sirf tabhi pre-roll chalayein jab video 5 min (300s) se bada ho
    if (player.duration > 300) {
      startAdCycle();
    }
  }
});

/* --------- Meta Update --------- */
function updateMeta(v){
    document.querySelectorAll('meta[property="og:image"],meta[name="twitter:image"],meta[name="twitter:card"]').forEach(m=>m.remove());
    const head = document.head;
    const ogImg = document.createElement("meta");
    ogImg.setAttribute("property","og:image");
    ogImg.setAttribute("content", v.thumb);
    head.appendChild(ogImg);
}

/* --------- Helpers --------- */
function shuffleArray(arr){
    for(let i=arr.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]]=[arr[j],arr[i]];
    }
    return arr;
}

/* --------- Load Data --------- */
fetch(DATA_URL, { cache: "no-store" })
    .then(r => r.json())
    .then(data => {
        const list = Array.isArray(data) ? data : (data.videos || []);
        
        console.log("âœ… Fetched", list.length, "videos");
        
        if(!list.length){
            mainTitle.textContent = "No videos available.";
            return;
        }
        
        // Populate videos object
        list.forEach(item => {
            videos[item.videoid] = item;
        });
        
        console.log("âœ… Videos loaded:", Object.keys(videos).length);

        initIMA();

        // Get video ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const vId = urlParams.get('v');
        const videoKeys = Object.keys(videos);
        const firstId = videoKeys.length > 0 ? videoKeys[0] : null;

        if (vId && videos[vId]) {
            loadVideo(vId);
        } else if (firstId) {
            loadVideo(firstId);
        }

        const currentV = vId || firstId;
        renderSuggestions(currentV);
    })
    .catch(err => {
        console.error("âŒ Data load error:", err);
        mainTitle.textContent = "Failed to load videos.";
    });

/* --------- Load Video --------- */
function loadVideo(id, isHistoryNavigation = false){
    console.log("ðŸŽ¬ Loading video:", id, isHistoryNavigation ? "(from history)" : "");

    const v = videos[id];
    if(!v) {
        console.error("âŒ Video not found:", id);
        return;
    }

    currentVideoId = id;
    hasUserInteracted = false;

    if (adsManager) adsManager.destroy();
    clearInterval(retryInterval);
    isAdPlaying = false;
    adContainer.classList.remove('active');

    // Set video source
    player.src = R2_STREAM_BASE + "videos/" + v.videoid + ".mp4";
    player.poster = v.thumb || "";
    player.load();

    // View count tracking - only count after 5% watched or video ends
    let viewCountedFlag = false;
    let watchedPercentage = 0;
    
    function countView() {
        if (!viewCountedFlag && !isHistoryNavigation) {
            viewCountedFlag = true;
            fetch(`https://clipfy.store/api/watch`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ videoid: id })
            })
                .then(() => console.log("View counted"))
                .catch(err => console.error("View count error:", err));
        }
    }
    
    // Track video progress for 5% threshold
    player.addEventListener('timeupdate', () => {
        if (!viewCountedFlag && player.duration > 0) {
            watchedPercentage = (player.currentTime / player.duration) * 100;
            // Count view when user watches 5% or more
            if (watchedPercentage >= 5) {
                countView();
            }
        }
    });
    
    // Also count view when video ends
    player.addEventListener('ended', () => {
        countView();
    });

    // Update UI
    mainTitle.textContent = v.title || "Clipfy Video";
    creatorNameEl.textContent = v.creator || "Clipfy";
    timeAgoEl.textContent = v.timeago || "Recently";
    viewsEl.textContent = ((v.views || 0) + 1).toLocaleString(); // Increment locally
    likesEl.textContent = (v.likes || 0).toLocaleString();

    if(v.creator_dp) creatorDp.style.backgroundImage = `url(${v.creator_dp})`;

    document.title = (v.title || "Video") + " | Clipfy";
    updateMeta(v);

    // Update URL and history (only if not from history navigation and not initial load)
    if (!isHistoryNavigation && !isInitialLoad) {
        const newUrl = `${window.location.pathname}?v=${encodeURIComponent(id)}`;
        history.pushState({ videoid: id }, "", newUrl);
    }

    // Render suggestions
    renderSuggestions(id);

    // Mark initial load as complete
    isInitialLoad = false;
}

function renderSuggestions(current, append = false){
    console.log("=== Rendering Suggestions ===");

    if (Object.keys(videos).length === 0) {
        console.error("No videos!");
        return;
    }

    if(!append){
        suggestions.innerHTML = "";
        const allIds = Object.keys(videos);
        const filteredIds = allIds.filter(i => i !== current);
        allSuggestionIds = shuffleArray(filteredIds);
        suggestionsLoaded = 0;
    }

    const batchSize = 12;
    const nextBatch = allSuggestionIds.slice(suggestionsLoaded, suggestionsLoaded + batchSize);

    // Render videos
    nextBatch.forEach(id => {
        const v = videos[id];
        if (!v) return;

        const card = document.createElement("div");
        card.className = "suggestion-item";
        card.innerHTML = `
            <div class="suggestion-thumbnail">
                <img loading="lazy" src="${v.thumb || 'https://via.placeholder.com/640x360?text=No+Thumbnail'}">
            </div>
            <div class="suggestion-title">${v.title || "Untitled"}</div>
        `;
        card.onclick = () => {
            loadVideo(id);
            window.scrollTo({top: 0, behavior: 'smooth'});
        };
        suggestions.appendChild(card);
    });

    // ðŸ”¥ PURE RANDOM AD INSERTION
    const videoCards = suggestions.querySelectorAll('.suggestion-item:not(.ad-item)');
    if (videoCards.length >= 10) {
        const AD_COUNT = 3;

    // Pure random positions with MIN_GAP
    const MIN_GAP = 3; // Minimum 3 video cards between ads
    const positions = [];
    while (positions.length < AD_COUNT) {
        const pos = Math.floor(Math.random() * (videoCards.length - 2)) + 1; // 1 se (length-1) tak

        // Check if position is too close to existing ads
        const isTooClose = positions.some(existingPos =>
            Math.abs(existingPos - pos) < MIN_GAP
        );

        if (!positions.includes(pos) && !isTooClose) {
            positions.push(pos);
        }
    }

        positions.forEach(index => {
            const adDiv = document.createElement('div');
            adDiv.className = 'suggestion-item ad-item';

            const adIns = document.createElement('ins');
            adIns.className = 'eas6a97888e20';
            adIns.setAttribute('data-zoneid', '5840548');

            adDiv.appendChild(adIns);
            videoCards[index].after(adDiv);

            const adScript = document.createElement('script');
            adScript.textContent = '(AdProvider = window.AdProvider || []).push({ serve: {} });';
            adDiv.appendChild(adScript);
        });
    }

    suggestionsLoaded += batchSize;

    const loadMoreBtn = document.getElementById("loadMoreBtn");
    const remaining = allSuggestionIds.length - suggestionsLoaded;

    if(remaining > 0){
        loadMoreBtn.style.display = "block";
        loadMoreBtn.textContent = `See More Videos (+${Math.min(12, remaining)})`;
    } else {
        loadMoreBtn.style.display = "none";
    }
}

/* --------- Report Button --------- */
document.getElementById("reportBtn").onclick = () => {
    alert("âœ… Report feature coming soon!");
};

/* --------- Load More Button --------- */
document.getElementById("loadMoreBtn").onclick = () => {
    renderSuggestions(currentVideoId, true);
};

// Handle browser back/forward buttons
window.addEventListener('popstate', function(event) {
    if (event.state && event.state.videoid) {
        loadVideo(event.state.videoid, true);
    }
});
</script>

<script type="application/javascript">
(function() {
    var isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    var interZone = isMobile ? "5829432" : "5831970";
    var interClass = isMobile ? "eas6a97888e33" : "eas6a97888e35";

    var overlay = document.querySelector('.interstitial-overlay') || document.createElement('div');
    overlay.className = 'interstitial-overlay active'; // Shuruat se hi active rakho
    overlay.innerHTML = `
        <div class="interstitial-ad-container">
            <div class="${interClass}"></div>
            <button class="interstitial-close-btn show" onclick="this.closest('.interstitial-overlay').classList.remove('active'); document.body.style.overflow='';">âœ•</button>
        </div>
    `;
    document.body.style.overflow = 'hidden'; // Scrolling block

    // 1. Force Remove (Sirf safety ke liye agar net bilkul mar jaye)
    // Isko 8s ki jagah 12s kar dete hain taaki ad ko load hone ka pura mauka mile
    var backupRemoval = setTimeout(removeOverlay, 12000);

    function removeOverlay() {
        overlay.classList.remove('active');
        document.body.style.overflow = '';
        clearTimeout(backupRemoval);
        console.log("Overlay Cleared");
    }

    // 2. Ad Provider Call
    (window.AdProvider = window.AdProvider || []).push({
        "serve": {
            "prefix": interClass,
            "zone": interZone,
            "onAdLoaded": function() {
                console.log("Ad Load Ho Gaya!");
                // Ad dikhne ke baad Close button show karo
                var closeBtn = document.querySelector('.interstitial-close-btn');
                if(closeBtn) closeBtn.classList.add('show');
            },
            "onAdClosed": function() {
                removeOverlay(); // User ne ad band kiya toh parda hatao
            },
            "onAdError": function() {
                removeOverlay(); // Agar ad hi nahi hai toh user ko kyun rokna?
            }
        }
    });

    // 3. Fallback: Agar user ad par click karke wapas aaye
    window.addEventListener('focus', function() {
        setTimeout(removeOverlay, 1000); // 1 sec delay for smooth transition
    });
})();
</script>

<script type="application/javascript">
(function() {
    var isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    var selectedZone = isMobile ? 5830300 : 5830298;

    function shouldShowPop() {
        // Dono keys ko ek hi kar diya taaki conflict na ho
        const lastPop = localStorage.getItem("last_ad_time");
        if (!lastPop) return true;
        return (Date.now() - Number(lastPop)) > 900000;
    }

    // Isko page load ke 10 sec baad hi trigger karenge taaki VAST ads pehle chalein
    setTimeout(function() {
        if (!shouldShowPop()) return;

        console.log("ðŸŽ¯ Activating Popunder System...");

        var adConfig = {
            "ads_host": "a.pemsrv.com",
            "syndication_host": "s.pemsrv.com",
            "idzone": selectedZone,
            "frequency_period": 15,
            "frequency_count": 1,
            "trigger_method": 1,
            "capping_enabled": true
        };

        var sdk = document.createElement('script');
        sdk.src = "https://a.pemsrv.com/popunder1000.js";
        for (var key in adConfig) { sdk.setAttribute('data-exo-' + key, adConfig[key]); }
        document.body.appendChild(sdk);

        var hasTriggered = false;
        document.addEventListener('click', function() {
            if (hasTriggered) return;
            setTimeout(function() {
                if (!document.cookie.includes("zone-cap-" + selectedZone)) {
                    var win = window.open("https://s.pemsrv.com/v1/link.php?idzone=" + selectedZone, '_blank');
                    if (win) {
                        win.blur(); window.focus();
                        localStorage.setItem("last_ad_time", Date.now());
                        hasTriggered = true;
                    }
                }
            }, 500);
        }, { once: true });
    }, 6000); // 6 seconds - better balance

    // Ad Provider failure check (after 5 seconds)
    setTimeout(function() {
        if (typeof window.AdProvider === 'undefined') {
            console.warn("âš ï¸ Ad Provider failed to load - Hiding ad containers");
            
            // Hide all empty ad containers
            document.querySelectorAll('.ad-728-player, .ad-300-player, .ad-native-player').forEach(el => {
                if (el && (el.innerHTML.trim() === '' || !el.querySelector('iframe'))) {
                    el.style.display = 'none';
                }
            });
        }
    }, 5000);
})();
</script>

<script>
// IMA Ad Error Protection
if (typeof google !== 'undefined' && google.ima) {
    var originalPlay = HTMLVideoElement.prototype.play;
    HTMLVideoElement.prototype.play = function() {
        var adContainer = document.getElementById('adContainer');
        if (adContainer && adContainer.style.display === 'block') {
            // If ad container is visible but empty (ad failed)
            if (!adContainer.querySelector('video') && !adContainer.querySelector('iframe')) {
                console.warn("Ad container visible but empty - hiding");
                adContainer.style.display = 'none';
            }
        }
        return originalPlay.apply(this, arguments);
    };
}
</script>

</body>
</html>
