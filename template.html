<!doctype html>
<html>
<head>

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>{{TITLE}} | Clipfy Player</title>

<!-- FontAwesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<!-- Twitter Player Tags -->
<meta name="twitter:card" content="summary_large_image" /> 
<meta name="twitter:title" content="{{TITLE}}" /> 
<meta name="twitter:description" content="{{TITLE}}" /> 
<meta name="twitter:image" content="{{THUMB_URL}}" />
<meta name="twitter:player" content="{{PLAYER_PAGE_URL}}" />
<meta name="twitter:player:stream" content="{{VIDEO_URL}}" />
<meta name="twitter:player:stream:content_type" content="video/mp4" />

<style>
body { background:#0f141a; color:white; margin:0; padding:0; font-family:Arial; overflow-x:hidden; }

/* VIDEO BOX */
.video-box { width:100%; height:40vh; background:#000; position:fixed; top:0; left:0; z-index:9999; }
video { width:100%; height:100%; object-fit:contain; }

.video-box::before {
  content:"Loading...";
  position:absolute; top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,0,0,.9);
  color:white; display:flex; justify-content:center; align-items:center;
  opacity:0; transition:.3s; z-index:10000;
}
.video-box.loading::before { opacity:1; }

/* CONTENT */
.content-wrapper { padding-top:40vh; }

.header { display:flex; justify-content:space-between; padding:12px; border-bottom:1px solid #222; font-size:20px; }
.post { display:flex; padding:12px; gap:10px; align-items:center; }
.dp { width:42px; height:42px; border-radius:50%; background:#555; }

/* STATS */
.stats { display:flex; gap:15px; padding:12px; border-bottom:1px solid #222; align-items:center; }
.stats i { margin-right:5px; }
.stat-item { display:flex; align-items:center; }

/* TOP SLIM AD (new) */
.top-ad-slot {
  margin-top:0;
  padding:5px 0;
  background:#1a2430;
  border-bottom:1px solid #222;
  text-align:center;
}

/* ONLY TITLE SECTION (description removed) */
.blog-content { padding:20px; font-size:17px; line-height:1.6; }

/* SUGGESTIONS */
.suggestions-header { padding:12px 20px; font-size:18px; font-weight:700; border-top:1px solid #222; }

.suggestion-item { padding:12px 20px; border-bottom:1px solid #1a2430; cursor:pointer; }
.suggestion-thumbnail { width:100%; padding-top:56.25%; height:0; background:#333; border-radius:4px; position:relative; overflow:hidden; }
.suggestion-thumbnail img { width:100%; height:100%; position:absolute; top:0; left:0; object-fit:contain; background:black; }
.suggestion-title { font-weight:700; font-size:16px; margin-top:8px; }
.suggestion-creator { font-size:13px; color:#aaa; margin-top:2px; }

.suggestion-ad-slot {
  padding:10px;
  background:#1a2430;
  text-align:center;
  border-bottom:1px solid #1a2430;
}
</style>

</head>
<body>

<!-- VIDEO -->
<div class="video-box">
  <video id="player" playsinline controls autoplay loop>
    <source src="{{VIDEO_URL}}" type="video/mp4">
  </video>
</div>

<div class="content-wrapper">

  <div class="header"><div>X</div><div>â‹¯</div></div>

  <div class="post">
    <div class="dp"></div>
    <div>
      <div style="font-weight:700;">Content Creator Name</div>
      <div id="timeAgo">{{TIME_AGO}}</div>
    </div>
  </div>

  <!-- UPDATED STATS BLOCK (NO EMOJIS) -->
  <div class="stats">
    <span class="stat-item"><i class="fa-solid fa-heart"></i> <span id="likes">0</span></span>
    <span class="stat-item"><i class="fa-solid fa-eye"></i> <span id="views">0</span></span>
    <div id="shareBtn" class="stat-item" style="margin-left:auto; cursor:pointer;">
      <i class="fa-solid fa-share-nodes"></i> Share
    </div>
  </div>

  <!-- SLIM TOP AD (728x90) -->
  <div class="top-ad-slot">
    <script>
    atOptions={'key':'b40d9ebf8b9bb68f80451819ab41596e','format':'iframe','height':90,'width':728,'params':{}};
    </script>
    <script src="//www.highperformanceformat.com/b40d9ebf8b9bb68f80451819ab41596e/invoke.js"></script>
  </div>

  <!-- TITLE ONLY (NO DESCRIPTION) -->
  <div class="blog-content">
    <h2 id="mainVideoTitle">{{TITLE}}</h2>
  </div>

  <div class="suggestions-header">More Viral Videos ðŸ”¥</div>
  <div id="videoSuggestionsList"></div>

</div>

<script>
let VIDEO_ID='{{VIDEO_ID}}';
let API_BASE='{{API_BASE}}';
let ALL_VIDEOS = {{ALL_VIDEOS_JSON}};
if(!Array.isArray(ALL_VIDEOS)) ALL_VIDEOS=[];

const shareBtn=document.getElementById('shareBtn');
const player=document.getElementById('player');
const timeAgoEl=document.getElementById('timeAgo');
const videoSuggestionsList=document.getElementById('videoSuggestionsList');
const mainTitleEl=document.getElementById('mainVideoTitle');

let viewCounted=false;

function postViewHit(id){
  if(!API_BASE) return;
  fetch(`${API_BASE}/hit`,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({video_id:id,type:'view'})
  }).catch(()=>{});
}

player.addEventListener('play',()=>{
  if(!viewCounted){
    viewCounted=true;
    postViewHit(VIDEO_ID);
  }
});

shareBtn.onclick=()=>{
  if(navigator.share){
    navigator.share({title:'{{TITLE}}',url:location.href});
  } else {
    navigator.clipboard.writeText(location.href);
    alert("Link Copied!");
  }
};

/* SAFE SCRIPT LOADER FOR ADS */
function mountAd(container, html){
  const w=document.createElement('div');
  w.innerHTML=html;
  w.childNodes.forEach(n=>{
    if(n.tagName==="SCRIPT"){
      const s=document.createElement('script');
      if(n.src) s.src=n.src;
      else s.textContent=n.textContent;
      container.appendChild(s);
    } else container.appendChild(n);
  });
}

// --- SUGGESTED VIDEO PLAY ---
function playSuggestedVideo(v){
  player.parentElement.classList.add('loading');
  player.querySelector('source').src=v.video_url;
  player.load();

  player.addEventListener('canplay', function h(){
    player.parentElement.classList.remove('loading');
    player.play().catch(()=>{ player.muted=true; player.play(); });
    player.removeEventListener('canplay', h);
  });

  viewCounted=false;
  VIDEO_ID=v.video_id;

  mainTitleEl.innerText=v.title;
  timeAgoEl.innerText=v.time_ago;

  history.pushState(v, v.title, `/v/${v.video_id}.html`);

  renderVideoSuggestions(ALL_VIDEOS);
  window.scrollTo({top:0,behavior:'smooth'});
}

// --- RENDER SUGGESTIONS ---
function renderVideoSuggestions(videos){
  videoSuggestionsList.innerHTML='';
  let c=0;

  videos.forEach(v=>{
    if(v.video_id===VIDEO_ID) return;

    const item=document.createElement('div');
    item.className='suggestion-item';
    item.innerHTML=`
      <div class="suggestion-thumbnail"><img src="${v.thumb_url}"></div>
      <div class="suggestion-title">${v.title}</div>
      <div class="suggestion-creator">${v.creator}</div>
    `;
    item.onclick=()=>playSuggestedVideo(v);
    videoSuggestionsList.appendChild(item);

    c++;

    /* AD AFTER EVERY 2 VIDEOS */
    if(c % 2 === 0){
      const ad=document.createElement('div');
      ad.className='suggestion-ad-slot';
      mountAd(ad, `
        <script>
        atOptions={'key':'e8550078b37b6bf29c9b54eed61806f7','format':'iframe','height':250,'width':300,'params':{}};
        </script>
        <script src="//www.highperformanceformat.com/e8550078b37b6bf29c9b54eed61806f7/invoke.js"></script>
      `);
      videoSuggestionsList.appendChild(ad);
    }
  });
}

renderVideoSuggestions(ALL_VIDEOS);

window.onpopstate=e=>{ if(e.state) playSuggestedVideo(e.state); };
</script>

</body>
</html>
