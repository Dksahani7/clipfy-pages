<!doctype html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>TITLE | Clipfy Player</title>
    <meta property="og:title" content="TITLE">
    <meta property="og:description" content="DESCRIPTION">
    <meta property="og:type" content="video.other">
    <meta property="og:image" content="THUMBURL">
    <meta name="twitter:image" content="THUMBURL">
    <meta name="twitter:card" content="summary_large_image">
    <style>
        /* Styles clean minimal - no changes */
        body { background: #0f141a; color: #fff; font-family: Arial, sans-serif; margin: 0; padding: 0; overflow-x: hidden; }
        
        /* Fixed Video Box */
        .video-box { width: 100%; height: 40vh; position: fixed; top: 0; left: 0; background: #000; overflow: hidden; z-index: 9999; display: flex; align-items: center; justify-content: center; }
        video { width: 100%; height: 100%; object-fit: contain; }
        
        /* Floating Ad over Video (Ad 4 - 320x50) */
        .floating-ad { position: fixed; top: 10px; left: 50%; transform: translateX(-50%); width: 320px; height: 50px; z-index: 10000; background: rgba(0,0,0,0.8); display: none; }
        video ~ .floating-ad { display: block; }
        
        /* Scrollable Content */
        .content-wrapper { padding-top: 40vh; min-height: 250vh; position: relative; }
        
        /* Top Slim Ad (Ad 2 - 728x90 already exists) */
        .top-slim-ad { background: #1a2430; padding: 6px 0; margin: 0; text-align: center; border-bottom: 1px solid #222; }
        
        /* Post Stats */
        .post { padding: 12px 16px; display: flex; gap: 10px; align-items: center; border-bottom: 1px solid #222; }
        .dp { width: 42px; height: 42px; border-radius: 50%; background: #555; }
        #creatorName { font-weight: 600; font-size: 15px; }
        #timeAgo { font-size: 12px; color: #aaa; margin-top: 2px; }
        
        /* Stats with icons */
        .stats { display: flex; gap: 14px; padding: 8px 16px; border-bottom: 1px solid #222; font-size: 13px; align-items: center; }
        .stat-item { display: flex; align-items: center; gap: 4px; color: #d0d0d0; }
        .stat-icon { width: 14px; height: 14px; stroke: #d0d0d0; fill: none; }
        
        /* Title only */
        .blog-content { padding: 20px 16px; font-size: 17px; line-height: 1.7; }
        #mainTitle { margin: 0; font-size: 18px; font-weight: 600; }
        
        /* Suggestions Section */
        .suggestions-header { padding: 12px 20px; font-size: 18px; font-weight: 700; border-top: 1px solid #222; }
        .video-suggestions-list { background: transparent; overflow: visible; }
        .suggestion-thumbnail img { width: 100%; height: 100%; object-fit: cover; display: block; }
        
        /* Full-width suggestion cards */
        .suggestion-item { display: block; width: 100%; padding: 14px 20px; cursor: pointer; border-bottom: 1px solid #1a2430; transition: background .12s; overflow: visible; height: auto; }
        .suggestion-item:hover { background: #0b1216; }
        .suggestion-thumbnail { width: 100%; aspect-ratio: 16/9; background: #333; border-radius: 6px; overflow: hidden; margin-bottom: 10px; }
        .suggestion-details { display: flex; flex-direction: column; justify-content: center; }
        .suggestion-title { font-weight: 600; font-size: 16px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .suggestion-creator { font-size: 12px; color: #aaa; margin-top: 4px; }
        
        /* Ad Slot */
        .suggested-ad-slot { display: flex; justify-content: center; padding: 15px 0; border-bottom: 1px solid #222; background: transparent; }
        
        /* Fixed Footer Ad (Ad 1 - 320x50) */
        .footer-ad { position: fixed; bottom: 0; left: 0; width: 100%; height: 50px; background: #1a2430; z-index: 10001; text-align: center; border-top: 1px solid #222; }
        
        /* Social Bar (Ad 5 - Bottom Right) */
        .social-bar { position: fixed; bottom: 60px; right: 10px; z-index: 10002; width: 50px; height: 50px; }
        
        /* Utilities */
        .center { text-align: center; }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="video-box">
        <video id="player" playsinline controls autoplay muted poster="THUMBURL">
            <source src="VIDEOURL" type="video/mp4">
        </video>
        <!-- Floating Message Ad (Ad 4) -->
        <div id="floatingAd" class="floating-ad"></div>
    </div>
    
    <div class="content-wrapper">
        <!-- Post Stats -->
        <div class="post">
            <div class="dp" id="creatorDp"></div>
            <div>
                <div id="creatorName">Clipfy Videos</div>
                <div id="timeAgo">TIMEAGO</div>
            </div>
        </div>
        
        <div class="stats">
            <div class="stat-item">
                <svg class="stat-icon" viewBox="0 0 24 24">
                    <path d="M2 12s3.5-6 10-6 10 6 10 6-3.5 6-10 6-10-6-10-6z"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                </svg>
                <span id="views">0</span>
            </div>
            <div class="stat-item">
                <svg class="stat-icon" viewBox="0 0 24 24">
                    <path d="M12 21s-5-3.3-8-6.7C2 12.5 2 9.5 4 7.5 5.1 6.4 6.6 6 8 6c1.6 0 3.1.8 4 2 0.9-1.2 2.4-2 4-2 1.4 0 2.9.4 4 1.5 2 2 2 5 0 6.8C17 17.7 12 21 12 21z"></path>
                </svg>
                <span id="likes">0</span>
            </div>
            <div id="shareBtn">Share</div>
        </div>
        
        <div class="top-slim-ad" id="topSlimAd" aria-hidden="true">
            <div id="topSlimAdInner" style="width:728px; max-width:95%; height:90px; margin:0 auto;"></div>
        </div>
        
        <div class="blog-content">
            <h2 id="mainTitle">TITLE</h2>
        </div>
        
        <div class="suggestions-header">More Viral Videos</div>
        <div class="video-suggestions-list" id="videoSuggestionsList"></div>
        <div id="nativeAd" style="padding:20px 0; text-align:center;"></div>
    </div>
    
    <!-- Fixed Footer Ad (Ad 1) -->
    <div id="footerAd" class="footer-ad"></div>
    
    <!-- Social Bar (Ad 5) -->
    <div id="socialBar" class="social-bar"></div>

    <script>
        // ----------------- Config (templated server-side) -----------------
        let VIDEOID = "VIDEOID";
        const APIBASE = "APIBASE";
        const ALLVIDEOS = ALLVIDEOSJSON;
        ALLVIDEOS.sort(() => Math.random() - 0.5);
        const INITIALDATA = { title: "TITLE", thumb: "THUMBURL", description: "DESCRIPTION" };
        
        // DOM refs
        const player = document.getElementById('player');
        const likesEl = document.getElementById('likes');
        const viewsEl = document.getElementById('views');
        const timeAgoEl = document.getElementById('timeAgo');
        const mainTitleEl = document.getElementById('mainTitle');
        const videoSuggestionsList = document.getElementById('videoSuggestionsList');
        const shareBtn = document.getElementById('shareBtn');
        const creatorNameEl = document.getElementById('creatorName');
        const creatorDpEl = document.getElementById('creatorDp');
        const nativeAdContainer = document.getElementById('nativeAd');
        const floatingAd = document.getElementById('floatingAd');
        const footerAd = document.getElementById('footerAd');
        const socialBar = document.getElementById('socialBar');
        
        // View counting
        let viewCounted = false;
        player.addEventListener('play', () => {
            if (!viewCounted) {
                VIDEOID = viewCounted = true;
                try {
                    fetch(`${APIBASE}hit`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ videoid: VIDEOID, type: 'view' })
                    });
                } catch (e) {}
            }
        });
        
        // Share button
        shareBtn.onclick = () => {
            const mt = document.querySelector('meta[name="twitter:title"]');
            const shareTitle = mt?.getAttribute('content') || document.title;
            if (navigator.share) {
                navigator.share({ title: shareTitle, url: location.href }).catch(() => {});
            } else {
                navigator.clipboard?.writeText(location.href).then(() => alert('Link Copied!')).catch(() => alert(location.href));
            }
        };
        
        // ----------------- Ad injection utility (Updated) -----------------
        function injectAtOptionsAd(key, container, width, height) {
            if (!container) return;
            const marker = `data-atoptions-${key}-${width}x${height}`;
            if (container.getAttribute(marker)) return;
            container.setAttribute(marker, '1');
            
            const inline = document.createElement('script');
            inline.type = 'text/javascript';
            inline.text = `atOptions = { 'key': '${key}', 'format': 'iframe', 'height': ${height}, 'width': ${width}, 'params': {} };`;
            container.appendChild(inline);
            
            const src = `//www.highperformanceformat.com/${key}/invoke.js`;
            const s = document.createElement('script');
            s.type = 'text/javascript';
            s.async = true;
            s.src = src;
            container.appendChild(s);
        }
        
        function injectSocialBar(container) {
            if (!container || container.getAttribute('data-social-loaded')) return;
            container.setAttribute('data-social-loaded', '1');
            const s = document.createElement("script");
            s.type = 'text/javascript';
            s.src = '//pl28118636.effectivegatecpm.com/15/a6/05/15a60534651f783c4ee900a1a7101385.js';
            container.appendChild(s);
        }
        
        // ----------------- Ad injection on DOM load -----------------
        document.addEventListener('DOMContentLoaded', () => {
            // Ad 2: Top Slim 728x90 (already there)
            const topInner = document.getElementById('topSlimAdInner');
            injectAtOptionsAd('b40d9ebf8b9bb68f80451819ab41596e', topInner, 728, 90);
            
            // Ad 4: Floating 320x50 over video
            injectAtOptionsAd('b43458b980a14fc9fc68555f58ae039f', floatingAd, 320, 50);
            
            // Ad 1: Footer Fixed 320x50
            injectAtOptionsAd('b43458b980a14fc9fc68555f58ae039f', footerAd, 320, 50);
            
            // Ad 5: Social Bar bottom-right
            injectSocialBar(socialBar);
            
            creatorNameEl.innerText = 'Clipfy Videos';
            renderVideoSuggestions(ALLVIDEOS);
            
            try {
                const stateObj = {
                    videoid: VIDEOID,
                    title: INITIALDATA.title,
                    videourl: player.querySelector('source').src,
                    timeago: TIMEAGO,
                    likes: likesEl.innerText = '0',
                    views: viewsEl.innerText = '0',
                    thumb: INITIALDATA.thumb
                };
                history.replaceState(stateObj, INITIALDATA.title, location.pathname);
            } catch (e) {}
        });
        
        // ----------------- Render suggestions with ad logic -----------------
        function renderVideoSuggestions(videos) {
            videoSuggestionsList.innerHTML = '';
            let suggestioncount = 0;
            for (let i = 0; i < videos.length; i++) {
                const v = videos[i];
                if (!v || v.videoid === VIDEOID) continue;
                
                // Ad 3: Every 2 videos - 300x250
                if (suggestioncount % 2 === 0 && suggestioncount > 0) {
                    suggestioncount = 0;
                    const adDiv = document.createElement('div');
                    adDiv.className = 'suggested-ad-slot';
                    const inner = document.createElement('div');
                    inner.style.width = '300px';
                    inner.style.height = '250px';
                    inner.style.maxWidth = '95%';
                    adDiv.appendChild(inner);
                    videoSuggestionsList.appendChild(adDiv);
                    injectAtOptionsAd('e8550078b37b6bf29c9b54eed61806f7', inner, 300, 250);
                }
                
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                item.setAttribute('data-video-id', v.videoid);
                item.innerHTML = `
                    <div class="suggestion-thumbnail">
                        <img src="${escapeHtml(v.thumburl)}" alt="${escapeHtml(v.title)} thumbnail" loading="lazy">
                    </div>
                    <div class="suggestion-details">
                        <div class="suggestion-title">${escapeHtml(v.title)}</div>
                        <div class="suggestion-creator">${escapeHtml(v.creator)}</div>
                    </div>
                `;
                item.addEventListener('click', (e) => { e.preventDefault(); playSuggestedVideo(v); });
                videoSuggestionsList.appendChild(item);
                suggestioncount++;
            }
        }
        
        // Rest of the code remains same (playSuggestedVideo, popstate, meta tags, escapeHtml)
        // ... (copy existing functions from original file)
        
        function playSuggestedVideo(videoData) {
            if (!videoData || !videoData.videourl) return;
            const sourceEl = player.querySelector('source');
            sourceEl.src = videoData.videourl;
            player.load();
            player.play().catch(() => {});
            viewCounted = false;
            timeAgoEl.innerText = videoData.timeago;
            mainTitleEl.innerText = videoData.title;
            creatorNameEl.innerText = videoData.creator ? videoData.creator : 'Clipfy Videos';
            likesEl.innerText = typeof videoData.likes !== 'undefined' ? videoData.likes : likesEl.innerText || '0';
            viewsEl.innerText = typeof videoData.views !== 'undefined' ? videoData.views : viewsEl.innerText || '0';
            
            safeUpdateMetaTags({
                title: videoData.title,
                description: videoData.description,
                image: videoData.thumburl || videoData.thumb || INITIALDATA.thumb,
                playerpage: `/v/${videoData.videoid}.html`,
                stream: videoData.videourl
            });
            
            document.title = `${videoData.title ? videoData.title + ' | ' : ''}Clipfy Player`;
            
            const prevPath = location.pathname;
            const newPath = `/v/${videoData.videoid}.html`;
            VIDEOID = videoData.videoid;
            const stateObj = Object.assign({}, videoData);
            try {
                if (prevPath !== newPath) {
                    history.pushState(stateObj, videoData.title, newPath);
                } else {
                    history.replaceState(stateObj, videoData.title, newPath);
                }
            } catch (e) {}
            renderVideoSuggestions(ALLVIDEOS);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        window.onpopstate = function(event) {
            if (event.state && event.state.videoid) {
                const s = event.state;
                const vidData = s.videourl ? s : ALLVIDEOS.find(x => x.videoid === s.videoid);
                const sourceEl = player.querySelector('source');
                if (vidData.videourl) {
                    sourceEl.src = vidData.videourl;
                    player.load();
                    player.play().catch(() => {});
                    viewCounted = false;
                    timeAgoEl.innerText = vidData.timeago;
                    mainTitleEl.innerText = vidData.title;
                    creatorNameEl.innerText = vidData.creator ? vidData.creator : 'Clipfy Videos';
                    likesEl.innerText = vidData.likes ? vidData.likes : '0';
                    viewsEl.innerText = vidData.views ? vidData.views : '0';
                    
                    safeUpdateMetaTags({
                        title: vidData.title,
                        description: vidData.description,
                        image: vidData.thumburl || vidData.thumb || INITIALDATA.thumb,
                        playerpage: `/v/${vidData.videoid}.html`,
                        stream: vidData.videourl
                    });
                    VIDEOID = vidData.videoid;
                    renderVideoSuggestions(ALLVIDEOS);
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            }
        };
        
        function safeUpdateMetaTags({ title, description, image, playerpage, stream }) {
            try {
                setOrCreateMeta('twitter:title', title);
                setOrCreateMeta('twitter:description', description);
                setOrCreateMeta('twitter:image', image);
                setOrCreateMeta('og:image', image);
                setOrCreateMeta('twitter:player', playerpage);
                setOrCreateMeta('twitter:player:stream', stream);
                document.title = title ? `${title} | Clipfy Player` : 'Clipfy Player';
            } catch (e) {}
        }
        
        function setOrCreateMeta(nameOrProp, value) {
            if (!value) return;
            let sel;
            if (nameOrProp.startsWith('og:')) {
                sel = `meta[property="${nameOrProp}"]`;
            } else {
                sel = `meta[name="${nameOrProp}"]`;
            }
            let el = document.querySelector(sel);
            if (!el) {
                el = document.createElement('meta');
                if (nameOrProp.startsWith('og:')) {
                    el.setAttribute('property', nameOrProp);
                } else {
                    el.setAttribute('name', nameOrProp);
                }
                document.head.appendChild(el);
            }
            el.setAttribute('content', value);
        }
        
        function escapeHtml(str) {
            if (!str) return '';
            return String(str).replace(/[&<>"']/g, function (m) {
                return {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;'
                }[m];
            });
        }
    </script>
</body>
</html>
