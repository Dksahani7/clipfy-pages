<!doctype html>
<html>
<head>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Clipfy Player</title>

<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="">
<meta name="twitter:image" content="">
<meta property="og:image" content="">
<meta property="og:image:width" content="1280">
<meta property="og:image:height" content="720">

<style>
body{
    background:#0f141a;
    color:#fff;
    margin:0;
    font-family:Arial;
    overflow-x:hidden;
}
.video-box{
    width:100%;
    height:40vh;
    position:fixed;
    top:0;left:0;
    background:#000;
    z-index:9999;
}
.video-box iframe{
    width:100%;
    height:100%;
    border:0;
}
.content-wrapper{
    padding-top:40vh;
}
.post{
    padding:8px 14px;
    display:flex;
    gap:10px;
    border-bottom:1px solid #222;
}
.dp{
    width:42px;
    height:42px;
    border-radius:50%;
    background:#555;
    background-size:cover;
    background-position:center;
}
.stats{
    display:flex;
    gap:14px;
    padding:8px 14px;
    border-bottom:1px solid #222;
    font-size:14px;
    color:#ccc;
}
.blog-content{
    padding:12px 14px;
}
#mainTitle{
    font-size:18px;
    font-weight:600;
}
.suggestions-header{
    padding:10px 14px;
    font-size:16px;
    font-weight:700;
    border-top:1px solid #222;
}
.suggestion-item{
    padding:10px 14px;
    border-bottom:1px solid #1a2430;
    cursor:pointer;
}
.suggestion-thumbnail{
    width:100%;
    aspect-ratio:16/9;
    border-radius:6px;
    overflow:hidden;
}
.suggestion-thumbnail img{
    width:100%;
    height:100%;
    object-fit:cover;
}
.suggestion-title{
    padding-top:6px;
    font-size:14px;
}
@media (min-width:768px){
    .video-box{height:500px}
    .content-wrapper{padding-top:500px}
}
</style>
</head>

<body>

<div class="video-box">
    <iframe id="playerFrame" allowfullscreen allow="autoplay"></iframe>
</div>

<div class="content-wrapper">

    <div class="post">
        <div class="dp" id="creatorDp"></div>
        <div>
            <div id="creatorName"></div>
            <div id="timeAgo"></div>
        </div>
    </div>

    <div class="stats">
        <div><span id="views">0</span> views</div>
        <div><span id="likes">0</span> likes</div>
    </div>

    <div class="blog-content">
        <h2 id="mainTitle"></h2>
    </div>

    <div class="suggestions-header">More Videos ðŸ”¥</div>
    <div id="suggestions"></div>

</div>

<script>

const DATA_URL = "https://pub-a3ad4cec48664940879fc5dd37a07293.r2.dev/streamtape/index.json";

const iframe = document.getElementById("playerFrame");
const mainTitle = document.getElementById("mainTitle");
const creatorNameEl = document.getElementById("creatorName");
const timeAgoEl = document.getElementById("timeAgo");
const viewsEl = document.getElementById("views");
const likesEl = document.getElementById("likes");
const creatorDp = document.getElementById("creatorDp");
const suggestions = document.getElementById("suggestions");

let videos = {};
let VIDEOID = null;

function params(){
    const p=new URLSearchParams(location.search);
    return { v:p.get("v") };
}

function setMeta(name,value){
    let m=document.querySelector(`meta[name="${name}"]`)||document.querySelector(`meta[property="${name}"]`);
    if(!m){
        m=document.createElement("meta");
        name.startsWith("og") ? m.setAttribute("property",name) : m.setAttribute("name",name);
        document.head.appendChild(m);
    }
    m.setAttribute("content",value);
}

function shuffleArray(arr){
    for(let i=arr.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]]=[arr[j],arr[i]];
    }
    return arr;
}

async function loadData(){
    const r = await fetch(DATA_URL,{cache:"no-store"});
    const raw = await r.json();
    raw.forEach(v=>videos[v.videoid]=v);

    const { v } = params();
    const id = v && videos[v] ? v : Object.keys(videos)[0];
    loadVideo(id,true);
}

function loadVideo(id,push){
    const v = videos[id];
    if(!v) return;
    VIDEOID=id;

    iframe.src = "https://streamtape.com/e/" + v.streamtape_id;

    mainTitle.textContent = v.title || "Clipfy Video";
    creatorNameEl.textContent = v.creator || "Clipfy";
    timeAgoEl.textContent = v.timeago || "";
    viewsEl.textContent = v.views || "0";
    likesEl.textContent = v.likes || "0";

    if(v.creator_dp){
        creatorDp.style.backgroundImage = `url(${v.creator_dp})`;
    }

    // ðŸ”¥ ALWAYS NORMAL THUMB
    setMeta("twitter:image", v.thumb);
    setMeta("og:image", v.thumb);
    setMeta("twitter:title", v.title || "Video");
    document.title = (v.title||"Video")+" | Clipfy";

    if(push){
        history.pushState({}, "", `/streamtape/player.html?v=${id}`);
    }

    renderSuggestions(id);
}

function renderSuggestions(current){
    suggestions.innerHTML="";

    let ids = Object.keys(videos).filter(i=>i!==current);
    ids = shuffleArray(ids); // ðŸ”€ RANDOM EVERY TIME

    ids.forEach(id=>{
        const v=videos[id];
        const d=document.createElement("div");
        d.className="suggestion-item";
        d.innerHTML=`
            <div class="suggestion-thumbnail">
                <img src="${v.thumb}">
            </div>
            <div class="suggestion-title">${v.title}</div>
        `;
        d.onclick=()=>{
            loadVideo(id,true);
            scrollTo(0,0);
        };
        suggestions.appendChild(d);
    });
}

window.onpopstate=()=>{
    const { v }=params();
    if(v && videos[v]) loadVideo(v,false);
};

loadData();
</script>

</body>
</html>
