<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Clipfy Admin Panel</title>

<style>
:root{
  --bg:#0f141a;--card:#12182e;--text:#fff;--muted:#8b93b0;
  --accent:#ff2f5b;--success:#10b981;--warning:#f59e0b;
  --danger:#ef4444;--hover:#1a2139;--border:#2a3449;
}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font-family:Arial,sans-serif;font-size:14px}

header{background:var(--card);padding:16px;border-bottom:2px solid var(--accent);position:sticky;top:0;z-index:100}
.header-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.logo{font-size:22px;font-weight:900;color:var(--accent)}
.user-info{font-size:12px;color:var(--muted)}
.header-bottom{display:flex;gap:10px;flex-wrap:wrap;align-items:center}

.container{padding:20px;max-width:1600px;margin:auto}

.btn{padding:8px 14px;border:none;border-radius:6px;cursor:pointer;font-weight:500;transition:all .2s}
.btn-small{padding:4px 10px;font-size:12px}
.btn-success{background:var(--success);color:#fff}
.btn-danger{background:var(--danger);color:#fff}
.btn-warning{background:var(--warning);color:#000}
.btn-accent{background:var(--accent);color:#fff}
.btn:hover{opacity:.9;transform:translateY(-1px)}
.btn:disabled{opacity:.5;cursor:not-allowed;transform:none}

table{width:100%;border-collapse:collapse;margin:20px 0}
th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left}
th{background:var(--hover);font-weight:600}
tr:hover{background:var(--hover)}

.status-live{color:var(--success);font-weight:500}
.status-offline{color:var(--warning);font-weight:500}

.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.9);z-index:200;align-items:center;justify-content:center;padding:20px}
.modal-box{background:var(--card);padding:20px;border-radius:12px;width:min(90vw,450px);max-height:90vh;overflow-y:auto;border:1px solid var(--accent)}
.modal-box h3{margin-bottom:12px;color:var(--accent)}
.modal-box input,select{width:100%;padding:10px;margin:6px 0;border:1px solid var(--border);border-radius:6px;background:var(--hover);color:var(--text)}

.search-filter{display:flex;gap:10px;margin:16px 0;flex-wrap:wrap;align-items:center}
.search-box{padding:8px;width:260px;border-radius:6px;border:1px solid var(--border);background:var(--hover);color:var(--text)}
.filter-select{padding:8px;min-width:140px;border-radius:6px;border:1px solid var(--border);background:var(--hover);color:var(--text)}

.pagination{display:flex;gap:6px;justify-content:center;margin:14px 0}
.page-btn{padding:6px 10px}

.bulk-actions{display:flex;gap:8px;align-items:center;margin:10px 0;flex-wrap:wrap;font-size:12px;color:var(--muted)}

.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;margin-left:auto}
.stat-card{background:var(--hover);padding:10px 12px;border-radius:8px;text-align:left;border:1px solid var(--border)}
.stat-number{font-size:18px;font-weight:800;color:var(--accent)}
.stat-label{color:var(--muted);font-size:11px}

.thumb-preview{width:70px;height:45px;object-fit:cover;border-radius:4px;cursor:pointer}

.drag-handle{cursor:move;color:var(--muted);font-size:16px;margin-right:4px}

.kill-badge{font-size:11px;padding:4px 8px;border-radius:20px;background:#3b1d1d;color:#ffb4b4;border:1px solid #ff4d4d}
</style>
</head>

<body>

<header>
  <div class="header-top">
    <div class="logo">ðŸ”§ Clipfy Admin</div>
    <div class="user-info">
      <span id="killStatus" class="kill-badge" style="display:none">MAINTENANCE MODE</span>
      &nbsp;&nbsp;
      <span id="currentUser">Guest</span>
      <button class="btn btn-small btn-accent" onclick="logout()">Logout</button>
    </div>
  </div>
  <div class="header-bottom">
    <button class="btn btn-success" onclick="refresh()">ðŸ”„ Refresh</button>
    <button class="btn btn-accent" onclick="openVideoModal('add')">âž• Add Video</button>
    <button class="btn btn-warning" onclick="toggleBulkBar()">âš¡ Bulk</button>
    <button class="btn btn-danger" onclick="toggleKillSwitch()">ðŸš¨ Maintenance</button>

    <div class="stats-grid" id="stats"></div>
  </div>
</header>

<div class="container" id="mainContainer">
  <div class="search-filter">
    <input id="searchInput" class="search-box" placeholder="ðŸ” Search by title or ID..." oninput="applyFilters()">
    <select id="statusFilter" class="filter-select" onchange="applyFilters()">
      <option value="all">All</option>
      <option value="live">Live only</option>
      <option value="offline">Offline only</option>
    </select>
    <select id="sortFilter" class="filter-select" onchange="applyFilters()">
      <option value="recent">Recent first</option>
      <option value="title">Title A-Z</option>
      <option value="views">Most views</option>
    </select>
  </div>

  <div class="bulk-actions" id="bulkBar" style="display:none">
    <label><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"> Select all (page)</label>
    <button class="btn btn-small btn-warning" onclick="bulkOffline()">Bulk Offline</button>
    <button class="btn btn-small btn-danger" onclick="bulkDelete()">Bulk Delete</button>
    <span id="selectedCount">0 selected</span>
  </div>

  <table>
    <thead>
      <tr>
        <th></th>
        <th>#</th>
        <th>Thumb</th>
        <th>Title</th>
        <th>ID</th>
        <th>Views</</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="tbody">
      <tr><td colspan="8">Loading...</td></tr>
    </tbody>
  </table>

  <div class="pagination" id="pagination"></div>
</div>

<!-- LOGIN MODAL -->
<div class="modal" id="loginModal">
  <div class="modal-box">
    <h3>Admin Login</h3>
    <input id="login_user" placeholder="Username">
    <input id="login_pass" type="password" placeholder="Password">
    <button class="btn btn-success" onclick="doLogin()" style="margin-top:8px">Login</button>
  </div>
</div>

<!-- ADD/EDIT VIDEO MODAL -->
<div class="modal" id="videoModal">
  <div class="modal-box">
    <h3 id="videoModalTitle">Add Video</h3>
    <input id="v_id" placeholder="Video ID (unique)">
    <input id="v_title" placeholder="Title">
    <input id="v_thumb" placeholder="Thumbnail URL">
    <input id="v_stream" placeholder="Streamtape ID">
    <input id="v_views" type="number" placeholder="Views" value="0">
    <select id="v_status">
      <option value="live">Live</option>
      <option value="offline">Offline</option>
    </select>
    <div style="margin-top:10px">
      <button class="btn btn-success" onclick="saveVideo()">Save</button>
      <button class="btn btn-danger" onclick="closeAllModals()">Cancel</button>
    </div>
  </div>
</div>

<!-- THUMB MODAL -->
<div class="modal" id="thumbModal">
  <div class="modal-box">
    <h3>Thumbnail Control</h3>
    <img id="thumbPrev" style="width:100%;border-radius:8px;margin-bottom:8px">
    <input id="thumbNew" placeholder="New thumbnail URL">
    <div style="margin-top:8px">
      <button class="btn btn-warning" onclick="regenThumb()">Regenerate Blur (stub)</button>
      <button class="btn btn-success" onclick="saveThumb()">Save Thumbnail</button>
      <button class="btn btn-danger" onclick="closeAllModals()">Close</button>
    </div>
  </div>
</div>

<!-- CONFIRM MODAL -->
<div class="modal" id="confirmModal">
  <div class="modal-box">
    <h3 id="confirmTitle">Confirm</h3>
    <p id="confirmText" style="margin:10px 0"></p>
    <button class="btn btn-danger" id="confirmBtn">Confirm</button>
    <button class="btn btn-success" onclick="closeAllModals()">Cancel</button>
  </div>
</div>

<script>
const API = "https://clipfy.store/api";

let ADMIN_TOKEN = localStorage.getItem("clipfy_admin_token") || "";
let CURRENT_USER = localStorage.getItem("clipfy_admin_user") || "Guest";

let videos = [];
let filtered = [];
let selected = new Set();
let currentPage = 1;
const PER_PAGE = 50;
let editingId = null;
let currentThumbId = null;
let siteDisabled = false;

/* ============ AUTH + LOGIN ============ */

async function doLogin() {
  const u = document.getElementById("login_user").value.trim();
  const p = document.getElementById("login_pass").value.trim();
  if (!u || !p) return alert("Enter username & password");

  const r = await fetch(API + "/auth/login", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({username:u,password:p})
  });
  const data = await r.json();
  if (!data.token) {
    alert("Login failed");
    return;
  }
  ADMIN_TOKEN = data.token;
  CURRENT_USER = data.user || u;
  localStorage.setItem("clipfy_admin_token", ADMIN_TOKEN);
  localStorage.setItem("clipfy_admin_user", CURRENT_USER);

  document.getElementById("currentUser").textContent = CURRENT_USER;
  document.getElementById("loginModal").style.display = "none";
  init();
}

function logout() {
  localStorage.removeItem("clipfy_admin_token");
  localStorage.removeItem("clipfy_admin_user");
  ADMIN_TOKEN = "";
  CURRENT_USER = "Guest";
  location.reload();
}

/* ============ STATUS / KILL SWITCH ============ */

async function fetchStatus() {
  const r = await fetch(API + "/status");
  const s = await r.json();
  siteDisabled = !!s.site_disabled;
  updateKillBadge();
}

function updateKillBadge() {
  const el = document.getElementById("killStatus");
  el.style.display = siteDisabled ? "inline-block" : "none";
}

async function toggleKillSwitch() {
  if (!ADMIN_TOKEN) return alert("Login first");
  const wantOff = !siteDisabled;
  const r = await fetch(API + "/killswitch", {
    method: "POST",
    headers: {
      Authorization: ADMIN_TOKEN,
      "Content-Type":"application/json"
    },
    body: JSON.stringify({disabled: wantOff})
  });
  const data = await r.json();
  // backend `{ ok, msg }` hai, state hum jo bheja wahi rakhenge
  siteDisabled = wantOff;
  updateKillBadge();

  if (siteDisabled) {
    document.getElementById("mainContainer").innerHTML = `
      <div style="text-align:center;padding:60px">
        <h2>ðŸ”§ Maintenance Mode</h2>
        <p>Site is disabled. Toggle again to restore.</p>
      </div>
    `;
  } else {
    location.reload();
  }
}

/* ============ DATA LOAD ============ */

async function loadVideos() {
  if (!ADMIN_TOKEN) {
    document.getElementById("loginModal").style.display = "flex";
    return;
  }
  const r = await fetch(API + "/videos", {
    headers: {Authorization: ADMIN_TOKEN}
  });
  const data = await r.json();
  videos = data || [];
  applyFilters();
  updateStats();
}

function updateStats() {
  const total = videos.length;
  const live = videos.filter(v => !v.offline).length;
  const offline = total - live;

  document.getElementById("stats").innerHTML = `
    <div class="stat-card">
      <div class="stat-number">${total}</div>
      <div class="stat-label">Total videos</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" style="color:var(--success)">${live}</div>
      <div class="stat-label">Live</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" style="color:var(--warning)">${offline}</div>
      <div class="stat-label">Offline</div>
    </div>
  `;
}

/* ============ FILTER + PAGINATION ============ */

function applyFilters() {
  const q = document.getElementById("searchInput").value.toLowerCase();
  const status = document.getElementById("statusFilter").value;
  const sort = document.getElementById("sortFilter").value;

  filtered = videos.filter(v => {
    const matchQ = !q || v.title?.toLowerCase().includes(q) || v.videoid?.toLowerCase().includes(q);
    const matchStatus =
      status === "all" ||
      (status === "live" && !v.offline) ||
      (status === "offline" && v.offline);
    return matchQ && matchStatus;
  });

  filtered.sort((a,b)=>{
    if (sort==="title") return (a.title||"").localeCompare(b.title||"");
    if (sort==="views") return (b.views||0)-(a.views||0);
    // recent by R2 JSON `date` field
    return new Date(b.date||0) - new Date(a.date||0);
  });

  currentPage = 1;
  renderTable();
}

function renderTable() {
  const tb = document.getElementById("tbody");
  if (!filtered.length) {
    tb.innerHTML = `<tr><td colspan="8">No videos</td></tr>`;
    document.getElementById("pagination").innerHTML = "";
    return;
  }

  const start = (currentPage-1)*PER_PAGE;
  const pageItems = filtered.slice(start,start+PER_PAGE);

  tb.innerHTML = pageItems.map((v,idx)=>`
    <tr>
      <td>
        <input type="checkbox" value="${v.videoid}" 
          ${selected.has(v.videoid) ? "checked" : ""} 
          onchange="toggleSelect('${v.videoid}',this.checked)">
      </td>
      <td><span class="drag-handle">â˜°</span>${start+idx+1}</td>
      <td>
        <img src="${v.thumb}" class="thumb-preview" onclick="openThumb('${v.videoid}')">
      </td>
      <td ondblclick="openVideoModal('edit','${v.videoid}')">${v.title}</td>
      <td>${v.videoid}</td>
      <td>${v.views||0}</td>
      <td class="${v.offline?'status-offline':'status-live'}">
        ${v.offline?'Offline':'Live'}
      </td>
      <td>
        <button class="btn btn-small btn-warning" onclick="openVideoModal('edit','${v.videoid}')">Edit</button>
        <button class="btn btn-small btn-danger" onclick="deleteSingle('${v.videoid}')">Delete</button>
      </td>
    </tr>
  `).join("");

  renderPagination();
  updateSelectedCount();
}

function renderPagination() {
  const totalPages = Math.ceil(filtered.length / PER_PAGE);
  if (totalPages<=1) {
    document.getElementById("pagination").innerHTML = "";
    return;
  }
  let html = "";
  if (currentPage>1) {
    html += `<button class="btn page-btn" onclick="changePage(${currentPage-1})">Prev</button>`;
  }
  for (let p=1;p<=totalPages;p++){
    if (Math.abs(p-currentPage)>2 && p!==1 && p!==totalPages) continue;
    html += `<button class="btn page-btn ${p===currentPage?'btn-accent':''}" onclick="changePage(${p})">${p}</button>`;
  }
  if (currentPage<totalPages) {
    html += `<button class="btn page-btn" onclick="changePage(${currentPage+1})">Next</button>`;
  }
  document.getElementById("pagination").innerHTML = html;
}

function changePage(p) {
  currentPage = p;
  renderTable();
}

/* ============ SINGLE VIDEO CRUD ============ */

function openVideoModal(mode,id=null) {
  if (!ADMIN_TOKEN) return alert("Login first");
  document.getElementById("videoModal").style.display = "flex";

  if (mode==="add") {
    editingId = null;
    document.getElementById("videoModalTitle").textContent = "Add New Video";
    document.getElementById("v_id").disabled = false;
    document.getElementById("v_id").value = "";
    document.getElementById("v_title").value = "";
    document.getElementById("v_thumb").value = "";
    document.getElementById("v_stream").value = "";
    document.getElementById("v_views").value = "0";
    document.getElementById("v_status").value = "live";
  } else {
    const v = videos.find(x=>x.videoid===id);
    if (!v) return;
    editingId = id;
    document.getElementById("videoModalTitle").textContent = "Edit Video";
    document.getElementById("v_id").value = v.videoid;
    document.getElementById("v_id").disabled = true;
    document.getElementById("v_title").value = v.title || "";
    document.getElementById("v_thumb").value = v.thumb || "";
    document.getElementById("v_stream").value = v.streamtape_id || "";
    document.getElementById("v_views").value = v.views || 0;
    document.getElementById("v_status").value = v.offline ? "offline" : "live";
  }
}

async function saveVideo() {
  if (!ADMIN_TOKEN) return alert("Login first");
  const id = document.getElementById("v_id").value.trim();
  const title = document.getElementById("v_title").value.trim();
  const thumb = document.getElementById("v_thumb").value.trim();
  const stream = document.getElementById("v_stream").value.trim();
  const views = Number(document.getElementById("v_views").value||0);
  const offline = document.getElementById("v_status").value==="offline";

  if (!id || !title) return alert("Video ID + Title required");

  const payload = {
    videoid:id,
    title,
    thumb,
    streamtape_id: stream,
    views,
    offline
  };

  await fetch(API + "/video/save", {
    method:"POST",
    headers:{
      Authorization:ADMIN_TOKEN,
      "Content-Type":"application/json"
    },
    body:JSON.stringify(payload)
  });

  closeAllModals();
  loadVideos();
}

async function deleteSingle(id) {
  if (!ADMIN_TOKEN) return alert("Login first");
  const v = videos.find(x=>x.videoid===id);
  if (!confirm(`Delete permanently: "${v?.title||id}" ?`)) return;

  await fetch(API + "/video/delete",{
    method:"POST",
    headers:{
      Authorization:ADMIN_TOKEN,
      "Content-Type":"application/json"
    },
    body:JSON.stringify({videoid:id})
  });
  loadVideos();
}

/* ============ BULK ============ */

function toggleBulkBar() {
  const el = document.getElementById("bulkBar");
  el.style.display = el.style.display==="none" ? "flex" : "none";
}

function toggleSelect(id,checked) {
  if (checked) selected.add(id);
  else selected.delete(id);
  updateSelectedCount();
}

function toggleSelectAll() {
  const check = document.getElementById("selectAll").checked;
  const start = (currentPage-1)*PER_PAGE;
  const pageItems = filtered.slice(start,start+PER_PAGE);
  pageItems.forEach(v=>{
    if (check) selected.add(v.videoid);
    else selected.delete(v.videoid);
  });
  renderTable();
}

function updateSelectedCount() {
  document.getElementById("selectedCount").textContent = `${selected.size} selected`;
}

function openConfirm(title,text,callback) {
  document.getElementById("confirmTitle").textContent = title;
  document.getElementById("confirmText").textContent = text;
  document.getElementById("confirmBtn").onclick = async ()=>{
    await callback();
    closeAllModals();
    loadVideos();
  };
  document.getElementById("confirmModal").style.display = "flex";
}

function bulkOffline() {
  if (!selected.size) return alert("Select videos first");
  openConfirm(
    "Bulk Offline",
    `Make ${selected.size} videos offline (safe, not delete)?`,
    async ()=>{
      for (const id of selected) {
        await fetch(API + "/video/update",{
          method:"POST",
          headers:{
            Authorization:ADMIN_TOKEN,
            "Content-Type":"application/json"
          },
          body:JSON.stringify({videoid:id,data:{offline:true}})
        });
      }
      selected.clear();
    }
  );
}

function bulkDelete() {
  if (!selected.size) return alert("Select videos first");
  openConfirm(
    "Bulk Delete",
    `Permanently delete ${selected.size} videos? This cannot be undone.`,
    async ()=>{
      for (const id of selected) {
        await fetch(API + "/video/delete",{
          method:"POST",
          headers:{
            Authorization:ADMIN_TOKEN,
            "Content-Type":"application/json"
          },
          body:JSON.stringify({videoid:id})
        });
      }
      selected.clear();
    }
  );
}

/* ============ THUMBNAIL CONTROL ============ */

function openThumb(id) {
  const v = videos.find(x=>x.videoid===id);
  if (!v) return;
  currentThumbId = id;
  document.getElementById("thumbPrev").src = v.thumb;
  document.getElementById("thumbNew").value = v.thumb || "";
  document.getElementById("thumbModal").style.display = "flex";
}

async function saveThumb() {
  if (!currentThumbId) return;
  const newUrl = document.getElementById("thumbNew").value.trim();
  if (!newUrl) return alert("Enter thumbnail URL");

  await fetch(API + "/video/update",{
    method:"POST",
    headers:{
      Authorization:ADMIN_TOKEN,
      "Content-Type":"application/json"
    },
    body:JSON.stringify({videoid:currentThumbId,data:{thumb:newUrl}})
  });
  closeAllModals();
  loadVideos();
}

async function regenThumb() {
  if (!currentThumbId) return;
  await fetch(API + "/video/thumb/regen",{
    method:"POST",
    headers:{
      Authorization:ADMIN_TOKEN,
      "Content-Type":"application/json"
    },
    body:JSON.stringify({videoid:currentThumbId})
  });
  alert("Thumb blur regenerate stub called (backend real logic later)");
}

/* ============ MODALS / INIT ============ */

function closeAllModals() {
  document.querySelectorAll(".modal").forEach(m=>m.style.display="none");
}

function refresh() {
  loadVideos();
}

async function init() {
  document.getElementById("currentUser").textContent = CURRENT_USER;
  await fetchStatus();
  if (siteDisabled) {
    document.getElementById("mainContainer").innerHTML = `
      <div style="text-align:center;padding:60px">
        <h2>ðŸ”§ Maintenance Mode</h2>
        <p>Site is disabled. Toggle again to restore.</p>
      </div>
    `;
    updateKillBadge();
    return;
  }
  loadVideos();
}

document.addEventListener("DOMContentLoaded",()=>{
  if (!ADMIN_TOKEN) {
    document.getElementById("loginModal").style.display = "flex";
  } else {
    init();
  }
});
</script>

</body>
</html>
