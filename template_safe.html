<!doctype html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>{{TITLE}} | Clipfy Player</title>

<meta property="og:title" content="{{TITLE}}">
<meta property="og:description" content="{{DESCRIPTION}}">
<meta property="og:type" content="video.other">

<meta property="og:image" content="{{THUMB_URL}}">
<meta name="twitter:image" content="{{THUMB_URL}}">
<meta name="twitter:card" content="summary_large_image">

<style>
Â  Â  body{
Â  Â  Â  background:#0f141a;
Â  Â  Â  color:#fff;
Â  Â  Â  font-family:Arial, sans-serif;
Â  Â  Â  margin:0;
Â  Â  Â  padding:0;
Â  Â  Â  overflow-x:hidden;
Â  Â  }
Â  Â  .video-box{
Â  Â  Â  width:100%;
Â  Â  Â  height:40vh;
Â  Â  Â  position:fixed;
Â  Â  Â  top:0;
Â  Â  Â  left:0;
Â  Â  Â  background:#000;
Â  Â  Â  overflow:hidden;
Â  Â  Â  z-index:99999;
Â  Â  Â  display:flex;
Â  Â  Â  align-items:center;
Â  Â  Â  justify-content:center;
Â  Â  }
Â  Â  .video-box video{
Â  Â  Â  width:100%;
Â  Â  Â  height:100%;
Â  Â  Â  object-fit:contain;
Â  Â  }
Â  Â  .floating-ad-320x50{
Â  Â  Â  position:fixed;
Â  Â  Â  top:4px;
Â  Â  Â  left:50%;
Â  Â  Â  transform:translateX(-50%);
Â  Â  Â  z-index:10000;
Â  Â  Â  width:320px;
Â  Â  Â  max-width:95%;
Â  Â  Â  height:50px;
Â  Â  }
Â  Â  .content-wrapper{ padding-top:40vh; min-height:200vh; }
Â  Â  .top-thin-ad{ background:#1a2430; padding:6px 0; margin:0; text-align:center; border-bottom:1px solid #222; }
Â  Â  .top-thin-ad-inner{ width:728px; max-width:95%; height:90px; margin:0 auto; }
Â  Â  .post{ padding:10px 16px; display:flex; gap:10px; align-items:center; border-bottom:1px solid #222; }
Â  Â  .dp{ width:42px; height:42px; border-radius:50%; background:#555; }
Â  Â  #creatorName{ font-weight:600; font-size:15px; }
Â  Â  #timeAgo{ font-size:12px; color:#aaa; margin-top:2px; }
Â  Â  .stats{ display:flex; gap:14px; padding:8px 16px; border-bottom:1px solid #222; font-size:13px; align-items:center; }
Â  Â  .stat-item{ display:flex; align-items:center; gap:4px; color:#d0d0d0; }
Â  Â  .stat-icon{ width:14px; height:14px; stroke:#d0d0d0; fill:none; }
Â  Â  .stats-right{ margin-left:auto; cursor:pointer; font-size:13px; }
Â  Â  .blog-content{ padding:14px 16px; font-size:15px; line-height:1.5; }
Â  Â  #mainTitle{ margin:0 0 6px 0; font-size:18px; font-weight:600; }
Â  Â  .suggestions-header{ padding:10px 16px; font-size:16px; font-weight:700; border-top:1px solid #222; }
Â  Â  .video-suggestions-list{ background:transparent; }
Â  Â  .suggestion-item{ display:block; width:100%; padding:10px 16px 14px; cursor:pointer; border-bottom:1px solid #1a2430; transition:background .12s; }
Â  Â  .suggestion-item:hover{ background:#0b1216; }
Â  Â  .suggestion-thumbnail{ width:100%; aspect-ratio:16/9; background:#333; border-radius:6px; overflow:hidden; margin-bottom:8px; }
Â  Â  .suggestion-thumbnail img{ width:100%; height:100%; object-fit:cover; display:block; }
Â  Â  .suggestion-details{ display:flex; flex-direction:column; justify-content:center; }
Â  Â  .suggestion-title{ font-weight:600; font-size:15px; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
Â  Â  .suggestion-creator{ font-size:12px; color:#aaa; margin-top:3px; }
Â  Â  .suggested-ad-slot{ display:flex; justify-content:center; padding:12px 0; border-bottom:1px solid #222; min-height:250px; }
Â  Â  .footer-ad-320x50{ position:fixed; bottom:0; left:0; width:100%; z-index:10001; background:#000; display:flex; justify-content:center; padding:4px 0; }
Â  Â  .footer-ad-inner{ width:320px; max-width:95%; height:50px; }
Â  Â Â 
Â  Â  /* Social bar (sandboxed iframe) - FIX 2 & 5: Container and iframe made transparent */
Â  Â  #socialBarContainer{
Â  Â  Â  position:fixed;
Â  Â  Â  top:6vh; /* appears a bit below top over video */
Â  Â  Â  left:50%;
Â  Â  Â  transform:translateX(-50%);
Â  Â  Â  z-index:10002;
Â  Â  Â  width:320px;
Â  Â  Â  max-width:95%;
Â  Â  Â  height:56px;
Â  Â  Â  display:none;
Â  Â  Â  align-items:center;
Â  Â  Â  justify-content:center;
Â  Â  Â  pointer-events:auto;
Â  Â  Â  background:transparent; /* FIX 2/5 */
Â  Â  }
Â  Â  #socialBarFrame{Â 
Â  Â  Â  Â  width:100%;Â 
Â  Â  Â  Â  height:100%;Â 
Â  Â  Â  Â  border:0;Â 
Â  Â  Â  Â  border-radius:6px;Â 
Â  Â  Â  Â  overflow:hidden;Â 
Â  Â  Â  Â  background:transparent; /* FIX 2/5 */
Â  Â  }
Â  Â  .hidden{display:none!important;}
</style>
</head>
<body>

<div class="floating-ad-320x50" id="floatingAd320x50"></div>

<div class="video-box">
Â  <video id="player" playsinline controls autoplay muted>
Â  Â  <source src="{{VIDEO_URL}}" type="video/mp4">
Â  </video>
</div>

<div class="content-wrapper">

Â  <div class="top-thin-ad">
Â  Â  <div class="top-thin-ad-inner" id="topThinAdInner"></div>
Â  </div>

Â  <div class="post">
Â  Â  <div class="dp" id="creatorDp"></div>
Â  Â  <div>
Â  Â  Â  <div id="creatorName">Clipfy Videos</div>
Â  Â  Â  <div id="timeAgo">{{TIME_AGO}}</div>
Â  Â  </div>
Â  </div>

Â  <div class="stats">
Â  Â  <div class="stat-item">
Â  Â  Â  <svg class="stat-icon" viewBox="0 0 24 24">
Â  Â  Â  Â  <path d="M2 12s3.5-6 10-6 10 6 10 6-3.5 6-10 6-10-6-10-6z"/>
Â  Â  Â  Â  <circle cx="12" cy="12" r="3"/>
Â  Â  Â  </svg>
Â  Â  Â  <span id="views">{{VIEWS}}</span>
Â  Â  </div>

Â  Â  <div class="stat-item">
Â  Â  Â  <svg class="stat-icon" viewBox="0 0 24 24">
Â  Â  Â  Â  <path d="M12 21s-5-3.3-8-6.7C2 12.5 2 9.5 4 7.5 5.1 6.4 6.6 6 8 6c1.6 0 3.1.8 4 2 0.9-1.2 2.4-2 4-2 1.4 0 2.9.4 4 1.5 2 2 2 5 0 6.8C17 17.7 12 21 12 21z"/>
Â  Â  Â  </svg>
Â  Â  Â  <span id="likes">{{LIKES}}</span>
Â  Â  </div>

Â  Â  <div class="stats-right" id="shareBtn">Share</div>
Â  </div>

Â  <div class="blog-content">
Â  Â  <h2 id="mainTitle">{{TITLE}}</h2>
Â  </div>

Â  <div class="suggestions-header">More Viral Videos ðŸ”¥</div>
Â  <div class="video-suggestions-list" id="videoSuggestionsList"></div>
</div>

<div id="socialBarContainer" aria-hidden="true">
Â  <iframe id="socialBarFrame" sandbox="allow-scripts allow-same-origin"></iframe>
</div>

<div class="footer-ad-320x50">
Â  <div class="footer-ad-inner" id="footerAdInner"></div>
</div>

<script>
/* =========================
Â  Â CONFIG (ad keys & srcs)
Â  Â ========================= */
const TOP = { key:'b40d9ebf8b9bb68f80451819ab41596e', src:'//stinkymildred.com/b40d9ebf8b9bb68f80451819ab41596e/invoke.js', w:728, h:90 };
const FOOTER = { key:'b43458b980a14fc9fc68555f58ae039f', src:'//stinkymildred.com/b43458b980a14fc9fc68555f58ae039f/invoke.js', w:320, h:50 };
const FLOATING = { ...FOOTER };
const SUGGEST = { key:'e8550078b37b6bf29c9b54eed61806f7', src:'//stinkymildred.com/e8550078b37b6bf29c9b54eed61806f7/invoke.js', containerPrefix:'atContainer-e8550078b37b6bf29c9b54eed61806f7' };
const POPUNDER_SRC = '//stinkymildred.com/ca/e0/e6/cae0e6616497151a47e216bf81ebf050.js';
const SOCIAL_SRC = '//stinkymildred.com/15/a6/05/15a60534651f783c4ee900a1a7101385.js';

/* =========================
Â  Â UTIL: delay, hash, createScriptWithRetry (FIX 3: Retry mechanism improved)
Â  Â ========================= */
function delay(ms){ return new Promise(res=>setTimeout(res,ms)); }
function hashStr(s){ let h=0; for(let i=0;i<s.length;i++){ h=((h<<5)-h)+s.charCodeAt(i); h|=0;} return Math.abs(h).toString(36); }

async function createScriptWithRetry({src, inline, container=document.head, attempts=5, baseDelay=900}){
Â  const marker = 'data-src-'+hashStr(src||inline||Math.random().toString());
Â  for(let i=1;i<=attempts;i++){
Â  Â  try{
Â  Â  Â  // Clean up previous script attempt if it failed
Â  Â  Â  if (i > 1) {
Â  Â  Â  Â  const existingScript = container.querySelector(`script[src="${src}"]`) || container.querySelector(`script[data-attempt="${i - 1}"]`);
Â  Â  Â  Â  if(existingScript) existingScript.remove();
Â  Â  Â  }

Â  Â  Â  const s = document.createElement('script');
Â  Â  Â  s.setAttribute('data-attempt', i); // Add attempt marker
Â  Â  Â  if(inline){
Â  Â  Â  Â  s.type='text/javascript';
Â  Â  Â  Â  s.text = inline;
Â  Â  Â  } else {
Â  Â  Â  Â  s.type='text/javascript'; s.async=true; s.src = src;
Â  Â  Â  }
Â  Â  Â  try{s.setAttribute(marker,'1');}catch(e){} 
Â  Â  Â  container.appendChild(s);
Â  Â  Â Â 
Â  Â  Â  await new Promise(res=>{
Â  Â  Â  Â  let done=false;
Â  Â  Â  Â  s.onload = ()=>{ if(done) return; done=true; res(); };
Â  Â  Â  Â  s.onerror = ()=>{Â 
Â  Â  Â  Â  Â  Â  if(done) return;Â 
Â  Â  Â  Â  Â  Â  done=true;Â 
Â  Â  Â  Â  Â  Â  s.remove(); 
Â  Â  Â  Â  Â  Â  res(new Error('script load error'));Â 
Â  Â  Â  Â  };
Â  Â  Â  Â  // FIX 3: Timeout reduced from 6000ms to 3000ms
Â  Â  Â  Â  setTimeout(()=>{ if(done) return; done=true; res(); }, 3000);Â 
Â  Â  Â  });
Â  Â  Â  return;
Â  Â  }catch(e){
Â  Â  Â  const wait = baseDelay * Math.pow(1.8, i-1);
Â  Â  Â  await delay(wait);
Â  Â  Â  continue;
Â  Â  }
Â  }
}

/* =========================
Â  Â Helper: clear ad markers & containers so ads can be re-injected (FIX 1: Required for reload)
Â  Â ========================= */
function clearAdContainer(container){
Â  if(!container) return;
Â  container.innerHTML = '';
Â  try{
Â  Â  const attrs = Array.from(container.attributes || []);
Â  Â  attrs.forEach(a=>{
Â  Â  Â  if(a.name && a.name.startsWith('data-ad-')) container.removeAttribute(a.name);
Â  Â  });
Â  }catch(e){}
}

/* =========================
Â  Â Unified ad injector (keeps single injection per container)
Â  Â ========================= */
async function injectAd({key, width, height, src, container, delayMs=0, attempts=5, asyncMode=false, containerId}){ 
Â  if(!container) return;
Â  const marker = 'data-ad-'+key+'-'+width+'x'+height;
Â  if(container.getAttribute(marker)) return;
Â  container.setAttribute(marker,'1');

Â  if(delayMs>0) await delay(delayMs);

Â  // Use asyncMode ONLY if explicitly requested AND not for the more reliable iframe format.
Â  if(asyncMode){
Â  Â  try{
Â  Â  Â  if(typeof window.atAsyncOptions!=='object') window.atAsyncOptions=[];
Â  Â  Â  window.atAsyncOptions.push({
Â  Â  Â  Â  key: key,
Â  Â  Â  Â  format: 'js',
Â  Â  Â  Â  async: true,
Â  Â  Â  Â  container: containerId || container.id || '',
Â  Â  Â  Â  params: {}
Â  Â  Â  });
Â  Â  }catch(e){}
Â  Â  // load invoke script in head
Â  Â  await createScriptWithRetry({ src: src, container: document.head, attempts });
Â  Â  return;
Â  }

Â  // normal iframe mode (more reliable): write atOptions inline then load invoke.js inside a wrapper
Â  try{
Â  Â  clearAdContainer(container); 
Â  Â Â 
Â  Â  const wrapper = document.createElement('div');
Â  Â  wrapper.style.width='100%';
Â  Â  wrapper.style.height='100%';
Â  Â  wrapper.className = 'clipfy-ad-wrapper'; 
Â  Â  container.appendChild(wrapper);

Â  Â  const inline = `
Â  Â  Â  atOptions = {
Â  Â  Â  Â  'key' : '${key}',
Â  Â  Â  Â  'format' : 'iframe',
Â  Â  Â  Â  'height' : ${height},
Â  Â  Â  Â  'width' : ${width},
Â  Â  Â  Â  'params' : {}
Â  Â  Â  };
Â  Â  `;
Â  Â  
Â  Â  await createScriptWithRetry({ inline, container: wrapper, attempts });
Â  Â  await createScriptWithRetry({ src, container: wrapper, attempts });
Â  }catch(e){
Â  Â  Â  // if fails, clear marker so future attempts can retry
Â  Â  Â  try{
Â  Â  Â  Â  Â  container.removeAttribute(marker);
Â  Â  Â  Â  Â  clearAdContainer(container);
Â  Â  Â  }catch(_){}
Â  }
}

/* =========================
Â  Â Global Ad Refresh Logic (FIX 1: Ads Reloading on Video Change)
Â  Â ========================= */
let lastAdRefreshTs = 0;
const MIN_AD_REFRESH_INTERVAL = 700;Â 

let intersectionObservers = new WeakMap(); // To manage suggested ad observation

async function refreshAllAds({staggerBase=400} = {}){
Â  const now = Date.now();
Â  if(now - lastAdRefreshTs < MIN_AD_REFRESH_INTERVAL) return;
Â  lastAdRefreshTs = now;

Â  // 1. Top Banner Ad (728x90)
Â  try{
Â  Â  clearAdContainer(topThinAdInner);
Â  Â  const topDelay = staggerBase + 200 + Math.floor(Math.random()*200);
Â  Â  injectAd({ key: TOP.key, width: TOP.w, height: TOP.h, src: TOP.src, container: topThinAdInner, delayMs: topDelay, attempts: 5, asyncMode: false });
Â  }catch(e){}

Â  // 2. Floating Ad (320x50)
Â  try{
Â  Â  clearAdContainer(floatingAd320);
Â  Â  const floatDelay = staggerBase + 500 + Math.floor(Math.random()*300);
Â  Â  injectAd({ key: FLOATING.key, width: FLOATING.w, height: FLOATING.h, src: FLOATING.src, container: floatingAd320, delayMs: floatDelay, attempts: 5, asyncMode: false });
Â  }catch(e){}

Â  // 3. Footer Ad (320x50)
Â  try{
Â  Â  clearAdContainer(footerAdInner);
Â  Â  const footerDelay = staggerBase + 800 + Math.floor(Math.random()*400);
Â  Â  injectAd({ key: FOOTER.key, width: FOOTER.w, height: FOOTER.h, src: FOOTER.src, container: footerAdInner, delayMs: footerDelay, attempts: 5, asyncMode: false });
Â  }catch(e){}

Â  // 4. Suggested List Ads (Re-inject/Re-observe)
Â  try{
Â  Â  // FIX 1: Updated selector to strictly target suggested slots inside videoSuggestionsList
Â  Â  const suggestedSlots = document.querySelectorAll('.video-suggestions-list .suggested-ad-slot > div[id^="'+SUGGEST.containerPrefix+'"]');
Â  Â  suggestedSlots.forEach((inner, idx)=>{
Â  Â  Â  clearAdContainer(inner);
Â  Â  Â  // Re-observe: This will re-trigger ad injection if the slot is in the viewport
Â  Â  Â  observeAndInject(inner, idx + 1);
Â  Â  });
Â  }catch(e){}
}


/* =========================
Â  Â Fetch videos & render suggestions (lazy ad injection)
Â  Â ========================= */
let VIDEOID='{{VIDEO_ID}}';
const APIBASE='{{API_BASE}}';
let ALLVIDEOS=[];

fetch('https://pub-a3ad4cec48664940879fc5dd37a07293.r2.dev/metadata/index.json')
.then(r=>r.json())
.then(d=>{
Â  ALLVIDEOS = d.sort(()=>Math.random()-0.5);
Â  renderVideoSuggestions(ALLVIDEOS);
}).catch(()=>{});

const player = document.getElementById('player');
const likesEl = document.getElementById('likes');
const viewsEl = document.getElementById('views');
const timeAgoEl = document.getElementById('timeAgo');
const mainTitleEl = document.getElementById('mainTitle');
const creatorNameEl = document.getElementById('creatorName');
const videoSuggestionsList = document.getElementById('videoSuggestionsList');
const topThinAdInner = document.getElementById('topThinAdInner');
const footerAdInner = document.getElementById('footerAdInner');
const floatingAd320 = document.getElementById('floatingAd320x50');
const socialBarContainer = document.getElementById('socialBarContainer');
const socialBarFrame = document.getElementById('socialBarFrame');

player.addEventListener('play', ()=>{
Â  // fire view hit (non-blocking)
Â  try{
Â  Â  fetch(APIBASE+'hit', {
Â  Â  Â  method:'POST', headers:{'Content-Type':'application/json'},
Â  Â  Â  body: JSON.stringify({videoid: VIDEOID, type:'view'})
Â  Â  }).catch(()=>{});
Â  }catch(e){}
Â  // show social bar after small delay (only once)
Â  showSocialBarAfterPlay();
});

/* Share button */
const shareBtn = document.getElementById('shareBtn');
if(shareBtn) shareBtn.onclick = ()=>{
Â  const mt = document.querySelector('meta[name="twitter:title"]');
Â  const shareTitle = (mt && mt.getAttribute('content')) || document.title;
Â  if(navigator.share) navigator.share({title:shareTitle, url:location.href}).catch(()=>{});
Â  else navigator.clipboard?.writeText(location.href).catch(()=>{});
};

/* Render suggestions with ad slots every 2 items. (Keeping original logic for placement) */
function renderVideoSuggestions(videos){
Â  videoSuggestionsList.innerHTML='';
Â  let shown=0;
Â  let adCount=0;
Â  for(const v of videos){
Â  Â  if(!v || v.videoid===VIDEOID) continue;
Â  Â  if(v.videoid && v.videoid.includes('_safe')) continue;

Â  Â  // insert ad slot every 2 items (before the item)
Â  Â  if(shown>0 && shown%2===0){
Â  Â  Â  adCount++;
Â  Â  Â  const slot = document.createElement('div');
Â  Â  Â  slot.className='suggested-ad-slot';
Â  Â  Â  const inner = document.createElement('div');
Â  Â  Â  const containerId = SUGGEST.containerPrefix + '-' + adCount;
Â  Â  Â  inner.id = containerId;
Â  Â  Â  inner.style.width='300px';
Â  Â  Â  inner.style.height='250px';
Â  Â  Â  inner.style.maxWidth='95%';
Â  Â  Â  slot.appendChild(inner);
Â  Â  Â  videoSuggestionsList.appendChild(slot);

Â  Â  Â  // lazy observe and inject with small stagger based on adCount
Â  Â  Â  observeAndInject(inner, adCount);
Â  Â  }

Â  Â  const item = document.createElement('div');
Â  Â  item.className='suggestion-item';
Â  Â  item.dataset.videoId = v.videoid;
Â  Â  item.innerHTML = `
Â  Â  Â  <div class="suggestion-thumbnail">
Â  Â  Â  Â  <img src="${escapeHtml(v.thumburl)}" loading="lazy" alt="thumb">
Â  Â  Â  </div>
Â  Â  Â  <div class="suggestion-details">
Â  Â  Â  Â  <div class="suggestion-title">${escapeHtml(v.title)}</div>
Â  Â  Â  Â  <div class="suggestion-creator">${escapeHtml(v.creator)}</div>
Â  Â  Â  </div>
Â  Â  `;
Â  Â  item.onclick = ()=> playSuggestedVideo(v);
Â  Â  videoSuggestionsList.appendChild(item);
Â  Â  shown++;
Â  }
}

function observeAndInject(container, idx){
Â  if(intersectionObservers.has(container)) return; // Avoid re-observing

Â  const io = new IntersectionObserver((entries, obs)=>{
Â  Â  for(const en of entries){
Â  Â  Â  if(en.isIntersecting){
Â  Â  Â  Â  const stagger = 400 * (idx % 3) + Math.floor(Math.random()*400) + 200; 
Â  Â  Â  Â  injectAd({
Â  Â  Â  Â  Â  key: SUGGEST.key,
Â  Â  Â  Â  Â  width:300, height:250, src: SUGGEST.src,
Â  Â  Â  Â  Â  container: container, delayMs: stagger, attempts:5, asyncMode:false, containerId: container.id // FIX 2: asyncMode set to FALSE for reliability
Â  Â  Â  Â  });
Â  Â  Â  Â  obs.unobserve(container);
Â  Â  Â  Â  intersectionObservers.delete(container);
Â  Â  Â  }
Â  Â  }
Â  }, {threshold:0.35});
Â  io.observe(container);
Â  intersectionObservers.set(container, io); // Store observer
}

/* Play suggested video without full reload (FIX 1: Ads Reloading) */
function playSuggestedVideo(v){
Â  try{
Â  Â  const srcEl = player.querySelector('source');
Â  Â  if(srcEl){
Â  Â  Â  srcEl.src = v.videourl;
Â  Â  Â  player.load();
Â  Â  Â  player.play().catch(()=>{});
Â  Â  } else {
Â  Â  Â  player.src = v.videourl;
Â  Â  Â  player.play().catch(()=>{});
Â  Â  }
Â  }catch(e){}
Â  VIDEOID = v.videoid;
Â  mainTitleEl.innerText = v.title || '';
Â  timeAgoEl.innerText = v.timeago || '';
Â  creatorNameEl.innerText = v.creator || 'Clipfy Videos';
Â  if(likesEl) likesEl.innerText = v.likes ?? 0;
Â  if(viewsEl) viewsEl.innerText = v.views ?? 0;

Â  safeUpdateMetaTags({
Â  Â  title: v.title,
Â  Â  document_title: (v.title||'') + ' | Clipfy Player',
Â  Â  description: v.description,
Â  Â  image: v.thumburl,
Â  Â  playerpage: 'v/'+v.videoid+'.html',
Â  Â  stream: v.videourl
Â  });

Â  history.pushState({...v}, v.title, 'v/'+v.videoid+'.html');
Â  window.scrollTo({top:0, behavior:'smooth'});
Â Â 
Â  // FIX 1: Trigger ad reload after video change (Faster refresh)
Â  setTimeout(()=>{ refreshAllAds({staggerBase:500}); }, 500); // Faster stagger base
}

window.onpopstate = e=>{
Â  if(!e.state) return;
Â  const v = e.state;
Â  playSuggestedVideo(v);
Â  // FIX 1: Trigger ad reload after back/forward button (Faster refresh)
Â  setTimeout(()=>{ refreshAllAds({staggerBase:500}); }, 500); // Faster stagger base
};

function safeUpdateMetaTags(o){
Â  try{
Â  Â  setOrCreateMeta('twitter:title', o.title);
Â  Â  setOrCreateMeta('twitter:image', o.image);
Â  Â  setOrCreateMeta('twitter:description', o.description);
Â  Â  setOrCreateMeta('og:image', o.image);
Â  Â  setOrCreateMeta('twitter:player', o.playerpage);
Â  Â  setOrCreateMeta('twitter:player:stream', o.stream);
Â  Â  document.title = o.document_title || document.title;
Â  }catch(e){}
}

function setOrCreateMeta(name, value){
Â  if(!value) return;
Â  const isOg = name.startsWith('og');
Â  const sel = isOg ? `meta[property="${name}"]` : `meta[name="${name}"]`;
Â  let el = document.querySelector(sel);
Â  if(!el){
Â  Â  el = document.createElement('meta');
Â  Â  if(isOg) el.setAttribute('property', name);
Â  Â  else el.setAttribute('name', name);
Â  Â  document.head.appendChild(el);
Â  }
Â  el.setAttribute('content', value);
}

function escapeHtml(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* =========================
Â  Â INITIAL AD INJECTIONS (top, footer, floating) with OPTIMIZED delays
Â  Â ========================= */
document.addEventListener('DOMContentLoaded', ()=>{
Â  // top banner delay: 400-800ms
Â  injectAd({ key: TOP.key, width: TOP.w, height: TOP.h, src: TOP.src, container: topThinAdInner, delayMs: 400 + Math.floor(Math.random()*400), attempts:5, asyncMode:false }); 

Â  // footer banner delay: 800-1400ms
Â  injectAd({ key: FOOTER.key, width: FOOTER.w, height: FOOTER.h, src: FOOTER.src, container: footerAdInner, delayMs: 800 + Math.floor(Math.random()*600), attempts:5, asyncMode:false }); 

Â  // floating banner delay: 1500-2500ms
Â  injectAd({ key: FLOATING.key, width: FLOATING.w, height: FLOATING.h, src: FLOATING.src, container: floatingAd320, delayMs: 1500 + Math.floor(Math.random()*1000), attempts:5, asyncMode:false }); 

Â  // SCHEDULE AUTO-REFRESH FOR FLOATING AD (Sticky Ads benefit most from refresh)
Â  setInterval(()=>{
Â  Â  Â  // Check if player is playing AND if the window is focused before refreshing fixed ads
Â  Â  Â  if(!player.paused && document.hasFocus()){
Â  Â  Â  Â  try{
Â  Â  Â  Â  Â  clearAdContainer(floatingAd320);
Â  Â  Â  Â  Â  injectAd({
Â  Â  Â  Â  Â  Â  key: FLOATING.key,
Â  Â  Â  Â  Â  Â  width: FLOATING.w, height: FLOATING.h, src: FLOATING.src,
Â  Â  Â  Â  Â  Â  container: floatingAd320,
Â  Â  Â  Â  Â  Â  delayMs: 200, // Minimal delay on auto-refresh
Â  Â  Â  Â  Â  Â  attempts: 5, 
Â  Â  Â  Â  Â  Â  asyncMode: false
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }catch(e){}
Â  Â  Â  }
Â  }, 30000); // Refresh every 30 seconds

Â  // schedule popunder after 15s (cooldown preserved)
Â  setTimeout(()=>{ try{ initPopunder(); }catch(e){} }, 15000 + Math.floor(Math.random()*3000));
});

/* =========================
Â  Â POPUNDER logic (12h cooldown preserved)
Â  Â ========================= */
function initPopunder(){
Â  const KEY = 'clipfy_pop_ts';
Â  const now = Date.now();
Â  const last = parseInt(localStorage.getItem(KEY) || '0', 10);
Â  const LIMIT = 12*60*60*1000;
Â  if(last && (now - last) < LIMIT) return;
Â  try{
Â  Â  localStorage.setItem(KEY, now);
Â  Â  createScriptWithRetry({ src: POPUNDER_SRC, container: document.body, attempts:3 }).catch(()=>{});
Â  }catch(e){}
}

/* =========================
Â  Â SOCIAL BAR (sandbox iframe) (FIX 5: Inner Content Transparency)
Â  Â ========================= */
let socialShown = false;
function showSocialBarAfterPlay(){
Â  if(socialShown) return;
Â  socialShown = true;
Â  const delayAfterPlay = 5000 + Math.floor(Math.random()*2000); // as requested: a bit after video starts
Â  setTimeout(async ()=>{
Â  Â  try{
Â  Â  Â  socialBarContainer.style.display = 'flex';
Â  Â  Â  socialBarContainer.setAttribute('aria-hidden','false');
Â  Â  Â Â 
Â  Â  Â  const iframeHTML = `
Â  Â  Â  Â  <!doctype html>
Â  Â  Â  Â  <html>
Â  Â  Â  Â  <head>
Â  Â  Â  Â  Â  <meta name="viewport" content="width=device-width,initial-scale=1">
Â  Â  Â  Â  Â  <style>
Â  Â  Â  Â  Â  Â  Â /* FIX 5: Iframe internal content background transparent */
Â  Â  Â  Â  Â  Â  html,body{margin:0;padding:0;background:transparent!important;}
Â  Â  Â  Â  Â  </style>
Â  Â  Â  Â  Â  <script>
Â  Â  Â  Â  Â  Â  // push the social script into iframe context
Â  Â  Â  Â  Â  Â  (function(){
Â  Â  Â  Â  Â  Â  Â  var s = document.createElement('script');
Â  Â  Â  Â  Â  Â  Â  s.type = 'text/javascript';
Â  Â  Â  Â  Â  Â  Â  s.src = '${SOCIAL_SRC}';
Â  Â  Â  Â  Â  Â  Â  s.async = true;
Â  Â  Â  Â  Â  Â  Â  document.head.appendChild(s);
Â  Â  Â  Â  Â  Â  })();
Â  Â  Â  Â  Â  <\/script>
Â  Â  Â  Â  </head>
Â  Â  Â  Â  <body></body>
Â  Â  Â  Â  </html>
Â  Â  Â  `;
Â  Â  Â  socialBarFrame.srcdoc = iframeHTML;
Â  Â  }catch(e){}
Â  }, delayAfterPlay);
}

/* =========================
Â  Â Prevent page-wide accidental redirects:
Â  Â ========================= */
(function protectGlobalOpen(){
Â  try{
Â  Â  const origOpen = window.open.bind(window);
Â  Â  window._clipfy_last_target = null;
Â  Â  document.addEventListener('click', function(ev){
Â  Â  Â  window._clipfy_last_target = ev.target;
Â  Â  Â  setTimeout(()=>{ window._clipfy_last_target = null; }, 220);
Â  Â  }, true);

Â  Â  window.open = function(...args){
Â  Â  Â  try{
Â  Â  Â  Â  const last = window._clipfy_last_target;
Â  Â  Â  Â  if(last){
Â  Â  Â  Â  Â  const allowed = [
Â  Â  Â  Â  Â  Â  document.getElementById('socialBarContainer'),
Â  Â  Â  Â  Â  Â  document.getElementById('topThinAdInner'),
Â  Â  Â  Â  Â  Â  document.getElementById('footerAdInner'),
Â  Â  Â  Â  Â  Â  document.getElementById('floatingAd320x50')
Â  Â  Â  Â  Â  ];
Â  Â  Â  Â  Â  for(const p of allowed){
Â  Â  Â  Â  Â  Â  if(!p) continue;
Â  Â  Â  Â  Â  Â  if(p.contains(last)) return origOpen(...args);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  }catch(e){}
Â  Â  Â  return null;
Â  Â  };
Â  }catch(e){}
})();

/* =========================
Â  Â End of script
Â  Â ========================= */
</script>

</body>
</html>
