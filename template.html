<!doctype html>
<html>
<head>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>{{TITLE}} | Clipfy Player</title>

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="{{TITLE}}">
  <meta name="twitter:description" content="{{DESCRIPTION}}">
  <meta name="twitter:image" content="{{THUMB_URL}}">

  <meta property="og:image" content="{{THUMB_URL}}">
  <meta property="og:image:width" content="1280">
  <meta property="og:image:height" content="720">

  <meta name="twitter:player" content="{{PLAYER_PAGE_URL}}">
  <meta name="twitter:player:width" content="720">
  <meta name="twitter:player:height" content="405">
  <meta name="twitter:player:stream" content="{{VIDEO_URL}}">
  <meta name="twitter:player:stream:content_type" content="video/mp4">

  <style>
    body{
      background:#0f141a;
      color:#fff;
      font-family:Arial, sans-serif;
      margin:0;
      padding:0;
      overflow-x:hidden;
    }

    /* Video box sits fixed at the very top (Adjusted for new layout) */
    .video-box{
      width:100%;
      height:40vh;
      position:fixed;
      top:0; /* ADJUSTED */
      left:0;
      background:#000;
      overflow:hidden;
      z-index:9999;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .video-box video{
      width:100%;
      height:100%;
      object-fit:contain;
    }

    /* Floating Ad position adjusted to be near the top of the video */
    .floating-ad-320x50{
      position:fixed;
      top:4px; /* ADJUSTED */
      left:50%;
      transform:translateX(-50%);
      z-index:10000;
      width:320px;
      max-width:95%;
      height:50px;
      pointer-events:auto;
    }

    /* Content starts below video height (40vh) */
    .content-wrapper{
      padding-top:40vh; /* ADJUSTED */
      min-height:200vh;
    }

    /* TOP AD is now inside Content Wrapper (below video) - Not fixed anymore */
    .top-thin-ad{
      background:#1a2430;
      padding:6px 0;
      margin:0;
      text-align:center;
      border-bottom:1px solid #222;
    }
    .top-thin-ad-inner{
      width:728px;
      max-width:95%;
      height:90px;
      margin:0 auto;
    }

    .post{
      padding:10px 16px;
      display:flex;
      gap:10px;
      align-items:center;
      border-bottom:1px solid #222;
    }
    .dp{
      width:42px;
      height:42px;
      border-radius:50%;
      background:#555;
    }
    #creatorName{
      font-weight:600;
      font-size:15px;
    }
    #timeAgo{
      font-size:12px;
      color:#aaa;
      margin-top:2px;
    }

    .stats{
      display:flex;
      gap:14px;
      padding:8px 16px;
      border-bottom:1px solid #222;
      font-size:13px;
      align-items:center;
    }
    .stat-item{
      display:flex;
      align-items:center;
      gap:4px;
      color:#d0d0d0;
    }
    .stat-icon{
      width:14px;
      height:14px;
      stroke:#d0d0d0;
      fill:none;
    }
    .stats-right{
      margin-left:auto;
      cursor:pointer;
      font-size:13px;
    }

    .blog-content{
      padding:14px 16px;
      font-size:15px;
      line-height:1.5;
    }
    #mainTitle{
      margin:0 0 6px 0;
      font-size:18px;
      font-weight:600;
    }

    .suggestions-header{
      padding:10px 16px;
      font-size:16px;
      font-weight:700;
      border-top:1px solid #222;
    }
    .video-suggestions-list{
      background:transparent;
    }
    .suggestion-item{
      display:block;
      width:100%;
      padding:10px 16px 14px;
      cursor:pointer;
      border-bottom:1px solid #1a2430;
      transition:background .12s;
    }
    .suggestion-item:hover{
      background:#0b1216;
    }
    .suggestion-thumbnail{
      width:100%;
      aspect-ratio:16/9;
      background:#333;
      border-radius:6px;
      overflow:hidden;
      margin-bottom:8px;
    }
    .suggestion-thumbnail img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .suggestion-details{
      display:flex;
      flex-direction:column;
      justify-content:center;
    }
    .suggestion-title{
      font-weight:600;
      font-size:15px;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
    }
    .suggestion-creator{
      font-size:12px;
      color:#aaa;
      margin-top:3px;
    }

    .suggested-ad-slot{
      display:flex;
      justify-content:center;
      padding:12px 0;
      border-bottom:1px solid #222;
      background:transparent;
      min-height:250px;
    }
    
    /* NEW AD SLOT STYLE */
    .inline-ad-slot{
        display:flex;
        justify-content:center;
        padding:12px 0;
        border-bottom:1px solid #222;
        background:transparent;
        min-height:250px;
    }


    .footer-ad-320x50{
      position:fixed;
      bottom:0;
      left:0;
      width:100%;
      z-index:10001;
      background:#000;
      display:flex;
      justify-content:center;
      padding:4px 0;
    }
    .footer-ad-inner{
      width:320px;
      max-width:95%;
      height:50px;
    }

    /* Social bar (sandboxed iframe) - Transparency Fixes (Points 2 & 5) */
    #socialBarContainer{
      position:fixed;
      top:6vh; /* Adjusted to sit within the fixed video area */
      left:50%;
      transform:translateX(-50%);
      z-index:10002;
      width:320px;
      max-width:95%;
      height:56px;
      display:none; /* will show after delay */
      align-items:center;
      justify-content:center;
      pointer-events:auto;
      background:transparent; /* FIX 2/5: Container background set to transparent */
    }
    #socialBarFrame{
      width:100%;
      height:100%;
      border:0;
      border-radius:6px;
      overflow:hidden;
      background:transparent; /* FIX 2/5: Iframe background set to transparent */
    }

    .hidden{display:none!important;}
  </style>
</head>
<body>

  <div class="floating-ad-320x50" id="floatingAd320x50"></div>

  <div class="video-box">
    <video id="player" playsinline controls autoplay muted>
      <source src="{{VIDEO_URL}}" type="video/mp4">
    </video>
  </div>

  <div class="content-wrapper">

    <div class="top-thin-ad">
      <div class="top-thin-ad-inner" id="topThinAdInner"></div>
    </div>

    <div class="post">
      <div class="dp" id="creatorDp"></div>
      <div>
        <div id="creatorName">Clipfy Videos</div>
        <div id="timeAgo">{{TIME_AGO}}</div>
      </div>
    </div>

    <div class="stats">
      <div class="stat-item">
        <svg class="stat-icon" viewBox="0 0 24 24">
          <path d="M2 12s3.5-6 10-6 10 6 10 6-3.5 6-10 6-10-6-10-6z"/>
          <circle cx="12" cy="12" r="3"/>
        </svg>
        <span id="views">{{VIEWS}}</span>
      </div>

      <div class="stat-item">
        <svg class="stat-icon" viewBox="0 0 24 24">
          <path d="M12 21s-5-3.3-8-6.7C2 12.5 2 9.5 4 7.5 5.1 6.4 6.6 6 8 6c1.6 0 3.1.8 4 2 0.9-1.2 2.4-2 4-2 1.4 0 2.9.4 4 1.5 2 2 2 5 0 6.8C17 17.7 12 21 12 21z"/>
        </svg>
        <span id="likes">{{LIKES}}</span>
      </div>

      <div class="stats-right" id="shareBtn">Share</div>
    </div>

    <div class="blog-content">
      <h2 id="mainTitle">{{TITLE}}</h2>
      
      <div class="inline-ad-slot">
        <div id="inlineAdInner" style="width:300px; height:250px; max-width:95%;"></div>
      </div>
      
    </div>

    <div class="suggestions-header">More Viral Videos ðŸ”¥</div>
    <div class="video-suggestions-list" id="videoSuggestionsList"></div>
  </div>

  <div id="socialBarContainer" aria-hidden="true">
    <iframe id="socialBarFrame" sandbox="allow-scripts allow-same-origin"></iframe>
  </div>

  <div class="footer-ad-320x50">
    <div class="footer-ad-inner" id="footerAdInner"></div>
  </div>

<script>
/* ------------------------
   CONFIG (from your input)
   ------------------------ */
const TOP_BANNER = {
  key: 'b40d9ebf8b9bb68f80451819ab41596e',
  src: '//stinkymildred.com/b40d9ebf8b9bb68f80451819ab41596e/invoke.js',
  width: 728, height: 90
};
const FOOTER_BANNER = {
  key: 'b43458b980a14fc9fc68555f58ae039f',
  src: '//stinkymildred.com/b43458b980a14fc9fc68555f58ae039f/invoke.js',
  width: 320, height: 50
};
const FLOATING_BANNER = { ...FOOTER_BANNER }; // same key+src
const SUGGESTED_AD = {
  key: 'e8550078b37b6bf29c9b54eed61806f7',
  containerIdPrefix: 'atContainer-e8550078b37b6bf29c9b54eed61806f7',
  src: '//stinkymildred.com/e8550078b37b6bf29c9b54eed61806f7/invoke.js'
};
const POPUNDER_SRC = '//stinkymildred.com/ca/e0/e6/cae0e6616497151a47e216bf81ebf050.js';
const SOCIALBAR_SRC = '//stinkymildred.com/15/a6/05/15a60534651f783c4ee900a1a7101385.js';

// NEW: Inline Ad uses the same key as suggested ad but is loaded instantly.
const INLINE_AD = { ...SUGGESTED_AD }; 


/* ------------------------
   UTILS: delay, retry, createScriptWithRetry (FIX 3: Retry mechanism improved)
   ------------------------ */
function delay(ms){ return new Promise(r=>setTimeout(r,ms)); }

// FIX 3: createScriptWithRetry improved for robustness
async function createScriptWithRetry({src, inlineText, container, maxAttempts=5, baseDelay=900}){
  container = container || document.head;
  let attempt = 0;
  while(attempt < maxAttempts){
    attempt++;
    try{
      // Cleanup previous script attempt if it failed (cleaner wrapper/retry)
      if (attempt > 1) {
        const existingScript = container.querySelector(`script[src="${src}"]`) || container.querySelector(`script[data-attempt="${attempt - 1}"]`);
        if(existingScript) existingScript.remove();
      }
      
      const s = document.createElement('script');
      s.setAttribute('data-attempt', attempt); // Add attempt marker for cleaner retry
      
      if(inlineText){
        s.type = 'text/javascript';
        s.text = inlineText;
      } else {
        s.type = 'text/javascript';
        s.async = true;
        s.src = src;
      }
      
      return await new Promise((resolve, reject) => {
        let done=false;
        const cleanup = () => { if(s.parentNode) s.parentNode.removeChild(s); };

        s.onload = ()=>{
          if(done) return;
          done=true;
          resolve(s);
        };
        s.onerror = (e)=>{
          if(done) return;
          done=true;
          cleanup();
          reject(new Error(`Script load error on attempt ${attempt}: ${e.message || 'unknown'}`));
        };
        
        container.appendChild(s);
        
        // safety: resolve if no onload after certain time
        // FIX 3: Timeout reduced from 6000ms to 3000ms
        setTimeout(()=>{ if(done) return; done=true; resolve(s); }, 3000); 
      });
    }catch(e){
      const wait = baseDelay * Math.pow(1.8, attempt-1);
      if (attempt < maxAttempts) {
        await delay(wait);
      } else {
        throw e; // Re-throw error on final attempt
      }
    }
  }
  return null;
}

// tiny hash for attribute names (kept original function, but no longer strictly needed due to data-attempt)
function hashSrc(s){
  let h=0;
  for(let i=0;i<s.length;i++) h = ((h<<5)-h) + s.charCodeAt(i), h |= 0;
  return Math.abs(h).toString(36);
}

/* ------------------------
   Helper: clear ad markers & containers so ads can be re-injected
   ------------------------ */
function clearAdContainer(container){
  if(!container) return;
  // remove any wrapper scripts/elements
  container.innerHTML = '';
  // remove data-ad-key-* attributes
  try{
    const attrs = Array.from(container.attributes || []);
    attrs.forEach(a=>{
      if(a.name && (a.name.startsWith('data-ad-key-') || a.name.startsWith('data-ad-src-'))) container.removeAttribute(a.name);
    });
  }catch(e){}
  // also try to remove wrappers children
  const wrappers = container.querySelectorAll ? container.querySelectorAll('.clipfy-ad-wrapper') : [];
  wrappers.forEach(w=>w.remove());
}


/* ------------------------
   injectBannerAd: unified API for all ad slots (FIX 3: Improved wrapper/retry)
   ------------------------ */
async function injectBannerAd({key, width, height, src, container, delayMs=0, maxAttempts=5, asyncMode=false, containerHtmlId}){ // Increased maxAttempts to 5
  if(!container) return;
  const marker = 'data-ad-key-'+key+'-'+width+'x'+height;
  if(container.getAttribute(marker)) return;
  container.setAttribute(marker,'1');

  if(delayMs && delayMs>0) await delay(delayMs);

  // If asyncMode is true AND the ad is a Suggested Ad, use atAsyncOptions pattern
  if(asyncMode && window && key === SUGGESTED_AD.key){ 
    try{
      if(typeof window.atAsyncOptions !== 'object') window.atAsyncOptions = [];
      window.atAsyncOptions.push({
        key: key,
        format: 'js',
        async: true,
        container: containerHtmlId || container.id || '',
        params: {}
      });
    }catch(e){}
    // Note: Since we set asyncMode to FALSE for suggested ads in observeAndInjectAd, 
    // this block will now only be hit if some other code calls it with asyncMode: true.
  }

  // Insert wrapper to keep DOM clean (FIX 3: Wrapper clean and reinject improved)
  try{
    const wrapper = document.createElement('div');
    wrapper.style.width = '100%';
    wrapper.style.height = '100%';
    wrapper.style.display = 'flex';
    wrapper.style.alignItems = 'center';
    wrapper.style.justifyContent = 'center';
    wrapper.className = 'clipfy-ad-wrapper';
    container.innerHTML = ''; // Clean old content
    container.appendChild(wrapper);

    // build atOptions inline
    // Note: Suggested Ads (when asyncMode is FALSE) will use 'iframe' format here, which is the BEST FIX.
    const adFormat = (asyncMode && key === SUGGESTED_AD.key) ? 'js' : 'iframe';
    const atOptions = `
      atOptions = {
       'key' : '${key}',
       'format' : '${adFormat}',
       'height' : ${height},
       'width' : ${width},
       'params' : {}
      };
    `;
    
    // add inline config script to wrapper then load invoke script with retry
    await createScriptWithRetry({ inlineText: atOptions, container: wrapper, maxAttempts: maxAttempts });
    await createScriptWithRetry({ src: src, container: wrapper, maxAttempts: maxAttempts });
  }catch(e){
    // if fails, clear marker so future attempts can retry (FIX 3: Clear marker and innerHTML)
    try{
      container.removeAttribute && Array.from(container.attributes || []).forEach(attr=>{
        if(attr && attr.name && attr.name.startsWith('data-ad-key-')) container.removeAttribute(attr.name);
      });
      container.innerHTML = '';
    }catch(_){}
  }
}

/* ------------------------
   Global: keep track of last ad refresh (FIX 1: Ads Reloading)
   ------------------------ */
let lastAdRefreshTs = 0;
const MIN_AD_REFRESH_INTERVAL = 700; // ms - do not refresh more often than this

// REFRESH ALL ADS (Updated StaggerBase Logic)
async function refreshAllAds({staggerBase=400} = {}){
  const now = Date.now();
  if(now - lastAdRefreshTs < MIN_AD_REFRESH_INTERVAL) return;
  lastAdRefreshTs = now;

  console.log('Refreshing All Ads...');

  // 1. Top Banner Ad (728x90) - Faster load
  try{
    clearAdContainer(topThinAdInner);
    const topDelay = staggerBase + 200 + Math.floor(Math.random()*200); 
    injectBannerAd({
      key: TOP_BANNER.key,
      width: TOP_BANNER.width,
      height: TOP_BANNER.height,
      src: TOP_BANNER.src,
      container: topThinAdInner,
      delayMs: topDelay,
      maxAttempts: 5, 
      asyncMode: false
    });
  }catch(e){ console.error('Error refreshing top ad:', e); }
  
  // 1b. Inline Ad (300x250) - New Slot Refresh
  try{
    clearAdContainer(inlineAdInner);
    const inlineDelay = staggerBase + 400 + Math.floor(Math.random()*200); 
    injectBannerAd({
      key: INLINE_AD.key,
      width: 300,
      height: 250,
      src: INLINE_AD.src,
      container: inlineAdInner,
      delayMs: inlineDelay,
      maxAttempts: 5,
      asyncMode: false // Loading immediately, not via IntersectionObserver
    });
  }catch(e){ console.error('Error refreshing inline ad:', e); }


  // 2. Floating Ad (320x50) - Faster load
  try{
    clearAdContainer(floatingAd320);
    const floatDelay = staggerBase + 600 + Math.floor(Math.random()*300);
    injectBannerAd({
      key: FLOATING_BANNER.key,
      width: FLOATING_BANNER.width,
      height: FLOATING_BANNER.height,
      src: FLOATING_BANNER.src,
      container: floatingAd320,
      delayMs: floatDelay,
      maxAttempts: 5, 
      asyncMode: false
    });
  }catch(e){ console.error('Error refreshing floating ad:', e); }

  // 3. Footer Ad (320x50) - Faster load
  try{
    clearAdContainer(footerAdInner);
    const footerDelay = staggerBase + 900 + Math.floor(Math.random()*400);
    injectBannerAd({
      key: FOOTER_BANNER.key,
      width: FOOTER_BANNER.width,
      height: FOOTER_BANNER.height,
      src: FOOTER_BANNER.src,
      container: footerAdInner,
      delayMs: footerDelay,
      maxAttempts: 5, 
      asyncMode: false
    });
  }catch(e){ console.error('Error refreshing footer ad:', e); }

  // 4. Suggested List Ads (Re-inject/Re-observe)
  try{
    // FIX 1: UPDATED SELECTOR - Added .video-suggestions-list to strictly target suggested slots
    const suggestedSlots = document.querySelectorAll('.video-suggestions-list .suggested-ad-slot > div[id^="'+SUGGESTED_AD.containerIdPrefix+'"]');
    suggestedSlots.forEach((inner, idx)=>{
      // Clear the container markers to allow re-injection/re-observation
      clearAdContainer(inner);
      // Re-observe: This will re-trigger ad injection if the slot is in the viewport
      observeAndInjectAd(inner, idx + 1);
    });
  }catch(e){ console.error('Error refreshing suggested ads:', e); }
}

/* ------------------------
   PAGE: fetch metadata list and render suggestions
   ------------------------ */
let VIDEOID='{{VIDEO_ID}}';
const APIBASE='{{API_BASE}}';

let ALLVIDEOS=[];
fetch('https://pub-a3ad4cec48664940879fc5dd37a07293.r2.dev/metadata/index.json')
.then(r=>r.json())
.then(d=>{
  ALLVIDEOS = d.sort(()=>Math.random()-0.5);
  renderVideoSuggestions(ALLVIDEOS);
})
.catch(e=>{ /* ignore fetch fail */ });

const player=document.getElementById('player');
const likesEl=document.getElementById('likes');
const viewsEl=document.getElementById('views');
const timeAgoEl=document.getElementById('timeAgo');
const mainTitleEl=document.getElementById('mainTitle');
const creatorNameEl=document.getElementById('creatorName');
const videoSuggestionsList=document.getElementById('videoSuggestionsList');
const shareBtn=document.getElementById('shareBtn');
const topThinAdInner=document.getElementById('topThinAdInner');
const footerAdInner=document.getElementById('footerAdInner');
const floatingAd320=document.getElementById('floatingAd320x50');
const socialBarContainer=document.getElementById('socialBarContainer');
const socialBarFrame=document.getElementById('socialBarFrame');
const inlineAdInner=document.getElementById('inlineAdInner'); // NEW: Get the new ad slot


let viewCounted=false;
player.addEventListener('play',()=>{
 if(viewCounted) return;
 viewCounted=true;
 fetch(APIBASE+'hit',{
   method:'POST',
   headers:{'Content-Type':'application/json'},
   body:JSON.stringify({videoid:VIDEOID,type:'view'})
 }).catch(()=>{});
});

// share button
shareBtn.onclick=()=>{
 const mt=document.querySelector('meta[name="twitter:title"]');
 const shareTitle=(mt && mt.getAttribute('content')) || document.title;
 if(navigator.share){
   navigator.share({title:shareTitle,url:location.href}).catch(()=>{});
 } else {
   navigator.clipboard?.writeText(location.href)
     .then(()=>alert('Link Copied!'))
     .catch(()=>alert(location.href));
 }
};

/* ------------------------
   Render suggestions with ad slots (UPDATED: Ad in EVERY suggestion slot)
   ------------------------ */
function renderVideoSuggestions(videos){
 videoSuggestionsList.innerHTML='';
 let shown=0;
 let adIndex = 0;
 for(const v of videos){
   if(!v||v.videoid===VIDEOID) continue;
   if(v.videoid && v.videoid.includes('_safe')) continue;

   // UPDATED: Place an ad slot AFTER every item (shown > 0)
   if(shown > 0){ 
     adIndex++;
     const adSlot=document.createElement('div');
     adSlot.className='suggested-ad-slot';
     // unique container id per ad
     const containerId = SUGGESTED_AD.containerIdPrefix + (adIndex);
     const inner=document.createElement('div');
     inner.id = containerId;
     inner.style.width='300px';
     inner.style.height='250px';
     inner.style.maxWidth='95%';
     adSlot.appendChild(inner);
     videoSuggestionsList.appendChild(adSlot);

     // Lazy inject using IntersectionObserver and stagger
     observeAndInjectAd(inner, adIndex);
   }

   const item=document.createElement('div');
   item.className='suggestion-item';
   item.dataset.videoId=v.videoid;
   item.innerHTML=`
     <div class="suggestion-thumbnail">
       <img src="${escapeHtml(v.thumburl)}" loading="lazy">
     </div>
     <div class="suggestion-details">
       <div class="suggestion-title">${escapeHtml(v.title)}</div>
       <div class="suggestion-creator">${escapeHtml(v.creator)}</div>
     </div>
   `;
   item.onclick=e=>{
     e.preventDefault();
     playSuggestedVideo(v);
   };
   videoSuggestionsList.appendChild(item);
   shown++;
 }
}

let intersectionObservers = new WeakMap(); // Store observers to avoid memory leaks/duplicate observing

// observe when ad container becomes visible and then inject ad with small staggered delay
function observeAndInjectAd(container, idx){
  // Check if already observed
  if(intersectionObservers.has(container)) return;
  // if this container already has an ad marker, do not re-observe
  try{
    const anyMarker = Array.from(container.attributes || []).some(a => a.name && a.name.startsWith('data-ad-key-'));
    if(anyMarker) return;
  }catch(e){}

  const io = new IntersectionObserver((entries, obs)=>{
    for(const en of entries){
      if(en.isIntersecting){
        // UPDATED: Intersection Observer Threshold set lower for faster ad loading
        const staggerDelay = 200 * (idx % 3) + Math.floor(Math.random()*200) + 100;
        injectBannerAd({
          key: SUGGESTED_AD.key,
          width: 300,
          height: 250,
          src: SUGGESTED_AD.src,
          container: container,
          delayMs: staggerDelay,
          maxAttempts: 5, 
          asyncMode: false, // FIX 2: CHANGED to FALSE for better fill rate (forces iframe load)
          containerHtmlId: container.id
        });
        obs.unobserve(container);
        intersectionObservers.delete(container); // Remove observer once injected
      }
    }
  }, {threshold: 0.1}); // CHANGED: Threshold to 0.1 for faster load
  
  io.observe(container);
  intersectionObservers.set(container, io); // Store the observer
}

/* ------------------------
   playSuggestedVideo: replaces current video WITHOUT reload (FIX 1: Ads Reloading)
   ------------------------ */
function playSuggestedVideo(v){
 if(!v||!v.videourl) return;
 const src = player.querySelector('source');
 if(!src) return;
 src.src = v.videourl;
 player.load();
 player.play().catch(()=>{});
 viewCounted=false;

 VIDEOID = v.videoid;
 mainTitleEl.innerText = v.title || '';
 timeAgoEl.innerText = v.timeago || '';
 creatorNameEl.innerText = v.creator || 'Clipfy Videos';
 likesEl.innerText = v.likes ?? 0;
 viewsEl.innerText = v.views ?? 0;

 safeUpdateMetaTags({
   title: v.title,
   document_title: (v.title||'') + ' | Clipfy Player',
   description: v.description,
   image: v.thumburl,
   playerpage: 'v/'+v.videoid+'.html',
   stream: v.videourl
 });

 history.pushState({...v}, v.title, 'v/'+v.videoid+'.html');
 // scroll to top smoothly
 window.scrollTo({top:0,behavior:'smooth'});
 
 // FIX 1: REFRESH ADS: Ad refresh logic
 // Increased delay to ensure video change fully registered before starting ad loads
 setTimeout(()=>{ refreshAllAds({staggerBase:500}); }, 500); // CHANGED: Decreased timeout to 500ms
}

/* ------------------------
   handle back/forward (FIX 1: Ads Reloading)
   ------------------------ */
window.onpopstate = ev => {
 if(!ev.state) return;
 const v = ev.state;
 const src = player.querySelector('source');
 src.src = v.videourl;
 player.load();
 player.play();

 VIDEOID = v.videoid;
 mainTitleEl.innerText = v.title || '';
 timeAgoEl.innerText = v.timeago || '';
 creatorNameEl.innerText = v.creator || 'Clipfy Videos';
 likesEl.innerText = v.likes ?? 0;
 viewsEl.innerText = v.views ?? 0;

 safeUpdateMetaTags({
   title: v.title,
   document_title: (v.title||'') + ' | Clipfy Player',
   description: v.description,
   image: v.thumburl,
   playerpage: 'v/'+v.videoid+'.html',
   stream: v.videourl
 });

 window.scrollTo({top:0,behavior:'smooth'});
 
 // FIX 1: REFRESH ADS: Ad refresh logic
 // Increased delay to ensure video change fully registered before starting ad loads
 setTimeout(()=>{ refreshAllAds({staggerBase:500}); }, 500); // CHANGED: Decreased timeout to 500ms
};

/* ------------------------
   safeUpdateMetaTags helper
   ------------------------ */
function safeUpdateMetaTags(o){
 try{
   setOrCreateMeta('twitter:title',o.title);
   setOrCreateMeta('twitter:image',o.image);
   setOrCreateMeta('twitter:description',o.description);
   setOrCreateMeta('og:image',o.image);
   setOrCreateMeta('twitter:player',o.playerpage);
   setOrCreateMeta('twitter:player:stream',o.stream);
   document.title = o.document_title;
 }catch(e){}
}

function setOrCreateMeta(name,value){
 if(!value) return;
 const isOg = name.startsWith('og');
 const sel = isOg ? `meta[property="${name}"]` : `meta[name="${name}"]`;
 let el = document.querySelector(sel);
 if(!el){
   el = document.createElement('meta');
   if(isOg) el.setAttribute('property', name);
   else el.setAttribute('name', name);
   document.head.appendChild(el);
 }
 el.setAttribute('content', value);
}

function escapeHtml(str){
 return (str||"").replace(/&/g,'&amp;').replace(/</g,'&lt;');
}

/* ------------------------
   INITIAL AD INJECTIONS (top, footer, floating) - UPDATED Delays and Added Inline Ad
   ------------------------ */
document.addEventListener('DOMContentLoaded',()=>{
  // NEW: Inline Ad (300x250) - Load early (500-1000ms delay)
  const inlineDelay = 500 + Math.floor(Math.random()*500);
  injectBannerAd({
    key: INLINE_AD.key,
    width: 300,
    height: 250,
    src: INLINE_AD.src,
    container: inlineAdInner,
    delayMs: inlineDelay,
    maxAttempts: 5,
    asyncMode: false
  });
  
  // top banner: Faster load (400-800ms random delay)
  const topDelay = 400 + Math.floor(Math.random()*400); // CHANGED: Faster
  injectBannerAd({
    key: TOP_BANNER.key,
    width: TOP_BANNER.width,
    height: TOP_BANNER.height,
    src: TOP_BANNER.src,
    container: topThinAdInner,
    delayMs: topDelay,
    maxAttempts: 5, 
    asyncMode: false
  });

  // footer banner: Faster load (800-1400ms delay)
  const footerDelay = 800 + Math.floor(Math.random()*600); // CHANGED: Faster
  injectBannerAd({
    key: FOOTER_BANNER.key,
    width: FOOTER_BANNER.width,
    height: FOOTER_BANNER.height,
    src: FOOTER_BANNER.src,
    container: footerAdInner,
    delayMs: footerDelay,
    maxAttempts: 5, 
    asyncMode: false
  });

  // floating banner: Faster load (1500-2500ms delay)
  const floatDelay = 1500 + Math.floor(Math.random()*1000); // CHANGED: Faster
  injectBannerAd({
    key: FLOATING_BANNER.key,
    width: FLOATING_BANNER.width,
    height: FLOATING_BANNER.height,
    src: FLOATING_BANNER.src,
    container: floatingAd320,
    delayMs: floatDelay,
    maxAttempts: 5, 
    asyncMode: false
  });
  
  // SCHEDULE AUTO-REFRESH FOR FLOATING AD (Sticky Ads benefit most from refresh)
  setInterval(()=>{
      // Check if player is playing AND if the window is focused before refreshing fixed ads
      if(!player.paused && document.hasFocus()){
        try{
          console.log('Auto-refreshing floating ad...');
          clearAdContainer(floatingAd320);
          injectBannerAd({
            key: FLOATING_BANNER.key,
            width: FLOATING_BANNER.width,
            height: FLOATING_BANNER.height,
            src: FLOATING_BANNER.src,
            container: floatingAd320,
            delayMs: 200, // Minimal delay on auto-refresh
            maxAttempts: 5, 
            asyncMode: false
          });
        }catch(e){}
      }
  }, 30000); // Refresh every 30 seconds
  
  // schedule popunder loader with reduced cooldown (6 hours)
  setTimeout(()=>{ try{initPopunder();}catch(e){} }, 10000 + Math.floor(Math.random()*5000));
});

/* ------------------------
   POPUNDER logic (UPDATED: 6 hours cooldown)
   ------------------------ */
function initPopunder(){
  const POP_KEY = 'clipfy_pop_ts';
  const now = Date.now();
  const limit = 6*60*60*1000; // CHANGED: 6 hours cooldown (was 12 hours)
  const last = parseInt(localStorage.getItem(POP_KEY) || '0', 10);
  if(last && (now - last) < limit) return;
  try{
    localStorage.setItem(POP_KEY, now);
    // inject popunder script into body
    createScriptWithRetry({ src: POPUNDER_SRC, container: document.body, maxAttempts: 3 })
      .catch(()=>{});
  }catch(e){}
}

/* ------------------------
   SOCIAL BAR (sandboxed iframe) logic (FIX 5: Inner Content Transparency)
   ------------------------ */
let socialBarShown = false;
function showSocialBarAfterPlay(){
  if(socialBarShown) return;
  socialBarShown = true;

  // display container after a little delay (e.g., 5000ms after play), you asked video ke uper thoda baad me aaye
  const delayAfterPlay = 5000 + Math.floor(Math.random()*2000);
  setTimeout(async ()=>{
    try{
      socialBarContainer.style.display = 'flex';
      socialBarContainer.setAttribute('aria-hidden','false');

      // prepare iframe content (sandboxed). We load a minimal document that pushes the script into its head.
      const iframeDoc = `
        <!doctype html>
        <html>
        <head>
          <meta name="viewport" content="width=device-width,initial-scale=1">
          <style>
            /* FIX 5: Iframe internal content background transparent */
            html,body{margin:0;padding:0;background:transparent!important;}
          </style>
          <script>
            // create the script tag inside iframe
            (function(){
              var s = document.createElement('script');
              s.type = 'text/javascript';
              s.src = '${SOCIALBAR_SRC}';
              s.async = true;
              document.head.appendChild(s);
            })();
          <\/script>
        </head>
        <body></body>
        </html>
      `;
      // write into iframe
      socialBarFrame.srcdoc = iframeDoc;
    }catch(e){}
  }, delayAfterPlay);
}

// show social bar once video plays for first time
player.addEventListener('play', ()=>{
  showSocialBarAfterPlay();
});

// also allow manual show after page load (in case user wants)
setTimeout(()=>{ /* nothing */ }, 1000);

/* ------------------------
   Small helper: prevent accidental page-level click redirections
   ------------------------ */
(function preventPageWideRedirects(){
  try{
    const origOpen = window.open;
    window.open = function(...args){
      try{
        const last = window._clipfy_last_user_event_target || null;
        if(last){
          // allow if target is within known ad containers
          const allowedParents = [document.getElementById('socialBarContainer'), document.getElementById('topThinAdInner'), document.getElementById('footerAdInner'), document.getElementById('floatingAd320x50'), document.getElementById('inlineAdInner')];
          for(const p of allowedParents){
            if(!p) continue;
            if(p.contains(last)) return origOpen.apply(window, args);
          }
        }
      }catch(e){}
      // otherwise block
      return null;
    };
    // record last click target
    document.addEventListener('click', function(ev){
      window._clipfy_last_user_event_target = ev.target;
      setTimeout(()=>{ window._clipfy_last_user_event_target = null; }, 200);
    }, true);
  }catch(e){}
})();

/* ------------------------
   END OF SCRIPT
   ------------------------ */
</script>

</body>
</html>
