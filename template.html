<!doctype html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>{{TITLE}} | Clipfy Player</title>

<meta name="twitter:card" content="summary_large_image" /> 
<meta name="twitter:title" content="{{TITLE}}" />
<meta name="twitter:description" content="{{DESCRIPTION}}" />
<meta name="twitter:image" content="{{THUMB_URL}}" />
<meta property="og:image" content="{{THUMB_URL}}" />
<meta property="og:image:width" content="1280" />
<meta property="og:image:height" content="720" />

<meta name="twitter:player" content="{{PLAYER_PAGE_URL}}" />
<meta name="twitter:player:width" content="720" />
<meta name="twitter:player:height" content="405" />
<meta name="twitter:player:stream" content="{{VIDEO_URL}}" />
<meta name="twitter:player:stream:content_type" content="video/mp4" />

<style>
body {
  background:#0f141a;
  color:white;
  font-family:Arial, sans-serif;
  margin:0;
  padding:0;
  overflow-x:hidden;
}

.video-box {
  width:100%;
  height:40vh;
  position:fixed;
  top:0;
  left:0;
  background:#000;
  overflow:hidden;
  z-index:9999;
}

video {
  width:100%;
  height:100%;
  object-fit:contain;
}

.video-box::before {
  content: "Loading...";
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.9);
  color: #fff;
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 20px;
  z-index: 10000;
  opacity: 0;
  transition: opacity 0.3s;
  pointer-events: none;
}

.video-box.loading::before {
  opacity: 1;
}

.content-wrapper {
  padding-top:40vh;
}

.header {
  display:flex;
  justify-content:space-between;
  padding:12px;
  border-bottom:1px solid #222;
  font-size:20px;
}

.post {
  padding:12px;
  display:flex;
  gap:10px;
  align-items:center;
}

.dp {
  width:42px;
  height:42px;
  border-radius:50%;
  background:#555;
}

.stats {
  display:flex;
  gap:15px;
  padding:12px;
  border-bottom:1px solid #222;
  font-size:14px;
}

.blog-content {
  padding:20px;
  font-size:17px;
  line-height:1.7;
}

/* Suggestions */
.suggestions-header {
  padding: 12px 20px 12px 20px;
  font-size: 18px;
  font-weight: 700;
  border-top: 1px solid #222;
}

.suggestion-item {
  display: block; 
  padding: 12px 20px;
  cursor: pointer;
  border-bottom: 1px solid #1a2430; 
  background: #0f141a; 
}

.suggestion-thumbnail {
  width: 100%; 
  position: relative;
  padding-top: 56.25%;
  height: 0;
  background: #333;
  border-radius: 4px;
  overflow: hidden;
  margin-bottom: 8px; 
}

.suggestion-thumbnail img {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  object-fit: contain;
  background: black;
}

.suggestion-details {
  display: block;
}

.suggestion-title {
  font-weight: 700;
  font-size: 16px;
  margin-bottom: 4px;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.suggestion-creator {
  font-size: 13px;
  color: #aaa;
}

.suggestion-ad-slot {
  padding: 10px 20px;
  background: #1a2430;
  text-align: center;
  border-bottom: 1px solid #1a2430;
}
</style>
</head>

<body>

<div class="video-box">
  <video id="player" playsinline controls autoplay loop>
    <source src="{{VIDEO_URL}}" type="video/mp4">
  </video>
</div>

<div class="content-wrapper">

  <div class="header">
    <div>X</div>
    <div>‚ãØ</div>
  </div>

  <div class="post">
    <div class="dp"></div>
    <div>
      <div style="font-weight:700;">Content Creator Name</div>
      <div class="title" id="timeAgo">{{TIME_AGO}}</div>
    </div>
  </div>

  <div class="stats">
    ‚ù§Ô∏è <span id="likes">0</span>
    üëÅÔ∏è <span id="views">0</span>
    <div style="margin-left:auto; cursor:pointer;" id="shareBtn">üîó Share</div>
  </div>


  <div class="blog-content">
    <h2 id="mainVideoTitle">{{TITLE}}</h2> 
    <p id="mainVideoDescription">{{DESCRIPTION}}</p> 
  </div>

  <!-- Recommendations Start Immediately -->
  <div class="suggestions-header">
    More Viral Videos üî•
  </div>
  
  <div class="video-suggestions-list" id="videoSuggestionsList"></div>

</div>


<script>
let VIDEO_ID='{{VIDEO_ID}}';
const API_BASE='{{API_BASE}}';

const shareBtn=document.getElementById('shareBtn');
const player=document.getElementById('player');
const timeAgoEl = document.getElementById('timeAgo');
const videoSuggestionsList = document.getElementById('videoSuggestionsList');
const mainTitleEl = document.getElementById('mainVideoTitle'); 
const mainDescEl = document.getElementById('mainVideoDescription'); 

let viewCounted=false;
player.addEventListener('play',()=>{
  if(!viewCounted){
    viewCounted=true;
    fetch(`${API_BASE}/hit`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({video_id:VIDEO_ID,type:'view'})});
  }
});

shareBtn.onclick=()=>{
  if(navigator.share){ navigator.share({title:'{{TITLE}}',url:location.href}); }
  else{ navigator.clipboard.writeText(location.href); alert("Link Copied!"); }
};

const ALL_VIDEOS = {{ALL_VIDEOS_JSON}};


/* Autoplay fix */
player.addEventListener('loadedmetadata', function() {
    player.play().catch(error => {
        player.muted = true;
        player.play();

        const hint = document.createElement('div');
        hint.style = "position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:rgba(0,0,0,0.7); color:white; padding:10px 15px; border-radius:5px; font-weight:bold; cursor:pointer; z-index:10001;";
        hint.innerText = 'Tap to Unmute üîä';
        hint.onclick = () => {
            player.muted = false;
            hint.remove();
        };
        player.parentElement.appendChild(hint);
    });
});


function playSuggestedVideo(videoData) {
    const videoBox = player.parentElement;

    videoBox.classList.add('loading');
    
    const sourceEl = player.querySelector('source');
    sourceEl.src = videoData.video_url;
    player.load(); 
    
    player.addEventListener('canplay', function handler() {
        videoBox.classList.remove('loading');
        player.play().catch(()=>{ player.muted=true; player.play(); });
        player.removeEventListener('canplay', handler);
    });

    viewCounted = false; 
    
    timeAgoEl.innerText = videoData.time_ago;
    mainTitleEl.innerText = videoData.title;
    mainDescEl.innerText = videoData.description;
    document.title = videoData.title + " | Clipfy Player"; 

    VIDEO_ID = videoData.video_id; 
    const newURL = `/v/${videoData.video_id}.html`; 

    if (location.pathname !== newURL) {
        history.pushState(videoData, videoData.title, newURL);
    }
    
    renderVideoSuggestions(ALL_VIDEOS);

    window.scrollTo({ top: 0, behavior: 'smooth' });
}


/* AD scripts for inside recommended list */
const adSlot1Script = `<script>atOptions={'key':'e8550078b37b6bf29c9b54eed61806f7','format':'iframe','height':250,'width':300,'params':{}};</script><script src="//www.highperformanceformat.com/e8550078b37b6bf29c9b54eed61806f7/invoke.js"></script>`;
const adSlot2Script = `<script>atOptions={'key':'b40d9ebf8b9bb68f80451819ab41596e','format':'iframe','height':90,'width':728,'params':{}};</script><script src="//www.highperformanceformat.com/b40d9ebf8b9bb68f80451819ab41596e/invoke.js"></script>`;


/* Render suggestions */
function renderVideoSuggestions(videos) {
    videoSuggestionsList.innerHTML = ''; 
    
    let videoCount = 0;

    videos.forEach(video => {
        if (video.video_id === VIDEO_ID) return;

        const item = document.createElement('div');
        item.className = 'suggestion-item';
        
        item.innerHTML = `
            <div class="suggestion-thumbnail">
                <img src="${video.thumb_url}" alt="${video.title} thumbnail">
            </div>
            <div class="suggestion-details">
                <div class="suggestion-title">${video.title}</div>
                <div class="suggestion-creator">${video.creator}</div>
            </div>
        `;

        item.addEventListener('click', (e) => {
            e.preventDefault(); 
            playSuggestedVideo(video); 
        });
        
        videoSuggestionsList.appendChild(item);
        videoCount++;

        /* AD every 2 videos */
        if (videoCount % 2 === 0) {
            const adItem = document.createElement('div');
            adItem.className = 'suggestion-ad-slot';
            adItem.innerHTML = Math.random() < 0.5 ? adSlot1Script : adSlot2Script;
            videoSuggestionsList.appendChild(adItem);
        }
    });
}

renderVideoSuggestions(ALL_VIDEOS);

window.onpopstate = (event) => {
    if (event.state) {
        playSuggestedVideo(event.state);
    } 
};
</script>

</body>
</html>
