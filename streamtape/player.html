<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Clipfy Player | Byse Edition</title>

<style>
:root{
  --bg:#0f141a;
  --card:#12182e;
  --text:#fff;
  --muted:#8b93b0;
  --accent:#ff2f5b;
}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Arial,sans-serif;line-height:1.6;overflow-x:hidden}

/* Header */
header{position:sticky;top:0;z-index:1000;background:rgba(15,20,26,.95);backdrop-filter:blur(12px);border-bottom:1px solid rgba(255,255,255,.05);box-shadow:0 4px 20px rgba(0,0,0,.3)}
.nav{max-width:1200px;margin:auto;padding:10px 20px;display:flex;align-items:center;justify-content:space-between}
.logo{font-weight:900;font-size:22px;display:flex;align-items:center;gap:8px;text-decoration:none;color:inherit}
.logo span{color:var(--accent)}

/* Video Box - Fixed for Byse Iframe */
.video-container {
    position: sticky;
    top: 60px;
    z-index: 900;
    background: #000;
    width: 100%;
}
.video-box{
    width:100%;
    aspect-ratio: 16/9; 
    max-height: 60vh;
    background:#000;
}
.video-box iframe {
    width: 100%;
    height: 100%;
    border: 0;
}

/* Content Wrapper */
.content-wrapper{max-width:1200px;margin:auto;padding:0 20px; position: relative; z-index: 100;}

/* AD Slots */
.ad-728-player{margin:20px auto;text-align:center;max-width:728px;min-height:90px}
.ad-300-player{margin:20px auto;text-align:center;width:300px;height:250px;display:grid;place-items:center}
.ad-native-player{margin:30px auto;width:100%;max-width:1200px}

/* Video Info Section */
.post{padding:14px 0;display:flex;gap:12px;border-bottom:1px solid rgba(255,255,255,.05)}
.dp{width:45px;height:45px;border-radius:50%;background:var(--card);background-size:cover;background-position:center}
#creatorName{font-weight:600;font-size:16px}
#timeAgo{font-size:12px;color:var(--muted)}
.stats{display:flex;gap:20px;padding:14px 0;border-bottom:1px solid rgba(255,255,255,.05);font-size:14px;color:var(--muted)}
.blog-content{padding:14px 0}
#mainTitle{font-size:22px;font-weight:700;margin-bottom:5px;line-height:1.3}

/* Suggestions List */
.suggestions-header{padding:20px 0 10px 0;font-size:20px;font-weight:700;color:var(--text)}
#suggestions{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:20px;padding-bottom:20px}
.suggestion-item{background:var(--card);border-radius:12px;overflow:hidden;cursor:pointer;transition:.3s}
.suggestion-item:hover{transform:translateY(-4px);box-shadow:0 8px 20px rgba(255,47,91,.2)}
.suggestion-thumbnail{width:100%;aspect-ratio:16/9;overflow:hidden;background:#000}
.suggestion-thumbnail img{width:100%;height:100%;object-fit:cover}
.suggestion-title{padding:10px 12px;font-size:15px;line-height:1.4;font-weight:600}

/* Footer */
footer{background:var(--card);border-top:1px solid rgba(255,255,255,.05);padding:30px 20px;margin-top:40px;text-align:center;font-size:14px;color:var(--muted)}

@media(max-width:768px){
    .ad-728-player{display:none}
    .video-container { top: 55px; }
    .video-box{aspect-ratio: 16/10;}
}
</style>
</head>

<body>

<header>
  <nav class="nav">
    <a href="/" class="logo">â–¶ <span>clipfy.store</span></a>
  </nav>
</header>

<div class="video-container">
    <div class="video-box">
        <iframe id="playerFrame" allowfullscreen allow="autoplay"></iframe>
    </div>
</div>

<div class="ad-728-player" id="topAdSlot"></div>

<div class="content-wrapper">
    <div class="blog-content">
        <h2 id="mainTitle">Loading...</h2>
    </div>
    
    <div class="post">
        <div class="dp" id="creatorDp"></div>
        <div>
            <div id="creatorName"></div>
            <div id="timeAgo"></div>
        </div>
    </div>

    <div class="stats">
        <div><span id="views">0</span> views</div>
        <div><span id="likes">0</span> likes</div>
    </div>

    <div class="suggestions-header">Recommended for you ðŸ”¥</div>
    <div id="suggestions"></div>

    <div class="ad-native-player" id="nativeAdSlot"></div>
</div>

<footer>
  <div class="footer-bottom">Â© 2024 Clipfy.store. All rights reserved.</div>
</footer>

<script>
const DATA_URL = "https://pub-a3ad4cec48664940879fc5dd37a07293.r2.dev/streamtape/index.json";
const iframe = document.getElementById("playerFrame");
const mainTitle = document.getElementById("mainTitle");
const creatorNameEl = document.getElementById("creatorName");
const timeAgoEl = document.getElementById("timeAgo");
const viewsEl = document.getElementById("views");
const likesEl = document.getElementById("likes");
const creatorDp = document.getElementById("creatorDp");
const suggestions = document.getElementById("suggestions");
const topAdSlot = document.getElementById("topAdSlot");
const nativeAdSlot = document.getElementById("nativeAdSlot");

let videos = {};
let popunderReady = false;
let popFired = false;

/* --------- Functions ---------- */
function params(){
    const p = new URLSearchParams(location.search);
    return { v: p.get("v") };
}

function shuffleArray(arr){
    for(let i=arr.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]]=[arr[j],arr[i]];
    }
    return arr;
}

/* --------- Ads Implementation ---------- */
function renderTopBannerAd(){
    topAdSlot.innerHTML = "";
    const s1 = document.createElement("script");
    s1.type = "text/javascript";
    s1.innerHTML = `atOptions = {'key' : 'b40d9ebf8b9bb68f80451819ab41596e','format' : 'iframe','height' : 90,'width' : 728,'params' : {}};`;
    const s2 = document.createElement("script");
    s2.src = "https://stinkymildred.com/b40d9ebf8b9bb68f80451819ab41596e/invoke.js";
    topAdSlot.appendChild(s1);
    topAdSlot.appendChild(s2);
}

function renderNativeAd(){
    nativeAdSlot.innerHTML = "";
    const s = document.createElement("script");
    s.async = true;
    s.setAttribute("data-cfasync","false");
    s.src = "https://stinkymildred.com/2095e01c6ff1562d16722ad413d6a9ba/invoke.js";
    const container = document.createElement("div");
    container.id = "container-2095e01c6ff1562d16722ad413d6a9ba";
    nativeAdSlot.appendChild(s);
    nativeAdSlot.appendChild(container);
}

function renderBanner300(){
    const s1 = document.createElement("script");
    s1.type = "text/javascript";
    s1.innerHTML = `atOptions = {'key' : 'e8550078b37b6bf29c9b54eed61806f7','format' : 'iframe','height' : 250,'width' : 300,'params' : {}};`;
    const s2 = document.createElement("script");
    s2.src = "https://stinkymildred.com/e8550078b37b6bf29c9b54eed61806f7/invoke.js";
    return [s1, s2];
}

/* --------- Popunder (3rd Video Check) ---------- */
const PLAY_COUNT_KEY = "clp_count";
function onVideoPlayed(){
    let count = parseInt(sessionStorage.getItem(PLAY_COUNT_KEY) || "0", 10);
    count += 1;
    sessionStorage.setItem(PLAY_COUNT_KEY, String(count));
    
    if(count % 3 === 0){
        popunderReady = true;
        popFired = false;
    }
}

/* --------- Load Data & Video ---------- */
async function loadData(){
    try {
        const r = await fetch(DATA_URL,{cache:"no-store"});
        const raw = await r.json();
        if(!Array.isArray(raw) || !raw.length) return;
        
        raw.forEach(v => videos[v.videoid] = v);
        
        const { v } = params();
        const id = v && videos[v] ? v : Object.keys(videos)[0];
        loadVideo(id);
    } catch(e) { console.error("Data Load Failed", e); }
}

function loadVideo(id){
    const v = videos[id];
    if(!v) return;

    // ðŸ”¥ BYSE EMBED LOGIC
    iframe.src = "https://byse.sx/e/" + v.streamtape_id;

    mainTitle.textContent = v.title || "Untitled Video";
    creatorNameEl.textContent = v.creator || "Clipfy Creator";
    timeAgoEl.textContent = v.timeago || "Posted recently";
    viewsEl.textContent = (v.views || Math.floor(Math.random() * 50000)).toLocaleString();
    likesEl.textContent = (v.likes || Math.floor(Math.random() * 500)).toLocaleString();

    if(v.creator_dp) creatorDp.style.backgroundImage = `url(${v.creator_dp})`;
    else creatorDp.style.backgroundImage = "none";

    document.title = (v.title || "Video") + " | Clipfy";
    history.replaceState(null, "", `?v=${id}`);

    renderTopBannerAd();
    renderNativeAd();
    onVideoPlayed();
    renderSuggestions(id);
}

/* --------- Suggestions Rendering ---------- */
function renderSuggestions(currentId){
    suggestions.innerHTML = "";
    let ids = Object.keys(videos).filter(id => id !== currentId);
    ids = shuffleArray(ids);

    ids.forEach((id, index) => {
        // ðŸ”¥ Insert 300x250 Banner at 4th slot
        if (index === 3) {
            const adContainer = document.createElement("div");
            adContainer.className = "ad-300-player";
            const [s1, s2] = renderBanner300();
            adContainer.appendChild(s1);
            adContainer.appendChild(s2);
            suggestions.appendChild(adContainer);
        }

        const v = videos[id];
        const item = document.createElement("div");
        item.className = "suggestion-item";
        item.innerHTML = `
            <div class="suggestion-thumbnail">
                <img loading="lazy" src="${v.thumb || ''}" onerror="this.src='https://via.placeholder.com/640x360/12182e/8b93b0?text=No+Thumbnail'">
            </div>
            <div class="suggestion-title">${v.title || "Untitled"}</div>
        `;
        
        item.onclick = () => {
            // ðŸ”¥ Popunder Logic Execution
            if(popunderReady && !popFired){
                popFired = true;
                const popScript = document.createElement("script");
                popScript.src = "https://stinkymildred.com/ca/e0/e6/cae0e6616497151a47e216bf81ebf050.js";
                document.body.appendChild(popScript);
            }
            loadVideo(id);
            window.scrollTo({top: 0, behavior: 'smooth'});
        };
        
        suggestions.appendChild(item);
    });
}

// Back Button Sync
window.onpopstate = () => {
    const { v } = params();
    if(v && videos[v]) loadVideo(v);
};

loadData();
</script>
</body>
</html>
