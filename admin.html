<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Clipfy Admin Panel Pro</title>

<style>
:root{
  --bg:#0f141a;--card:#12182e;--text:#fff;--muted:#8b93b0;
  --accent:#ff2f5b;--success:#10b981;--warning:#f59e0b;
  --danger:#ef4444;--hover:#1a2139;--border:#2a3449;--blue:#3b82f6;
}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font-family:Arial,sans-serif;font-size:14px}

header{background:var(--card);padding:16px;border-bottom:2px solid var(--accent);position:sticky;top:0;z-index:100}
.header-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.logo{font-size:22px;font-weight:900;color:var(--accent)}
.user-info{font-size:12px;color:var(--muted);display:flex;gap:10px;align-items:center}
.header-bottom{display:flex;gap:10px;flex-wrap:wrap;align-items:center}

.container{padding:20px;max-width:1600px;margin:auto}

.btn{padding:8px 14px;border:none;border-radius:6px;cursor:pointer;font-weight:500;transition:all .2s}
.btn-small{padding:4px 10px;font-size:12px}
.btn-success{background:var(--success);color:#fff}
.btn-danger{background:var(--danger);color:#fff}
.btn-warning{background:var(--warning);color:#000}
.btn-accent{background:var(--accent);color:#fff}
.btn-blue{background:var(--blue);color:#fff}
.btn:hover{opacity:.9;transform:translateY(-1px)}
.btn:disabled{opacity:.5;cursor:not-allowed;transform:none}

table{width:100%;border-collapse:collapse;margin:20px 0}
th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left}
th{background:var(--hover);font-weight:600}
tr:hover{background:var(--hover)}

.status-live{color:var(--success);font-weight:500}
.status-offline{color:var(--warning);font-weight:500}

.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.9);z-index:200;align-items:center;justify-content:center;padding:20px}
.modal-box{background:var(--card);padding:20px;border-radius:12px;width:min(90vw,500px);max-height:90vh;overflow-y:auto;border:1px solid var(--accent)}
.modal-box h3{margin-bottom:12px;color:var(--accent)}
.modal-box input,select,textarea{width:100%;padding:10px;margin:6px 0;border:1px solid var(--border);border-radius:6px;background:var(--hover);color:var(--text)}
.modal-box textarea{min-height:100px;resize:vertical}

.search-filter{display:flex;gap:10px;margin:16px 0;flex-wrap:wrap;align-items:center}
.search-box{padding:8px;width:260px;border-radius:6px;border:1px solid var(--border);background:var(--hover);color:var(--text)}
.filter-select{padding:8px;min-width:140px;border-radius:6px;border:1px solid var(--border);background:var(--hover);color:var(--text)}

.pagination{display:flex;gap:6px;justify-content:center;margin:14px 0}
.page-btn{padding:6px 10px}

.bulk-actions{display:flex;gap:8px;align-items:center;margin:10px 0;flex-wrap:wrap;font-size:12px;color:var(--muted)}

.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;margin-left:auto}
.stat-card{background:var(--hover);padding:10px 12px;border-radius:8px;text-align:left;border:1px solid var(--border)}
.stat-number{font-size:18px;font-weight:800;color:var(--accent)}
.stat-label{color:var(--muted);font-size:11px}

.thumb-preview{width:70px;height:45px;object-fit:cover;border-radius:4px;cursor:pointer}

.kill-badge{font-size:11px;padding:4px 8px;border-radius:20px;background:#3b1d1d;color:#ffb4b4;border:1px solid #ff4d4d}

.tabs{display:flex;gap:4px;margin:16px 0;border-bottom:2px solid var(--border)}
.tab{padding:10px 20px;cursor:pointer;border-radius:6px 6px 0 0;transition:all .2s}
.tab.active{background:var(--accent);color:#fff}
.tab:not(.active){color:var(--muted)}
.tab:not(.active):hover{background:var(--hover)}

.tab-content{display:none}
.tab-content.active{display:block}

.log-item{padding:8px;margin:4px 0;background:var(--hover);border-radius:4px;font-size:12px;display:flex;justify-content:space-between}
.log-time{color:var(--muted)}

.settings-section{background:var(--hover);padding:16px;border-radius:8px;margin:12px 0}
.settings-section h4{color:var(--accent);margin-bottom:10px}
.setting-row{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border)}
.setting-row:last-child{border-bottom:none}

.badge{font-size:10px;padding:3px 8px;border-radius:12px;font-weight:600}
.badge-success{background:var(--success);color:#000}
.badge-danger{background:var(--danger);color:#fff}

.analytics-card{background:var(--hover);padding:16px;border-radius:8px;margin:10px 0}
.analytics-card h4{color:var(--accent);margin-bottom:8px}

.top-video-item{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border)}
.top-video-item:last-child{border-bottom:none}

.sync-progress{background:var(--hover);padding:20px;border-radius:8px;margin:20px 0;text-align:center}
.sync-progress h3{color:var(--accent);margin-bottom:10px}
</style>
</head>

<body>

<header>
  <div class="header-top">
    <div class="logo">üîß Clipfy Admin Pro</div>
    <div class="user-info">
      <span id="killStatus" class="kill-badge" style="display:none">MAINTENANCE MODE</span>
      <span id="currentUser">Guest</span>
      <button class="btn btn-small btn-accent" onclick="logout()">Logout</button>
    </div>
  </div>
  <div class="header-bottom">
    <button class="btn btn-success" onclick="refresh()">üîÑ Refresh</button>
    <button class="btn btn-blue" onclick="syncByse()">üì° Sync Byse</button>
    <button class="btn btn-accent" onclick="openVideoModal('add')">‚ûï Add Video</button>
    <button class="btn btn-warning" onclick="toggleBulkBar()">‚ö° Bulk</button>
    <button class="btn btn-danger" onclick="toggleKillSwitch()">üö® Maintenance</button>

    <div class="stats-grid" id="stats"></div>
  </div>
</header>

<div class="container" id="mainContainer">
  <div class="tabs">
    <div class="tab active" onclick="switchTab('videos',event)">üé¨ Videos</div>
    <div class="tab" onclick="switchTab('analytics',event)">üìä Analytics</div>
    <div class="tab" onclick="switchTab('settings',event)">‚öôÔ∏è Settings</div>
    <div class="tab" onclick="switchTab('reports',event)">üö© Reports</div>
    <div class="tab" onclick="switchTab('logs',event)">üìã Logs</div>
  </div>

  <!-- VIDEOS TAB -->
  <div class="tab-content active" id="tab-videos">
    <div class="search-filter">
      <input id="searchInput" class="search-box" placeholder="üîç Search by title or ID..." oninput="applyFilters()">
      <select id="statusFilter" class="filter-select" onchange="applyFilters()">
        <option value="all">All Status</option>
        <option value="live">Live only</option>
        <option value="offline">Offline only</option>
      </select>
      <select id="sortFilter" class="filter-select" onchange="applyFilters()">
        <option value="recent">Recent first</option>
        <option value="title">Title A-Z</option>
        <option value="views">Most views</option>
      </select>
      <button class="btn btn-small btn-blue" onclick="exportCSV()">üì• Export CSV</button>
    </div>

    <div class="bulk-actions" id="bulkBar" style="display:none">
      <label><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"> Select all (page)</label>
      <button class="btn btn-small btn-warning" onclick="bulkOffline()">Bulk Offline</button>
      <button class="btn btn-small btn-success" onclick="bulkOnline()">Bulk Online</button>
      <button class="btn btn-small btn-danger" onclick="bulkDelete()">Bulk Delete</button>
      <span id="selectedCount">0 selected</span>
    </div>

    <table>
      <thead>
        <tr>
          <th></th>
          <th>#</th>
          <th>Thumb</th>
          <th>Title</th>
          <th>ID</th>
          <th>Views</th>
          <th>Status</th>
          <th>Date</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td colspan="9">Loading...</td></tr>
      </tbody>
    </table>

    <div class="pagination" id="pagination"></div>
  </div>

  <!-- ANALYTICS TAB -->
  <div class="tab-content" id="tab-analytics">
    <h3>Analytics Dashboard</h3>

    <div class="analytics-card">
      <h4>Total Views</h4>
      <div id="totalViews" style="font-size:32px;font-weight:800;color:var(--accent)">0</div>
      <p style="color:var(--muted);font-size:12px">Across all videos</p>
    </div>

    <div class="analytics-card">
      <h4>Top 10 Videos</h4>
      <div id="topVideos"></div>
    </div>

    <div class="analytics-card">
      <h4>Recent Activity</h4>
      <div id="recentActivity"></div>
    </div>
  </div>

  <!-- SETTINGS TAB -->
  <div class="tab-content" id="tab-settings">
    <h3>System Settings</h3>

    <div class="settings-section">
      <h4>Storage Settings</h4>
      <div class="setting-row">
        <span>R2 Bucket</span>
        <span class="badge badge-success" id="r2Status">Connected</span>
      </div>
      <div class="setting-row">
        <span>Total Videos</span>
        <span id="totalVideosCount">0</span>
      </div>
      <button class="btn btn-small btn-warning" onclick="clearCache()">Clear Cache</button>
    </div>

    <div class="settings-section">
      <h4>API Configuration</h4>
      <div class="setting-row">
        <span>Byse API Key</span>
        <input type="password" id="byseKey" placeholder="API Key (local only)" style="width:200px;margin:0">
      </div>
      <button class="btn btn-small btn-success" onclick="saveAPIConfig()">Save Config</button>
    </div>

    <div class="settings-section">
      <h4>Backup & Restore</h4>
      <button class="btn btn-blue" onclick="backupData()">üì• Download Backup</button>
    </div>

    <div class="settings-section">
      <h4>Danger Zone</h4>
      <button class="btn btn-danger" onclick="deleteAllOffline()">Delete All Offline Videos</button>
      <button class="btn btn-danger" onclick="resetDatabase()">Reset Database</button>
    </div>
  </div>

  <!-- REPORTS TAB -->
  <div class="tab-content" id="tab-reports">
    <h3>Video Reports</h3>
    <div style="margin:10px 0">
      <button class="btn btn-small btn-blue" onclick="loadReports()">üîÑ Refresh Reports</button>
      <button class="btn btn-small btn-warning" onclick="filterReportsByStatus('pending')">Pending</button>
      <button class="btn btn-small btn-success" onclick="filterReportsByStatus('resolved')">Resolved</button>
      <button class="btn btn-small btn-accent" onclick="filterReportsByStatus('all')">All</button>
    </div>
    <table>
      <thead>
        <tr>
          <th>Video ID</th>
          <th>Title</th>
          <th>Reported</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="reportsTbody">
        <tr><td colspan="5">Loading reports...</td></tr>
      </tbody>
    </table>
  </div>

  <!-- LOGS TAB -->
  <div class="tab-content" id="tab-logs">
    <h3>Activity Logs</h3>
    <p style="font-size:12px;color:var(--muted);margin-bottom:8px">
      Local logs stored in browser
    </p>
    <div style="margin:10px 0">
      <select id="logFilter" class="filter-select" onchange="filterLogs()">
        <option value="all">All Actions</option>
        <option value="save">Save/Edit</option>
        <option value="delete">Delete</option>
        <option value="sync">Sync</option>
        <option value="killswitch">Maintenance</option>
      </select>
      <button class="btn btn-small btn-warning" onclick="clearLogs()">Clear Logs</button>
      <button class="btn btn-small btn-blue" onclick="exportLogs()">Export Logs</button>
    </div>
    <div id="logsList"></div>
  </div>
</div>

<!-- LOGIN MODAL -->
<div class="modal" id="loginModal">
  <div class="modal-box">
    <h3>Admin Login</h3>
    <input id="login_user" placeholder="Username">
    <input id="login_pass" type="password" placeholder="Password">
    <button class="btn btn-success" onclick="doLogin()" style="margin-top:8px">Login</button>
  </div>
</div>

<!-- ADD/EDIT VIDEO MODAL -->
<div class="modal" id="videoModal">
  <div class="modal-box">
    <h3 id="videoModalTitle">Add Video</h3>
    <input id="vid" placeholder="Video ID (unique)">
    <input id="vtitle" placeholder="Title">
    <textarea id="vdesc" placeholder="Description (optional)"></textarea>
    <input id="vthumb" placeholder="Thumbnail URL">
    <input id="vstream" placeholder="Byse File Code">
    <input id="vviews" type="number" placeholder="Views" value="0">
    <select id="vstatus">
      <option value="live">Live</option>
      <option value="offline">Offline</option>
    </select>
    <div style="margin-top:10px">
      <button class="btn btn-success" onclick="saveVideo()">Save</button>
      <button class="btn btn-danger" onclick="closeAllModals()">Cancel</button>
    </div>
  </div>
</div>

<!-- THUMB MODAL -->
<div class="modal" id="thumbModal">
  <div class="modal-box">
    <h3>Thumbnail Control</h3>
    <img id="thumbPrev" style="width:100%;border-radius:8px;margin-bottom:8px">
    <input id="thumbNew" placeholder="New thumbnail URL">
    <div style="margin-top:8px">
      <button class="btn btn-success" onclick="saveThumb()">Save Thumbnail</button>
      <button class="btn btn-danger" onclick="closeAllModals()">Close</button>
    </div>
  </div>
</div>

<!-- CONFIRM MODAL -->
<div class="modal" id="confirmModal">
  <div class="modal-box">
    <h3 id="confirmTitle">Confirm</h3>
    <p id="confirmText" style="margin:10px 0"></p>
    <button class="btn btn-danger" id="confirmBtn">Confirm</button>
    <button class="btn btn-success" onclick="closeAllModals()">Cancel</button>
  </div>
</div>

<script>
const API = "https://clipfy.store/api";

let ADMIN_TOKEN = localStorage.getItem("clipfy_admin_token");
let CURRENT_USER = localStorage.getItem("clipfy_admin_user") || "Guest";
let videos = [];
let filtered = [];
let selected = new Set();
let currentPage = 1;
const PER_PAGE = 50;
let editingId = null;
let currentThumbId = null;
let siteDisabled = false;
let logs = [];

/* ============ AUTH ============ */

async function doLogin(){
  const u = document.getElementById("login_user").value.trim();
  const p = document.getElementById("login_pass").value.trim();
  if (!u || !p) return alert("Enter username & password");
  const r = await fetch(API + "/auth/login",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({username:u,password:p})
  });
  const data = await r.json();
  if (!data.token){
    alert("Login failed");
    return;
  }
  ADMIN_TOKEN = data.token;
  CURRENT_USER = data.user || u;
  localStorage.setItem("clipfy_admin_token",ADMIN_TOKEN);
  localStorage.setItem("clipfy_admin_user",CURRENT_USER);
  document.getElementById("currentUser").textContent = CURRENT_USER;
  document.getElementById("loginModal").style.display = "none";
  init();
}

function logout(){
  localStorage.removeItem("clipfy_admin_token");
  localStorage.removeItem("clipfy_admin_user");
  ADMIN_TOKEN = null;
  CURRENT_USER = "Guest";
  location.reload();
}

/* ============ TABS ============ */

function switchTab(tab,ev){
  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  document.querySelectorAll(".tab-content").forEach(c=>c.classList.remove("active"));
  if (ev && ev.target) ev.target.classList.add("active");
  document.getElementById("tab-"+tab).classList.add("active");
  if (tab==="analytics") updateAnalytics();
  if (tab==="reports") loadReports();
  if (tab==="logs") loadLogs();
}

/* ============ STATUS / KILL SWITCH ============ */

async function fetchStatus(){
  try{
    const r = await fetch(API + "/status");
    const s = await r.json();
    siteDisabled = !!s.site_disabled;
    updateKillBadge();
  }catch(e){
    console.error(e);
  }
}

function updateKillBadge(){
  const el = document.getElementById("killStatus");
  el.style.display = siteDisabled ? "inline-block" : "none";
}

async function toggleKillSwitch(){
  if (!ADMIN_TOKEN) return alert("Login first");
  const wantOff = !siteDisabled;
  const r = await fetch(API + "/killswitch",{
    method:"POST",
    headers:{
      "Authorization":ADMIN_TOKEN,
      "Content-Type":"application/json"
    },
    body:JSON.stringify({disabled:wantOff})
  });
  const data = await r.json();
  siteDisabled = wantOff;
  updateKillBadge();
  addLog("killswitch",wantOff ? "Site disabled" : "Site enabled");
  if (siteDisabled){
    document.getElementById("mainContainer").innerHTML = `
      <div style="text-align:center;padding:60px">
        <h2>Maintenance Mode</h2>
        <p>Site is disabled. Toggle again to restore.</p>
      </div>
    `;
  } else {
    location.reload();
  }
}

/* ============ DATA LOAD ============ */

async function loadVideos(){
  if (!ADMIN_TOKEN){
    document.getElementById("loginModal").style.display = "flex";
    return;
  }
  const r = await fetch(API + "/videos",{
    headers:{Authorization:ADMIN_TOKEN}
  });
  const data = await r.json();
  if (!Array.isArray(data)){
    alert("Failed to load videos");
    return;
  }
  videos = data;
  applyFilters();
  updateStats();
}

function updateStats(){
  const total = videos.length;
  const live = videos.filter(v=>!v.offline).length;
  const offline = total - live;
  const totalViews = videos.reduce((sum,v)=>sum + (v.views||0),0);
  document.getElementById("stats").innerHTML = `
    <div class="stat-card">
      <div class="stat-number">${total}</div>
      <div class="stat-label">Total videos</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" style="color:var(--success)">${live}</div>
      <div class="stat-label">Live</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" style="color:var(--warning)">${offline}</div>
      <div class="stat-label">Offline</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" style="color:var(--blue)">${totalViews.toLocaleString()}</div>
      <div class="stat-label">Total Views</div>
    </div>
  `;
  
  document.getElementById("totalVideosCount").textContent = total;
}

/* ============ FILTER & PAGINATION ============ */

function applyFilters(){
  const q = document.getElementById("searchInput").value.toLowerCase();
  const status = document.getElementById("statusFilter").value;
  const sort = document.getElementById("sortFilter").value;
  filtered = videos.filter(v=>{
    const matchQ = !q || (v.title||"").toLowerCase().includes(q) || (v.videoid||"").toLowerCase().includes(q);
    const matchStatus =
      status==="all" ||
      (status==="live" && !v.offline) ||
      (status==="offline" && v.offline);
    return matchQ && matchStatus;
  });

  filtered.sort((a,b)=>{
    if (sort==="title") return (a.title||"").localeCompare(b.title||"");
    if (sort==="views") return (b.views||0)-(a.views||0);
    return new Date(b.date||0) - new Date(a.date||0);
  });

  currentPage = 1;
  renderTable();
}

function renderTable(){
  const tb = document.getElementById("tbody");
  if (!filtered.length){
    tb.innerHTML = `<tr><td colspan="9">No videos</td></tr>`;
    document.getElementById("pagination").innerHTML = "";
    return;
  }
  const start = (currentPage-1)*PER_PAGE;
  const pageItems = filtered.slice(start,start+PER_PAGE);
  tb.innerHTML = pageItems.map((v,idx)=>`
    <tr>
      <td><input type="checkbox" value="${v.videoid}" ${selected.has(v.videoid)?"checked":""} onchange="toggleSelect('${v.videoid}',this.checked)"></td>
      <td>${start+idx+1}</td>
      <td><img src="${v.thumb||""}" class="thumb-preview" onclick="openThumb('${v.videoid}')" onerror="this.src='data:image/svg+xml,%3Csvg xmlns%3D%22http://www.w3.org/2000/svg%22 width%3D%22120%22 height%3D%2290%22%3E%3Crect fill%3D%22222333%22 width%3D%22120%22 height%3D%2290%22/%3E%3Ctext x%3D%2260%22 y%3D%2245%22 fill%3D%22999%22 text-anchor%3D%22middle%22 dy%3D%22.3em%22 font-size%3D%2212%22%3ENo Img%3C/text%3E%3C/svg%3E'"></td>
      <td ondblclick="openVideoModal('edit','${v.videoid}','${(v.title||"").replace(/"/g,'&quot;')}')">${v.title||""}</td>
      <td>${v.videoid}</td>
      <td>${v.views||0}</td>
      <td class="${v.offline?'status-offline':'status-live'}">${v.offline?'Offline':'Live'}</td>
      <td style="font-size:11px;color:var(--muted)">${v.date ? new Date(v.date).toLocaleDateString() : "-"}</td>
      <td>
        <button class="btn btn-small btn-warning" onclick="openVideoModal('edit','${v.videoid}')">Edit</button>
        <button class="btn btn-small btn-danger" onclick="deleteSingle('${v.videoid}')">Del</button>
      </td>
    </tr>
  `).join("");

  renderPagination();
  updateSelectedCount();
}

function renderPagination(){
  const totalPages = Math.ceil(filtered.length / PER_PAGE);
  const pag = document.getElementById("pagination");
  if (totalPages<=1){
    pag.innerHTML = "";
    return;
  }
  let html = "";
  if (currentPage>1){
    html += `<button class="btn page-btn" onclick="changePage(${currentPage-1})">Prev</button>`;
  }
  for (let p=1;p<=totalPages;p++){
    if (Math.abs(p-currentPage)>2 && p!==1 && p!==totalPages) continue;
    html += `<button class="btn page-btn ${p===currentPage?'btn-accent':''}" onclick="changePage(${p})">${p}</button>`;
  }
  if (currentPage<totalPages){
    html += `<button class="btn page-btn" onclick="changePage(${currentPage+1})">Next</button>`;
  }
  pag.innerHTML = html;
}

function changePage(p){
  const totalPages = Math.ceil(filtered.length / PER_PAGE);
  if (p<1 || p>totalPages) return;
  currentPage = p;
  renderTable();
}

/* ============ BULK SELECT ============ */

function toggleSelect(id,checked){
  if (checked) selected.add(id);
  else selected.delete(id);
  updateSelectedCount();
}

function toggleSelectAll(){
  const cb = document.getElementById("selectAll");
  const start = (currentPage-1)*PER_PAGE;
  const pageItems = filtered.slice(start,start+PER_PAGE);
  if (cb.checked){
    pageItems.forEach(v=>selected.add(v.videoid));
  } else {
    pageItems.forEach(v=>selected.delete(v.videoid));
  }
  renderTable();
}

function updateSelectedCount(){
  document.getElementById("selectedCount").textContent = `${selected.size} selected`;
}

function toggleBulkBar(){
  const bar = document.getElementById("bulkBar");
  bar.style.display = (bar.style.display==="none" || !bar.style.display) ? "flex" : "none";
}

/* ============ BULK ACTIONS ============ */

async function bulkOffline(){
  if (!selected.size) return alert("No videos selected");
  if (!confirm("Set selected videos to Offline?")) return;
  await fetch(API + "/admin/bulk/offline",{
    method:"POST",
    headers:{
      Authorization:ADMIN_TOKEN,
      "Content-Type":"application/json"
    },
    body:JSON.stringify({ids:[...selected]})
  });
  videos = videos.map(v=>selected.has(v.videoid)?{...v,offline:true}:v);
  addLog("save",`Bulk offline (${selected.size} videos)`);
  applyFilters();
}

async function bulkOnline(){
  if (!selected.size) return alert("No videos selected");
  if (!confirm("Set selected videos to Live?")) return;
  await fetch(API + "/admin/bulk/online",{
    method:"POST",
    headers:{
      Authorization:ADMIN_TOKEN,
      "Content-Type":"application/json"
    },
    body:JSON.stringify({ids:[...selected]})
  });
  videos = videos.map(v=>selected.has(v.videoid)?{...v,offline:false}:v);
  addLog("save",`Bulk online (${selected.size} videos)`);
  applyFilters();
}

async function bulkDelete(){
  if (!selected.size) return alert("No videos selected");
  if (!confirm("Delete selected videos? This cannot be undone.")) return;
  await fetch(API + "/admin/bulk/delete",{
    method:"POST",
    headers:{
      Authorization:ADMIN_TOKEN,
      "Content-Type":"application/json"
    },
    body:JSON.stringify({ids:[...selected]})
  });
  videos = videos.filter(v=>!selected.has(v.videoid));
  selected.clear();
  addLog("delete","Bulk delete");
  applyFilters();
}

/* ============ SINGLE VIDEO ACTIONS ============ */

function openVideoModal(mode,id){
  const modal = document.getElementById("videoModal");
  document.getElementById("videoModalTitle").textContent = mode==="add" ? "Add Video" : "Edit Video";
  modal.style.display = "flex";
  if (mode==="add"){
    editingId = null;
    document.getElementById("vid").value = "";
    document.getElementById("vtitle").value = "";
    document.getElementById("vdesc").value = "";
    document.getElementById("vthumb").value = "";
    document.getElementById("vstream").value = "";
    document.getElementById("vviews").value = 0;
    document.getElementById("vstatus").value = "live";
  } else {
    editingId = id;
    const v = videos.find(x=>x.videoid===id);
    if (!v) return;
    document.getElementById("vid").value = v.videoid;
    document.getElementById("vtitle").value = v.title||"";
    document.getElementById("vdesc").value = v.desc||"";
    document.getElementById("vthumb").value = v.thumb||"";
    document.getElementById("vstream").value = v.streamtape_id||"";
    document.getElementById("vviews").value = v.views||0;
    document.getElementById("vstatus").value = v.offline?"offline":"live";
  }
}

async function saveVideo(){
  if (!ADMIN_TOKEN) return alert("Login first");
  const body = {
    videoid: document.getElementById("vid").value.trim(),
    title: document.getElementById("vtitle").value.trim(),
    desc: document.getElementById("vdesc").value.trim(),
    thumb: document.getElementById("vthumb").value.trim(),
    stream_id: document.getElementById("vstream").value.trim(),
    views: Number(document.getElementById("vviews").value||0),
    offline: document.getElementById("vstatus").value==="offline"
  };
  if (!body.videoid || !body.title) return alert("ID & Title are required");
  const url = API + "/admin/videos" + (editingId?"/"+encodeURIComponent(editingId):"");
  const method = editingId ? "PUT" : "POST";
  const r = await fetch(url,{
    method,
    headers:{
      Authorization:ADMIN_TOKEN,
      "Content-Type":"application/json"
    },
    body:JSON.stringify(body)
  });
  const data = await r.json();
  if (!data || data.error){
    alert("Save failed: "+(data.error||"Unknown"));
    return;
  }
  if (editingId){
    videos = videos.map(v=>v.videoid===editingId?data:v);
    addLog("save","Edited video "+editingId);
  } else {
    videos.unshift(data);
    addLog("save","Added video "+body.videoid);
  }
  closeAllModals();
  applyFilters();
}

function deleteSingle(id){
  document.getElementById("confirmTitle").textContent = "Delete Video";
  document.getElementById("confirmText").textContent = "Are you sure you want to delete "+id+" ?";
  const btn = document.getElementById("confirmBtn");
  btn.onclick = ()=>confirmDeleteSingle(id);
  document.getElementById("confirmModal").style.display = "flex";
}

async function confirmDeleteSingle(id){
  if (!ADMIN_TOKEN) return alert("Login first");
  await fetch(API + "/admin/videos/"+encodeURIComponent(id),{
    method:"DELETE",
    headers:{Authorization:ADMIN_TOKEN}
  });
  videos = videos.filter(v=>v.videoid!==id);
  selected.delete(id);
  addLog("delete","Deleted video "+id);
  closeAllModals();
  applyFilters();
}

/* ============ THUMBNAIL CONTROL ============ */

function openThumb(id){
  currentThumbId = id;
  const v = videos.find(x=>x.videoid===id);
  if (!v) return;
  document.getElementById("thumbPrev").src = v.thumb||"";
  document.getElementById("thumbNew").value = v.thumb||"";
  document.getElementById("thumbModal").style.display = "flex";
}

async function saveThumb(){
  if (!currentThumbId) return;
  const v = videos.find(x=>x.videoid===currentThumbId);
  if (!v) return;
  const url = document.getElementById("thumbNew").value.trim();
  if (!url) return alert("Enter thumbnail URL");
  if (!ADMIN_TOKEN) return alert("Login first");
  const r = await fetch(API + "/admin/videos/"+encodeURIComponent(currentThumbId),{
    method:"PUT",
    headers:{
      Authorization:ADMIN_TOKEN,
      "Content-Type":"application/json"
    },
    body:JSON.stringify({...v,thumb:url})
  });
  const data = await r.json();
  if (!data || data.error){
    alert("Save failed: "+(data.error||"Unknown"));
    return;
  }
  videos = videos.map(x=>x.videoid===currentThumbId?data:x);
  addLog("save","Updated thumb "+currentThumbId);
  applyFilters();
  closeAllModals();
}

/* ============ BYSE SYNC ============ */

async function syncByse(){
  if (!ADMIN_TOKEN) return alert("Login first");

  if (!confirm("Sync all new videos from Byse?")) return;

  const mainContainer = document.getElementById("mainContainer");
  mainContainer.innerHTML = `
    <div class="sync-progress">
      <h3>üîÑ Syncing from Byse...</h3>
      <p style="color:var(--muted);margin:10px 0">This may take a while. Please wait...</p>
      <div style="margin:20px 0">
        <div style="width:100%;height:8px;background:var(--hover);border-radius:4px;overflow:hidden">
          <div style="width:100%;height:100%;background:var(--accent);animation:pulse 1.5s infinite"></div>
        </div>
      </div>
    </div>
  `;

  try {
    const r = await fetch(API + "/admin/byse/sync", {
      method: "POST",
      headers: {
        Authorization: ADMIN_TOKEN
      }
    });

    const data = await r.json();

    if (!data.ok) {
      alert("Sync failed: " + (data.error || "Unknown"));
      location.reload();
      return;
    }

    alert(`‚úÖ Sync Complete!

New videos added: ${data.added}
Total videos: ${data.total}`);

    addLog("sync", `Byse sync added ${data.added}`);
    location.reload();
  } catch (e) {
    alert("Sync error: " + e.message);
    location.reload();
  }
}

/* ============ ANALYTICS ============ */

function updateAnalytics(){
  const totalViews = videos.reduce((sum,v)=>sum + (v.views||0),0);
  document.getElementById("totalViews").textContent = totalViews.toLocaleString();
  const top = [...videos].sort((a,b)=>(b.views||0)-(a.views||0)).slice(0,10);
  const topDiv = document.getElementById("topVideos");
  if (!top.length){
    topDiv.innerHTML = "<p style='color:var(--muted);font-size:12px'>No data</p>";
  } else {
    topDiv.innerHTML = top.map(v=>`
      <div class="top-video-item">
        <span>${v.title||""} (${v.videoid})</span>
        <span>${(v.views||0).toLocaleString()} views</span>
      </div>
    `).join("");
  }
  const recentDiv = document.getElementById("recentActivity");
  if (!logs.length){
    recentDiv.innerHTML = "<p style='color:var(--muted);font-size:12px'>No activity</p>";
  } else {
    recentDiv.innerHTML = logs.slice(-10).reverse().map(l=>`
      <div class="log-item">
        <span>${l.action} - ${l.note}</span>
        <span class="log-time">${new Date(l.time).toLocaleString()}</span>
      </div>
    `).join("");
  }
}

/* ============ SETTINGS ============ */

async function clearCache(){
  if (!ADMIN_TOKEN) return alert("Login first");
  if (!confirm("Clear cache?")) return;
  await fetch(API + "/admin/cache/clear",{
    method:"POST",
    headers:{Authorization:ADMIN_TOKEN}
  }).catch(()=>{});
  alert("Cache cleared");
}

function saveAPIConfig(){
  const key = document.getElementById("byseKey").value.trim();
  localStorage.setItem("clipfy_byse_key",key);
  alert("Saved locally (use server env for real key)");
}

async function backupData(){
  if (!ADMIN_TOKEN) return alert("Login first");
  const blob = new Blob([JSON.stringify(videos,null,2)],{type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "clipfy-backup.json";
  a.click();
  URL.revokeObjectURL(url);
}

async function deleteAllOffline(){
  if (!ADMIN_TOKEN) return alert("Login first");
  if (!confirm("Delete ALL offline videos? This cannot be undone.")) return;
  await fetch(API + "/admin/offline/delete-all",{
    method:"POST",
    headers:{Authorization:ADMIN_TOKEN}
  }).catch(()=>{});
  videos = videos.filter(v=>!v.offline);
  applyFilters();
  addLog("delete","Deleted all offline");
}

async function resetDatabase(){
  if (!ADMIN_TOKEN) return alert("Login first");
  if (!confirm("Reset entire database? This is VERY dangerous.")) return;
  await fetch(API + "/admin/reset",{
    method:"POST",
    headers:{Authorization:ADMIN_TOKEN}
  }).catch(()=>{});
  videos = [];
  applyFilters();
  addLog("delete","Database reset");
}

/* ============ LOGS ============ */

function addLog(action,note){
  const item = {action,note,time:Date.now()};
  logs.push(item);
  localStorage.setItem("clipfy_admin_logs",JSON.stringify(logs));
}

function loadLogs(){
  const saved = localStorage.getItem("clipfy_admin_logs");
  if (saved && !logs.length){
    try{logs = JSON.parse(saved)||[]}catch(e){logs=[];}
  }
  renderLogs();
}

function renderLogs(){
  const filter = document.getElementById("logFilter").value;
  const list = document.getElementById("logsList");
  const arr = logs.filter(l=>filter==="all" || l.action===filter);
  if (!arr.length){
    list.innerHTML = "<p style='color:var(--muted);font-size:12px'>No logs</p>";
    return;
  }
  list.innerHTML = arr.slice().reverse().map(l=>`
    <div class="log-item">
      <span>[${l.action}] ${l.note}</span>
      <span class="log-time">${new Date(l.time).toLocaleString()}</span>
    </div>
  `).join("");
}

function filterLogs(){
  renderLogs();
}

function clearLogs(){
  if (!confirm("Clear all logs?")) return;
  logs = [];
  localStorage.removeItem("clipfy_admin_logs");
  renderLogs();
}

function exportLogs(){
  const blob = new Blob([JSON.stringify(logs,null,2)],{type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "clipfy-logs.json";
  a.click();
  URL.revokeObjectURL(url);
}

/* ============ CSV EXPORT ============ */

function exportCSV(){
  if (!videos.length) return alert("No videos to export");
  const header = ["videoid","title","views","offline","date","thumb","streamtape_id"];
  const rows = videos.map(v=>[
    v.videoid,
    (v.title||"").replace(/"/g,'""'),
    v.views||0,
    v.offline?"1":"0",
    v.date||"",
    v.thumb||"",
    v.streamtape_id||""
  ]);
  const csv = [header.join(",")].concat(
    rows.map(r=>r.map(x=>`"${String(x)}"`).join(","))
  ).join("\n");
  const blob = new Blob([csv],{type:"text/csv"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "clipfy-videos.csv";
  a.click();
  URL.revokeObjectURL(url);
}

/* ============ MISC ============ */

function closeAllModals(){
  document.querySelectorAll(".modal").forEach(m=>m.style.display="none");
}

function refresh(){
  loadVideos();
  fetchStatus();
}

/* ============ INIT ============ */

function init(){
  document.getElementById("currentUser").textContent = CURRENT_USER;
  fetchStatus();
  loadVideos();
  loadLogs();

  const savedKey = localStorage.getItem("clipfy_byse_key");
  if (savedKey) document.getElementById("byseKey").value = savedKey;
}

window.addEventListener("click",e=>{
  document.querySelectorAll(".modal").forEach(m=>{
    if (e.target===m) m.style.display="none";
  });
});

window.addEventListener("load",()=>{
  if (!ADMIN_TOKEN){
    document.getElementById("loginModal").style.display = "flex";
  } else {
    init();
  }
});


/* ===== REPORTS SYSTEM ===== */
let allReports = [];
let reportFilter = "all";

async function loadReports(){
  try {
    const r = await fetch(API + "/reports", {
      headers: { "Authorization": ADMIN_TOKEN }
    });
    const data = await r.json();
    allReports = data.reports || [];
    renderReports(allReports);
  } catch(e) {
    console.error("Load reports failed:", e);
    document.getElementById("reportsTbody").innerHTML = "<tr><td colspan='5'>Failed to load reports</td></tr>";
  }
}

function filterReportsByStatus(status) {
  reportFilter = status;
  const filtered = status === "all" ? allReports : allReports.filter(r => r.status === status);
  renderReports(filtered);
}

function renderReports(reports) {
  const tbody = document.getElementById("reportsTbody");
  if (reports.length === 0) {
    tbody.innerHTML = "<tr><td colspan='5' style='text-align:center;padding:20px'>No reports</td></tr>";
    return;
  }
  
  tbody.innerHTML = reports.map((r, i) => {
    const date = new Date(r.timestamp);
    const timeStr = date.toLocaleString();
    const statusBadge = r.status === "pending" ? '<span class="badge badge-danger">Pending</span>' : '<span class="badge badge-success">Resolved</span>';
    
    return `<tr>
      <td style="font-family:monospace;font-size:11px">${r.videoid}</td>
      <td>${r.title.substring(0, 40)}</td>
      <td style="font-size:11px">${timeStr}</td>
      <td>${statusBadge}</td>
      <td>
        <button class="btn btn-small btn-danger" onclick="deleteReportedVideo('${r.videoid}')">Delete</button>
        <button class="btn btn-small btn-success" onclick="markResolved('${r.videoid}')">Resolve</button>
      </td>
    </tr>`;
  }).join("");
}

async function deleteReportedVideo(videoid) {
  if (!ADMIN_TOKEN) return alert("Login required");
  if (!confirm(`Delete video ${videoid}?`)) return;
  
  try {
    const r = await fetch(API + `/admin/videos/${videoid}`, {
      method: "DELETE",
      headers: { "Authorization": ADMIN_TOKEN }
    });
    if (!r.ok) throw new Error("Delete failed");
    alert("‚úÖ Video deleted");
    loadReports();
    loadVideos();
  } catch(e) {
    alert("Delete error: " + e.message);
  }
}

async function markResolved(videoid) {
  if (!ADMIN_TOKEN) return alert("Login required");
  try {
    const r = await fetch(API + "/admin/reports/resolve", {
      method: "POST",
      headers: { 
        "Authorization": ADMIN_TOKEN,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ videoid })
    });
    if (!r.ok) throw new Error("Resolve failed");
    loadReports();
  } catch(e) {
    console.error("Mark resolved error:", e);
  }
}

</script>

<style>
@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}
</style>

</body>
</html>
