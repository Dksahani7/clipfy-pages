<!doctype html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>{{TITLE}} | Clipfy Player</title>

<meta property="og:title" content="{{TITLE}}">
<meta property="og:description" content="{{DESCRIPTION}}">
<meta property="og:type" content="video.other">

<meta property="og:image" content="{{THUMB_URL}}">
<meta name="twitter:image" content="{{THUMB_URL}}">
<meta name="twitter:card" content="summary_large_image">

<style>
    body{
      background:#0f141a;
      color:#fff;
      font-family:Arial, sans-serif;
      margin:0;
      padding:0;
      overflow-x:hidden;
    }
    .video-box{
      width:100%;
      height:40vh;
      position:fixed;
      top:0;
      left:0;
      background:#000;
      overflow:hidden;
      z-index:9999;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .video-box video{
      width:100%;
      height:100%;
      object-fit:contain;
    }
    .floating-ad-320x50{
      position:fixed;
      top:4px;
      left:50%;
      transform:translateX(-50%);
      z-index:10000;
      width:320px;
      max-width:95%;
      height:50px;
      pointer-events:auto;
    }
    .content-wrapper{ padding-top:40vh; min-height:200vh; }
    .top-thin-ad{ background:#1a2430; padding:6px 0; margin:0; text-align:center; border-bottom:1px solid #222; }
    .top-thin-ad-inner{ width:728px; max-width:95%; height:90px; margin:0 auto; }
    .post{ padding:10px 16px; display:flex; gap:10px; align-items:center; border-bottom:1px solid #222; }
    .dp{ width:42px; height:42px; border-radius:50%; background:#555; }
    #creatorName{ font-weight:600; font-size:15px; }
    #timeAgo{ font-size:12px; color:#aaa; margin-top:2px; }
    .stats{ display:flex; gap:14px; padding:8px 16px; border-bottom:1px solid #222; font-size:13px; align-items:center; }
    .stat-item{ display:flex; align-items:center; gap:4px; color:#d0d0d0; }
    .stat-icon{ width:14px; height:14px; stroke:#d0d0d0; fill:none; }
    .stats-right{ margin-left:auto; cursor:pointer; font-size:13px; }
    .blog-content{ padding:14px 16px; font-size:15px; line-height:1.5; }
    #mainTitle{ margin:0 0 6px 0; font-size:18px; font-weight:600; }
    .suggestions-header{ padding:10px 16px; font-size:16px; font-weight:700; border-top:1px solid #222; }
    .video-suggestions-list{ background:transparent; }
    .suggestion-item{ display:block; width:100%; padding:10px 16px 14px; cursor:pointer; border-bottom:1px solid #1a2430; transition:background .12s; }
    .suggestion-item:hover{ background:#0b1216; }
    .suggestion-thumbnail{ width:100%; aspect-ratio:16/9; background:#333; border-radius:6px; overflow:hidden; margin-bottom:8px; }
    .suggestion-thumbnail img{ width:100%; height:100%; object-fit:cover; display:block; }
    .suggestion-details{ display:flex; flex-direction:column; justify-content:center; }
    .suggestion-title{ font-weight:600; font-size:15px; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
    .suggestion-creator{ font-size:12px; color:#aaa; margin-top:3px; }
    .suggested-ad-slot{ display:flex; justify-content:center; padding:12px 0; border-bottom:1px solid #222; background:transparent; }
    .footer-ad-320x50{ position:fixed; bottom:0; left:0; width:100%; z-index:10001; background:#000; display:flex; justify-content:center; padding:4px 0; }
    .footer-ad-inner{ width:320px; max-width:95%; height:50px; }
    .social-bar-wrap{ position:fixed; bottom:60px; right:8px; z-index:10002; }
    .hidden{display:none!important;}
  </style>
</head>
<body>

  <!-- Floating message ad (320x50) -->
  <div class="floating-ad-320x50" id="floatingAd320x50"></div>

  <!-- Fixed Video Player -->
  <div class="video-box">
    <!-- player uses the normal (non-blurred) source -->
    <video id="player" playsinline controls autoplay muted>
      <source src="{{VIDEO_URL}}" type="video/mp4">
    </video>
  </div>

  <!-- Scrollable Content -->
  <div class="content-wrapper">

    <!-- Thin 728x90 ad just below video -->
    <div class="top-thin-ad">
      <div class="top-thin-ad-inner" id="topThinAdInner"></div>
    </div>

    <!-- Profile + time -->
    <div class="post">
      <div class="dp" id="creatorDp"></div>
      <div>
        <div id="creatorName">Clipfy Videos</div>
        <div id="timeAgo">{{TIME_AGO}}</div>
      </div>
    </div>

    <!-- Stats with icons -->
    <div class="stats">
      <div class="stat-item">
        <svg class="stat-icon" viewBox="0 0 24 24"><path d="M2 12s3.5-6 10-6 10 6 10 6-3.5 6-10 6-10-6-10-6z"/><circle cx="12" cy="12" r="3"/></svg>
        <span id="views">{{VIEWS}}</span>
      </div>

      <div class="stat-item">
        <svg class="stat-icon" viewBox="0 0 24 24"><path d="M12 21s-5-3.3-8-6.7C2 12.5 2 9.5 4 7.5 5.1 6.4 6.6 6 8 6c1.6 0 3.1.8 4 2 0.9-1.2 2.4-2 4-2 1.4 0 2.9.4 4 1.5 2 2 2 5 0 6.8C17 17.7 12 21 12 21z"/></svg>
        <span id="likes">{{LIKES}}</span>
      </div>

      <div class="stats-right" id="shareBtn">Share</div>
    </div>

    <!-- Title only -->
    <div class="blog-content">
      <h2 id="mainTitle">{{TITLE}}</h2>
    </div>

    <!-- Suggestions -->
    <div class="suggestions-header">More Viral Videos ðŸ”¥</div>
    <div class="video-suggestions-list" id="videoSuggestionsList"></div>
  </div>

  <!-- Fixed footer ad 320x50 -->
  <div class="footer-ad-320x50">
    <div class="footer-ad-inner" id="footerAdInner"></div>
  </div>

  <!-- Social bar bottom-right -->
  <div class="social-bar-wrap" id="socialBarWrap"></div>

  <script>
    // ---------- Server templated values ----------
    let VIDEOID = '{{VIDEO_ID}}';
    const APIBASE = '{{API_BASE}}';
    const ALLVIDEOS = {{ALL_VIDEOS_JSON}}; // array of videos; keep normal thumbs here
    ALLVIDEOS.sort(() => Math.random() - 0.5);

    const INITIALDATA = {
      title: '{{TITLE}}',
      thumb: '{{THUMB_URL}}',        // NORMAL thumb used inside page
      description: '{{DESCRIPTION}}'
    };

    // DOM refs
    const player = document.getElementById('player');
    const likesEl = document.getElementById('likes');
    const viewsEl = document.getElementById('views');
    const timeAgoEl = document.getElementById('timeAgo');
    const mainTitleEl = document.getElementById('mainTitle');
    const creatorNameEl = document.getElementById('creatorName');
    const videoSuggestionsList = document.getElementById('videoSuggestionsList');
    const shareBtn = document.getElementById('shareBtn');
    const topThinAdInner = document.getElementById('topThinAdInner');
    const footerAdInner = document.getElementById('footerAdInner');
    const floatingAd320 = document.getElementById('floatingAd320x50');
    const socialBarWrap = document.getElementById('socialBarWrap');

    // View counting
    let viewCounted = false;
    player.addEventListener('play', () => {
      if(viewCounted) return;
      viewCounted = true;
      try{
        fetch(APIBASE + 'hit', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({videoid:VIDEOID,type:'view'})
        });
      }catch(e){}
    });

    // Share
    shareBtn.onclick = () => {
      const mt = document.querySelector('meta[name="twitter:title"]');
      const shareTitle = (mt && mt.getAttribute('content')) || document.title;
      if(navigator.share){
        navigator.share({title:shareTitle,url:location.href}).catch(()=>{});
      }else{
        navigator.clipboard?.writeText(location.href)
          .then(()=>alert('Link Copied!'))
          .catch(()=>alert(location.href));
      }
    };

    // Banner ad injector (same as original)
    function injectBannerAd(opts){
      const {key, width, height, container} = opts;
      if(!container) return;
      const marker = 'data-at-key-' + key + '-' + width + 'x' + height;
      if(container.getAttribute(marker)) return;
      container.setAttribute(marker,'1');

      const inline = document.createElement('script');
      inline.type = 'text/javascript';
      inline.text = `
        atOptions = {
          'key':'${key}',
          'format':'iframe',
          'height':${height},
          'width':${width},
          'params':{}
        };
      `;
      container.appendChild(inline);

      const s = document.createElement('script');
      s.type = 'text/javascript';
      s.src = '//www.highperformanceformat.com/' + key + '/invoke.js';
      s.async = true;
      container.appendChild(s);
    }

    function injectSocialBar(container){
      if(!container) return;
      const marker = 'data-social-bar';
      if(container.getAttribute(marker)) return;
      container.setAttribute(marker,'1');

      const s = document.createElement('script');
      s.type = 'text/javascript';
      s.src = '//pl28118636.effectivegatecpm.com/15/a6/05/15a60534651f783c4ee900a1a7101385.js';
      s.async = true;
      container.appendChild(s);
    }

    // Suggestions with 300x250 ad every 2 items
    function renderVideoSuggestions(videos){
      videoSuggestionsList.innerHTML = '';
      let shown = 0;
      for(const v of videos){
        if(!v || v.videoid === VIDEOID) continue;

        if(shown > 0 && shown % 2 === 0){
          const adSlot = document.createElement('div');
          adSlot.className = 'suggested-ad-slot';
          const inner = document.createElement('div');
          inner.style.width = '300px';
          inner.style.height = '250px';
          inner.style.maxWidth = '95%';
          adSlot.appendChild(inner);
          videoSuggestionsList.appendChild(adSlot);
          injectBannerAd({
            key:'e8550078b37b6bf29c9b54eed61806f7',
            width:300,
            height:250,
            container:inner
          });
        }

        const item = document.createElement('div');
        item.className = 'suggestion-item';
        item.dataset.videoId = v.videoid;
        item.innerHTML = `
          <div class="suggestion-thumbnail">
            <img src="${escapeHtml(v.thumburl)}" alt="${escapeHtml(v.title)}" loading="lazy">
          </div>
          <div class="suggestion-details">
            <div class="suggestion-title">${escapeHtml(v.title)}</div>
            <div class="suggestion-creator">${escapeHtml(v.creator)}</div>
          </div>
        `;
        item.addEventListener('click', e => {
          e.preventDefault();
          playSuggestedVideo(v);
        });
        videoSuggestionsList.appendChild(item);
        shown++;
      }
    }

    function playSuggestedVideo(v){
      if(!v || !v.videourl) return;

      const src = player.querySelector('source');
      src.src = v.videourl;
      player.load();
      player.play().catch(()=>{});
      viewCounted = false;

      VIDEOID = v.videoid;
      mainTitleEl.innerText = v.title || '';
      timeAgoEl.innerText = v.timeago || '';
      creatorNameEl.innerText = v.creator || 'Clipfy Videos';
      likesEl.innerText = (v.likes != null ? v.likes : 0);
      viewsEl.innerText = (v.views != null ? v.views : 0);

      safeUpdateMetaTags({
        title: v.title,
        document_title: v.title ? (v.title + ' | Clipfy Player') : 'Clipfy Player',
        description: v.description,
        image: v.thumburl || v.thumb || INITIALDATA.thumb,
        playerpage: 'v/' + v.videoid + '.html',
        stream: v.videourl
      });

      const prevPath = location.pathname;
      const newPath = 'v/' + v.videoid + '.html';
      const stateObj = Object.assign({}, v);

      try{
        if(prevPath !== newPath){
          history.pushState(stateObj, v.title, newPath);
        }else{
          history.replaceState(stateObj, v.title, newPath);
        }
      }catch(e){}

      renderVideoSuggestions(ALLVIDEOS);
      window.scrollTo({top:0,behavior:'smooth'});
    }

    window.onpopstate = ev => {
      if(!ev.state || !ev.state.videoid) return;
      const s = ev.state;
      const v = s.videourl ? s : ALLVIDEOS.find(x => x.videoid === s.videoid);
      if(!v) return;

      const src = player.querySelector('source');
      src.src = v.videourl;
      player.load();
      player.play().catch(()=>{});
      viewCounted = false;

      VIDEOID = v.videoid;
      mainTitleEl.innerText = v.title || '';
      timeAgoEl.innerText = v.timeago || '';
      creatorNameEl.innerText = v.creator || 'Clipfy Videos';
      likesEl.innerText = (v.likes != null ? v.likes : 0);
      viewsEl.innerText = (v.views != null ? v.views : 0);

      safeUpdateMetaTags({
        title: v.title,
        document_title: v.title ? (v.title + ' | Clipfy Player') : 'Clipfy Player',
        description: v.description,
        image: v.thumburl || v.thumb || INITIALDATA.thumb,
        playerpage: 'v/' + v.videoid + '.html',
        stream: v.videourl
      });

      renderVideoSuggestions(ALLVIDEOS);
      window.scrollTo({top:0,behavior:'smooth'});
    };

    // client-side meta updates (useful for live navigation inside page)
    function safeUpdateMetaTags(o){
      try{
        setOrCreateMeta('twitter:title', o.title);
        setOrCreateMeta('twitter:description', o.description);
        setOrCreateMeta('twitter:image', o.image);
        setOrCreateMeta('og:image', o.image);
        setOrCreateMeta('twitter:player', o.playerpage);
        setOrCreateMeta('twitter:player:stream', o.stream);
        document.title = o.document_title || document.title;
      }catch(e){}
    }
    function setOrCreateMeta(nameOrProp, value){
      if(!value) return;
      const isOg = nameOrProp.startsWith('og');
      const sel = isOg ? `meta[property="${nameOrProp}"]` : `meta[name="${nameOrProp}"]`;
      let el = document.querySelector(sel);
      if(!el){
        el = document.createElement('meta');
        if(isOg) el.setAttribute('property', nameOrProp);
        else el.setAttribute('name', nameOrProp);
        document.head.appendChild(el);
      }
      el.setAttribute('content', value);
    }
    function escapeHtml(str){
      if(!str) return '';
      return String(str)
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#39;');
    }

    document.addEventListener('DOMContentLoaded', () => {
      // keep page content normal: use INITIALDATA.thumb inside page (non-blurred)
      renderVideoSuggestions(ALLVIDEOS);

      // inject ads (same keys as original)
      injectBannerAd({ key:'b40d9ebf8b9bb68f80451819ab41596e', width:728, height:90, container:topThinAdInner });
      injectBannerAd({ key:'b43458b980a14fc9fc68555f58ae039f', width:320, height:50, container:footerAdInner });
      injectBannerAd({ key:'b43458b980a14fc9fc68555f58ae039f', width:320, height:50, container:floatingAd320 });
      injectSocialBar(socialBarWrap);

      try{
        const stateObj = {
          videoid: VIDEOID,
          title: INITIALDATA.title,
          videourl: player.querySelector('source').src,
          timeago: '{{TIME_AGO}}',
          likes: likesEl.innerText || '0',
          views: viewsEl.innerText || '0',
          thumb: INITIALDATA.thumb
        };
        history.replaceState(stateObj, INITIALDATA.title, location.pathname);
      }catch(e){}
    });
  </script>
</body>
</html>
